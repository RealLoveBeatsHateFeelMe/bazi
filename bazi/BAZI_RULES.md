# 八字系统业务规则说明

## §3. 流年/大运与命局的相互作用

### §3.1 冲（branch_clash）

冲是指流年或大运的地支与命局中的地支构成相冲关系。

#### 3.1.1 基础冲力量计算

对于某个被冲地支 `target_branch`，先计算其在命局中的"宫位力量"：

```
base_power_percent = （它出现在年支 / 月支 / 日支 / 时支上的 POSITION_WEIGHTS 之和） × 100%
```

#### 3.1.2 普通冲

普通冲的最终风险值为：

```
risk_percent = base_power_percent
```

#### 3.1.3 墓库冲加成

墓库冲特指辰戌、丑未之间的互冲关系。

对于墓库冲，如果命局中有 N 个相同的目标墓库地支被同一个流年/大运地支冲到（即命局中 N 个不同宫位都含有该墓库地支），则：

```
墓库加成 = 5% × N（百分比）
risk_percent = base_power_percent + 5% × N
```

单事件风险封顶 100（年度总风险不封顶，可>100）。

**举例：**

命局年支为戌、日支为戌，流年地支为辰：
- `base_power_percent` = 20%（年支0.1 + 日支0.1 = 0.2，× 100）
- N = 2（两个宫位都被冲到）
- 墓库加成 = 5% × 2 = 10%
- 最终 `risk_percent` = 20% + 10% = 30%

#### 3.1.4 三合/三会逢冲额外加分

当冲事件发生时，如果冲的两个字中至少有一个属于某个已成立的三合局或三会局，则触发额外加分规则。

**触发条件：**
1. 当年确实发生冲（流年与命局的冲，或运年相冲）
2. 冲的两个字中至少有一个属于某个已成立的三合/三会局

**判定规则：**

Step A：确认当年发生的冲是谁和谁冲（使用现有的冲检测结果）

Step B：检查这次冲是否冲到某个已成立的三合/三会
- 若两个字都不属于任何三合/三会成员 → 规则不触发
- 若至少有一个字属于三合/三会 → 继续

Step C：区分"局内字"和"单独字"，判断单独字是否为用神
- **只有一个字属于三合/三会：**
  - 属于局/会的字 = "局内字"
  - 另一个字 = "单独字"
  - 判断单独字的五行是否在用神五行集合中：
    - 单独字是用神 → 额外 +35%
    - 单独字不是用神 → 额外 +15%
- **两个字都属于三合/三会：**
  - 直接额外 +35%（不需要判断单独字）

**封顶规则：**
- 15% 和 35% 当年只能加一次
- 如果同一年出现多个候选命中，35% 优先于 15%
- 加完后立刻锁死本年这条规则，不再叠加

**计入风险：**
- 三合/三会逢冲额外加分计入 `risk_from_zhi`（因为冲是地支事件）
- 在打印"冲总影响"时，会显示：`动态 X% + 静态 Y% + 三合/三会逢冲 Z% = 总和%`

**打印顺序：**
1. 先打印：谁和谁冲（例如"丑戌冲"、"辰戌冲"、"寅申冲"）
2. 再打印：哪个字属于哪个三合/三会、哪个是单独字
   - 例如："寅午戌三合火局被冲到：冲对中'寅'属于三合；'申'是单独字"
3. 再打印：单独字是不是用神（如果有单独字）
   - 例如："单独字申：是用神" 或 "单独字申：不是用神"
4. 最后打印：本规则本年额外加分是多少（+15 或 +35），并声明本年封顶已用掉
   - 例如："三合/三会逢冲额外：+35%（本年只加一次）"

**举例：**

例A（2005-9-20 10:00 男，2033年）：
- 丑戌冲 15%
- 日柱天克地冲 20%
- 新规则：巳午未三会里的未，冲了巳酉丑三合里的丑，额外 35%（两个字都在局/会里）
- 总计：70%

例B（2007-1-28 12:00 男，2012年）：
- 辰戌冲：基础冲20% + 墓库10%（5%×2个柱） = 30%
- 新规则：寅午戌三合局被冲（辰戌冲），辰不是用神 → 额外 15%
- 核心风险：30% + 15% = 45%

例B（2007-1-28 12:00 男，2016年）：
- 运年天克地冲 20%
- 寅申冲 10%
- 寅申枭神夺食 15%
- 新规则：寅午戌三合冲申，额外 35%（申是用神）
- 总计：80%

#### 3.1.5 其他规则

- 冲事件的 `type = "branch_clash"`，`role = "base"`
- 影响档位判断：
  - `impact_level`: ≤15% → minor, 15–30% → moderate, >30% → major
  - `suggestion_level`: 相应映射为 normal/be_careful/strong_warning

---

### §3.2 刑（punishment）

（刑的规则见其他文档或后续补充）

---

### §3.3 线运（年龄段对应宫位）

线运是指根据当前年龄对应的主要宫位，当基础事件作用在该宫位时，会额外增加风险分。

#### 3.3.1 年龄段与宫位映射

根据当前虚龄，确定线运对应的宫位：

- **0–16 岁**：对应 **年柱**（year）
- **17–32 岁**：对应 **月柱**（month）
- **33–48 岁**：对应 **日柱**（day）
- **49 岁及以上**：对应 **时柱**（hour）

#### 3.3.2 线运加成规则

**重要：线运加成是按年份计算的，每一年最多只加一次 6%，不会按事件数量反复累加。且需要命中 active_pillar 的基础事件 risk_percent >= 10.0 才触发。**

具体规则如下：

1. 根据当前年龄 `age` 确定 `active_pillar`（year/month/day/hour）：
   - 0–16 岁：`active_pillar = "year"`
   - 17–32 岁：`active_pillar = "month"`
   - 33–48 岁：`active_pillar = "day"`
   - 49 岁及以上：`active_pillar = "hour"`

2. 扫描该年所有**基础事件**（`role="base"`，例如冲 branch_clash，未来的枭神夺食、伤官见官等）：
   - 判定触发：存在至少一条 base 事件满足：
     1. 该事件命中 `active_pillar`（即该事件的 `targets` 中有 `pillar == active_pillar`）
     2. 且该事件的 `risk_percent >= 10.0`
   - 只要有一条满足条件的事件就立即触发，不再继续扫描其他事件。

3. 一旦触发线运加成：
   - 本年整体额外增加一次 6% 的风险分：`lineyun_bonus = 6.0`。
   - **全年最多只加一次 6%，不叠加、不分干支。**

4. 年度总风险计算更新为：
   ```
   other_effect = 所有 role != "punisher" 事件的 risk_percent 之和（不包含线运加成）
   punish_total = 所有刑事件贡献之和
   lineyun_bonus = 6.0（如果该年触发线运）否则 0.0
   total_risk_percent = other_effect + punish_total + lineyun_bonus
   ```
   
   **注意：年度总风险不封顶（可>100），只对单事件风险按各自规则封顶（例如冲事件自身封顶100）。**

5. 线运事件记录：
   - 生成一条 `role="lineyun"` 的事件记录，用于解释：
     - `type: "lineyun_bonus"`
     - `risk_percent: 6.0`
     - `active_pillar: "year"/"month"/"day"/"hour"`
     - `trigger_events: [<触发来源事件的简化引用>]`

**举例：**

- 某年虚龄 25 岁（对应月柱），该年有一个基础事件命中月柱且 `risk_percent = 10.0`：
  - 触发线运加成
  - `lineyun_bonus = 6.0`（只加一次）

- 若命中 active_pillar 的基础事件 `risk_percent = 9.9`，则不触发线运加成，`lineyun_bonus = 0.0`

---

## §4. 十神力量与格局提示

### §4.1 五大十神类别（分类规则）

将常见十神合并成 5 个大类：

- **比劫**：比肩、劫财
- **财星**：正财、偏财
- **食伤**：食神、伤官
- **官杀**：正官、七杀
- **印星**：正印、偏印

以后只要出现具体的十神名（正印、偏印、七杀等），都可以映射到这 5 大类之一，用于统计力量占比和格局提示。

### §4.2 五大十神类别的力量占比

在一个八字中，计算上述 5 大类别的"力量占比"（0–100%），方法类似于当前的"五行力量占比"：

1. 遍历四柱八字的 8 个位置（天干 + 地支主气）：
   - 年干、年支、月干、月支、日干、日支、时干、时支；
   - 每个位置都有一个位置权重 POSITION_WEIGHTS：
     - `year_gan` / `year_zhi` / `month_gan` / `month_zhi` / `day_gan` / `day_zhi` / `hour_gan` / `hour_zhi`。

2. 对每个字：
   - 先根据日干（日主）计算该字对应的具体十神（正印、七杀、食神、正财等），用项目里现有的十神算法；
   - 再把这个具体十神映射到 5 大类之一（比劫 / 财星 / 食伤 / 官杀 / 印星）。

3. 将该字所在位置的权重累加到对应类别上：
   - 例如：月干为七杀，位置权重 0.10 → 官杀 +0.10；
   - 月支主气为正官，位置权重 0.35 → 官杀 +0.35；
   - 日干本身也有十神（比肩），日干位置的权重为 `day_gan`，在统计时纳入计算。

4. 遍历完 8 个字后，将各类别的总和归一到 0–100%，得到：

   - 比劫：XX%
   - 财星：XX%
   - 食伤：XX%
   - 官杀：XX%
   - 印星：XX%

并将这组数据在 `analyze_basic` 的返回值中以字段形式返回。

### §4.3 壬癸水日主 + 官杀（土）很重 + 身弱 → 用神加"木"

在日主为壬、癸水时，需要一个特殊调整规则：

**触发条件（必须同时满足）：**

1. **日主为壬水或癸水**：
   - 日干 = "壬" 或 "癸"；
   - 日主五行 = 水。

2. **日主被判定为"身弱"**：
   - 使用当前系统中已有的日主强弱计算（`strength_percent` 0–100%），
   - 这里暂定：`strength_percent < 50` 视为"身弱"（包含偏弱、很弱）。

3. **官杀（土）类别的力量占比 > 40%**：
   - 在 4.2 中计算得到的 `shishen_category_percentages["官杀"]`，
   - 如果该值 > 40，即认为"官杀（土）过重"。

**当以上三个条件都满足时：**

在当前的用神五行列表基础上，额外加入"木"作为用神（如果已经包含木则不重复添加）。

也就是说，这种命局的用神变成（去重后）：

- 原本为水日主身弱时的标准用神（比如金、水），
- 再加上"木"这一项，
- 最终返回给用户的 `yongshen_elements` 至少包含 金、水、木。

### §4.4 用神与运势的关系：好运判断（大运 / 流年）

用神会随着身强身弱、十神结构等调整而变化。

在运势判断上，不需要解释复杂的原因，只要基于"是否走到用神 + 危机程度"做一个简单的"好运 / 非好运"判断。

**约定：**

**对 大运：**

- 大运的"自身五行"取自其天干和地支：`gan_element`、`zhi_element`。
- 如果天干或地支的五行中，至少有一个落在当下的用神列表 `yongshen_elements` 中，
- 并且该步大运的平均风险程度不高（可以使用该大运 10 个流年的 `total_risk_percent` 的**平均值**或**中位数**），
- 若该平均风险 ≤ 15%，则将该步大运整体标记为"好运"；
- 否则，不标记为好运（可以视为"普通 / 一般 / 混合"，在代码里仍用 `is_good=False` 处理）。

**对 流年：**

- 流年的天干、地支对应的五行：`gan_element`、`zhi_element`。
- 只要其中至少一个五行落在用神列表 `yongshen_elements` 中，
- 并且本年计算出来的 `total_risk_percent ≤ 15`，
- 就认为该流年是"好运年"，可标记 `is_good=True`。

不需要对外额外解释"为什么好运"（例如"因为木可以制官杀"），这些原因留在内部逻辑中就好。

可以在数据结构中新增字段，例如：

- 大运：`dayun["total_risk_average"]`（该步大运下所有流年风险平均值）、`dayun["is_good"]`（基于用神 + 风险 ≤15% 的综合判断）
- 流年：`liunian["is_good"]`（基于用神 + 风险 ≤15% 的判断）

CLI 层面只需要展示"好运 / 坏运 / 一般"等简单标签，不必解释具体原理。

### §4.5 天干格局提示：哪类十神在天干上成势

在本命四柱中，仅针对**年干、月干、日干、时干**做一个格局提示。

**规则：**

1. 对四个天干分别计算其具体十神（正印、七杀、比肩等），再映射到 4.1 中的五大类别。

2. 按"类别"分组，统计每一类在天干上出现的次数：
   - 例如：
     - 年干：正印 → 印星
     - 时干：偏印 → 印星
     - → 则印星类在天干中出现 2 次。

3. 对于那些在天干中出现**次数 ≥ 2** 的类别，生成提示信息，包括：
   - 类别名（印星 / 官杀 / 食伤 / 财星 / 比劫）；
   - 具体是哪些柱、什么天干、对应的具体十神。

这些信息放入 `analyze_basic` 的返回结果中，例如：

```python
\"stem_pattern_summary\": [
    {
        \"category\": \"印星\",
        \"members\": [
            {\"pillar\": \"year\", \"gan\": \"甲\", \"shishen\": \"正印\"},
            {\"pillar\": \"hour\", \"gan\": \"乙\", \"shishen\": \"偏印\"},
        ],
    },
    ...
]
```

### §4.6 主要性格（dominant_traits）

在五大十神类别的基础上，为用户给出一个**主要性格 / 气质倾向**的总结字段 `dominant_traits`，并作为 `analyze_basic` 的一部分返回给前端。

#### 4.6.1 统计口径

- **只看原局（natal）**，不看大运 / 流年；
- **排除日干**：`day.gan` 不计入任何统计；
- 计入的位置为：
  - 年干 / 月干 / 时干（3 个天干）；
  - 四柱地支主气（年支 / 月支 / 日支 / 时支，经主气代表天干后计算十神）；
- 权重统一使用 `POSITION_WEIGHTS`：
  - 天干：`year_gan` / `month_gan` / `hour_gan`；
  - 地支：`year_zhi` / `month_zhi` / `day_zhi` / `hour_zhi`。

每个位置的字先换算为**具体十神**（正印、偏印、正财、偏财、正官、七杀、食神、伤官、比肩、劫财），
再映射到五大类之一（印星 / 财星 / 官杀 / 食伤 / 比劫）。

#### 4.6.2 全局占比与子类占比

在上述 7 个位置（3 干 + 4 支）的有效权重中，定义：

- **五大类总占比**：
  - 对每个大类（印星 / 财星 / 官杀 / 食伤 / 比劫），累加所有属于该类的位置权重之和；
  - 用该类权重 / 所有有效权重之和，得到 `total_percent`（0–100%）。
- **子类占比**：
  - 每个大类下再区分**子类**：
    - 印星：正印 / 偏印；
    - 财星：正财 / 偏财；
    - 官杀：正官 / 七杀；
    - 食伤：食神 / 伤官；
    - 比劫：比肩 / 劫财；
  - 子类占比使用同一套权重和分母：
    - 例如：`偏印_percent = 偏印对应所有位置权重之和 / 所有有效权重之和 × 100`。

#### 4.6.3 纯 / 混杂与 stems_visible_count

1. **混杂判定（mix_label）**
   - 对每个大类，统计其下子类中**权重 > 0** 的具体十神种类数：
     - 若同一大类下至少两个子类都有权重（如正官+七杀、正印+偏印），则：
       - `mix_label = "混杂"`；
     - 若只有一个子类有权重（如只有偏印），则：
       - `mix_label = "纯" + 子类名`  
       - 例如："纯偏印"、"纯正财"、"纯七杀"、"纯食神"、"纯比肩" 等。

2. **stems_visible_count（天干透出次数）**
   - 仅统计**年干 / 月干 / 时干**这 3 个天干；
   - 对每个天干位置：
     - 换算具体十神；
     - 若属于上述任何一个子类（如偏印、正财等），则该子类的 `stems_visible_count += 1`；
   - 地支主气只参与权重统计，不计入 `stems_visible_count`。

#### 4.6.4 输出结构（dominant_traits）

`analyze_basic` 在返回中新增字段：

```python
basic["dominant_traits"] = [  # 若无任何有效类别，可为空列表
  {
    "group": "印",           # 五大类之一（印 / 财 / 官杀 / 食伤 / 比劫）
    "total_percent": 30.0,   # 该大类的总占比
    "mix_label": "纯偏印",   # 纯 / 混杂标签（正偏印混杂 / 官杀混杂 / 纯偏财 等）
    "detail": [
      {
        "name": "正印",
        "percent": 0.0,
        "stems_visible_count": 0,
        "breakdown": {
          "stems_percent": 0.0,
          "branches_percent": 0.0,
        },
      },
      {
        "name": "偏印",
        "percent": 30.0,
        "stems_visible_count": 3,
        "breakdown": {
          "stems_percent": 30.0,
          "branches_percent": 0.0,
        },
      },
    ],
  },
  {
    "group": "财",
    "total_percent": 45.0,
    "mix_label": "纯偏财",
    "detail": [
      {
        "name": "正财",
        "percent": 0.0,
        "stems_visible_count": 0,
        "breakdown": {...},
      },
      {
        "name": "偏财",
        "percent": 45.0,
        "stems_visible_count": 2,
        "breakdown": {...},
      },
    ],
  },
  ...
]
```

> 备注：
> - `dominant_traits` 列表按 `total_percent` 降序排序，便于展示；
> - 示例中的数值仅为结构展示，真实数值以代码计算为准。

#### 4.6.5 性格打印格式（CLI输出）

在 `bazi/cli.py` 中，性格输出分为两个部分：

**1. 主要性格**
- 筛选规则：
  - `total_percent >= 35%` → 主要性格
  - 透干次数 >= 2 → 主要性格
  - 透干次数 >= 1 且该大类五行是用神 → 主要性格（额外晋级）
- 每条性格输出两行一组：
  - 第1行：`{大类}（{total_percent:.1f}%）：{子类标签}；{透干柱位列表}透干×{n}；{得月令字段}；{子类百分比摘要}`
  - 第2行：`- {大类}的五行：{element}；{大类}{为/不为}用神`
- 子类标签规则：
  - 财/印/食伤/比劫：取占比更高的子类作为标签
  - 官杀：若两者都>0 → "官杀混杂"，否则写具体子类
- 透干展示：n=0时不打印，n>=1时打印柱位列表（年柱→月柱→时柱）
- 得月令：只按月支本气归类到十神子类，若该子类属于当前大类，则"得月令"
- 子类百分比摘要：
  - 纯（只有一个子类>0）：`纯{子类}{percent:.1f}%`
  - 混（两个子类都>0）：按占比降序显示两个子类的百分比

**2. 其他性格**
- 五大类全量（含 0%）
- 当 `total_percent == 0` 时：
  - 子类标签显示：`八字中没有{大类}星`
  - 五行通过十神定义计算（即使原局没有该星）

#### 4.6.6 六亲助力（liuqin_zhuli）

#### 4.6.7 天干五合争合/双合婚恋提醒（marriage_wuhe_hints）

**功能概述：**

基于天干五合（甲己合、乙庚合、丙辛合、丁壬合、戊癸合）检测婚恋关系中的争合和三角恋情况，提供婚恋变化提醒。

**天干五合固定集合：**

- 丁壬合
- 乙庚合
- 甲己合
- 戊癸合
- 丙辛合

**配偶星X与争合字Y的映射规则：**

根据日主五行和性别，确定配偶星X和争合字Y（同五行一端）：

**女命（X = 官杀：克日主）：**
- 日主木（甲/乙）：X=庚，Y=乙（乙庚合）
- 日主火（丙/丁）：X=壬，Y=丁（丁壬合）
- 日主土（戊/己）：X=甲，Y=己（甲己合）
- 日主金（庚/辛）：X=丙，Y=辛（丙辛合）
- 日主水（壬/癸）：X=戊，Y=癸（戊癸合）

**男命（X = 财：被日主克）：**
- 日主木（甲/乙）：X=己，Y=甲（甲己合）
- 日主火（丙/丁）：X=辛，Y=丙（丙辛合）
- 日主土（戊/己）：X=癸，Y=戊（戊癸合）
- 日主金（庚/辛）：X=乙，Y=庚（乙庚合）
- 日主水（壬/癸）：X=丁，Y=壬（丁壬合）

**三层检测范围：**

1. **原局层**：只看原局四柱天干（4个），不需要引动
2. **大运层**：原局四柱天干 + 当前大运天干，必须大运天干是X或Y才触发
3. **流年层**：原局四柱天干 + 当前大运天干 + 当前流年天干，必须流年天干是X或Y才触发（避免重复打印大运层已打印的提醒）

**提醒类型：**

**A) 他人争合（别人抢配偶星）：**

触发条件（在该层天干集合中）：
- 出现X（女：官杀；男：财）
- 出现Y（X的五合对象，且是日主同五行一端）
- 参与这次五合的X与Y都不是"日干那一颗"
- 如果Y恰好等于日干字（如女丁日主Y=丁），则必须有"另一颗Y"参与（即Y的实例不是日干那柱的Y）

打印文案：
- 女命：`婚恋变化提醒（如恋爱）：天干官杀星被争合，{合名}合走官杀星，注意，防止感情竞争/第三者介入`
- 男命：`婚恋变化提醒（如恋爱）：天干财星被争合，{合名}合走财星，注意，防止感情竞争/第三者介入`

**B) 命主双合（命主自己脚踏两只船/三角恋 - 分支B1）：**

触发条件（在该层天干集合中）：
- 日干本字 = Y（即日干就是那一端能与X五合的字）
- 并且集合里出现两个X（同一种X出现≥2次，可跨原局/大运/流年凑齐）

打印文案：
- 女命：`婚恋变化提醒（如恋爱）：命主合两个官杀星，{合名}，注意，防止陷入三角恋`
- 男命：`婚恋变化提醒（如恋爱）：命主合两个财星，{合名}，注意，防止陷入三角恋`

**B2) 命主三角恋（分支B2）：**

触发条件（在该层天干集合中）：
- 日干本字 = Y（命主本身就是五合的一端）
- 出现X（能与日干Y构成五合的那一字）
- 同时还存在另一个配偶星Z（同类但不是X，且不要求能五合）
  - 女命：Z为另一颗官杀（比如乙日主，官杀=庚辛；若X=庚，则Z=辛）
  - 男命：Z为另一颗财星（比如庚日主，财=甲乙；若X=乙，则Z=甲）

打印文案：
- 女命：`婚恋变化提醒（如恋爱）：命主合两个官杀星，{合名}，注意，防止陷入三角恋`
- 男命：`婚恋变化提醒（如恋爱）：命主合两个财星，{合名}，注意，防止陷入三角恋`

**打印位置要求：**

1. **原局层命中**：打印在"婚恋结构提示"区域（和"正偏财混杂/官杀混杂"同一块）
   - 文案前缀用：`婚恋结构提示：...`
   - 如果同一个命盘原局里同时出现多条提示（比如既有混杂又有争合/双合），分两行/多行打印；第一行带`婚恋结构提示：`，后续行按缩进对齐

2. **大运层命中**：打印在对应大运批注的最下面，每命中一条就打一行；若A与B同时命中，两行都打

3. **流年层命中**：打印在对应流年批注的最下面（在"总危险系数"之前），每命中一条就打一行；若A与B同时命中，两行都打

**分层打印隔离规则：**

- 原局命中的提醒只打印在原局（"婚恋结构提示"那一块）
- 大运命中的提醒只打印在大运批注最下面
- 流年命中的提醒只打印在流年批注最下面
- 不要出现"原局有提醒 → 所有年份都打印"或"大运包含 → 所有流年都打印"的串层行为
- 流年层只检查流年天干是否引动（避免重复打印大运层已打印的提醒）

**举例：**

例1（女命乙日主，原局天干有辛；当原局/大运/流年天干集合里出现庚时）：
- 乙庚合成立，同时辛也在
- 触发分支B2：命主三角恋
- 打印：`婚恋变化提醒（如恋爱）：命主合两个官杀星，乙庚合，注意，防止陷入三角恋`

例2（同一年同时命中两条提醒）：
- 如果某年同时满足"他人争合"和"命主三角恋"的条件
- 则打印两行提醒，顺序建议先"被争合"再"三角恋"


---

## §5. 信息层增强：十神模式与静态冲刑识别

### §5.1 四柱宫位名称（统一说明）

在规则文档里明确写清四柱对应的"宫位"：

- **年柱** → 根基宫（家庭出身、早年环境）
- **月柱** → 婚姻宫
- **日柱** → **夫妻宫**（特别强调这一点）
- **时柱** → 事业家庭宫（工作 / 子女 / 后期家庭）

以后凡是在"冲 / 刑 / 模式提示"里出现"宫位"，都按这套映射来说明。

### §5.2 十神模式：枭神夺食 & 伤官见官（按配对计分）

先只引入两个模式：

1. **伤官见官**
   - 一端是「伤官」；
   - 一端是「正官」。

2. **枭神夺食**
   - 一端是「偏印（枭神）」；
   - 一端是「食神」。

**关键修正：必须是"明确的两点一线配对"，不能只是"同一堆里面有两个十神就算模式"。**

#### 5.2.1 配对规则（只干对干，只支对支）

1. **所有模式判断只在同一排里面配对**：

   - **天干只能和天干发生关系**  
     - 例：流年天干为伤官，大运天干为正官 → 这一对记作"伤官见官（天干层）"；
     - "流年天干伤官 + 命局地支正官"这种组合**不算**一对。

   - **地支只能和地支发生关系**（用地支主气对应的十神）  
     - 例：流年地支主气为食神，命局月支主气为偏印 → 这一对记作"枭神夺食（地支层）"；
     - "流年地支偏印 + 命局天干食神"这种组合**不算**一对。

2. **"一对"的定义**：

   - 一对 = 两个位置（position）：
     - pos1 = (source, pillar, kind, char, shishen)
     - pos2 = (source, pillar, kind, char, shishen)
   - 要求：
     - `kind` 必须相同（要么都是 "gan"，要么都是 "zhi"）；
     - `shishen` 组合满足其中一种：
       - 伤官见官：{pos1.shishen, pos2.shishen} = {"伤官", "正官"}
       - 枭神夺食：{pos1.shishen, pos2.shishen} = {"偏印", "食神"}

3. **不允许的情况**：
   - 不允许"天干 + 地支"混合起来凑一对模式；
   - 不允许只是"集合里同时存在伤官和正官"就算一个模式，必须明确是哪两个位置配对。

### §5.3 模式出现的三个层级：命局 / 大运 / 流年

对每一种模式（伤官见官、枭神夺食），分三个层级进行识别：

1. **命局层（静态）**

   - 范围：本命四柱的：
     - 四个天干；
     - 四个地支主气；
   - 只在干↔干、支↔支之间找配对，一旦发现一对：
     - 记录一条"原局模式"；
     - 保存参与这对的两个位置（pillar / kind / char / shishen）。
   - 命局层的模式**只用于展示，不直接加当年风险**。

2. **大运层（静态）**

   - 范围：本命四柱 + 当前大运：
     - 干排：命局四个天干 + 当前大运天干；
     - 支排：命局四个地支主气 + 当前大运地支主气。
   - 只在"天干这一排"内部、以及"地支这一排"内部配对：
     - 满足伤官+正官 或 偏印+食神的两两组合；
   - 至少有一个位置来自「大运本身」（source="dayun"），才算这一步大运带来的模式；
   - 大运层模式**用于展示本步大运的格局背景，不单独计入某一年的风险**。

3. **流年层（动态 + 计分）**

   - 范围：命局 + 当前大运 + 当前流年：
     - 干排：命局天干 + 大运天干 + 流年天干；
     - 支排：命局地支主气 + 大运地支主气 + 流年地支主气。
   - 只建立"包含流年位置"的配对：
     - 对每个"流年天干"位置，和所有其它天干位置配对；
     - 对每个"流年地支主气"位置，和所有其它地支主气位置配对；
     - 若两者 shishen 组合满足：
       - {"伤官", "正官"} → 一对伤官见官；
       - {"偏印", "食神"} → 一对枭神夺食；
     - 则这一对视为"本年被触发的一次模式"。
   - 流年层是**唯一真正计入该年 risk 的地方**：
     - 命局 / 大运只提供可以参与配对的静态点；
     - 只要配对里包含流年这一端，才为当年增加风险。

**总结：**  
> 只有"流年参与的配对"才加风险；  
> 命局 / 大运里即使有枭神夺食 / 伤官见官，如果流年没有参与的那一对，就只是静态信息。

### §5.4 枭神夺食 / 伤官见官：每一对的风险加成

当我们在**流年层**找到一对有效的"伤官见官 / 枭神夺食"时，这一对会给当年风险系数增加一个固定的百分比。

规则如下：

1. **默认规则：一对 = +15% 风险**

   - 不区分是"天干这排的配对"还是"地支这排的配对"；
   - 也不区分是枭神夺食还是伤官见官；
   - 只要有一对有效的模式，就按 15% 加一次。

2. **唯一例外：涉及"命局月支"的一对 = +25%**

   - 如果这一对当中，有一个位置是**命局的月支**（pillar="month", kind="zhi", source="natal"），  
     则这一对的风险加成改为**+25%**；
   - 其他所有位置（年支、日支、时支、大运支、流年支等）一律还是按 15% 算。

3. **同一个流年可能出现多对，风险可以叠加**

   - 比如：
     - 流年天干（伤官）和大运天干（正官）是一对 → +15%；
     - 同一个流年天干（伤官）又和命局月干（正官）是一对 → 再 +15%；
     - 流年地支（食神）和命局月支（偏印）又是一对 → 再 +25%。
   - 则该年模式总加成 = 15 + 15 + 25 = 55%（年度总风险不封顶，可>100）。

4. **静态层（命局 / 大运）不单独加分**

   - 即使命局单独就有枭神夺食 / 伤官见官，大运也单独有；
   - 若这一年流年没有参与任何一对模式配对 → 本年**不因为这些模式增加风险**；
   - 只是在命局部分、大运部分提示"这里存在这种格局"。

### §5.5 冲 / 刑 的静态标注规则

除了流年层面之前已有的冲 / 刑以外，现在要在"命局"和"大运"层面也标注出来：

1. **命局内部的冲 / 刑**
   - 范围：四柱地支之间的两两组合；
   - 冲：六冲（子午、丑未、寅申、卯酉、辰戌、巳亥）；
   - 刑：子卯、寅巳、巳申、申寅、辰戌、丑未。
   - **重要：辰未不属于刑**（以 `punishment.py` 的 `ALL_PUNISH_PAIRS` 表为准）。
   - 输出说明：标注哪两柱、哪两个字在冲 / 刑、对应的宫位名称。
   - **特别规则**：
     - 如果同一对地支"既是冲，又是刑"（例如辰戌这类），在输出中只记**冲**，不再额外输出"刑"；
     - 输出中不需要出现"墓库刑"四个字，只统一叫"刑"，或者直接不提这一对的"刑"。

2. **大运 + 命局之间的冲 / 刑**
   - 范围：每一步大运的地支，和四柱地支之间的组合；
   - 用同样的冲 / 刑规则识别；
   - 如果同一对既冲又刑，只输出冲，不输出刑，不提"墓库刑"。

3. **流年层面既有冲又有刑时的统一规则**
   - 对于同一对地支，如果判断出既有冲、又有刑，**以冲为准**：
     - 只保留"冲"的事件记录和输出；
     - 对应的"刑"事件可以不生成，或者生成后在汇总展示时过滤掉；
     - 同样不再额外打"墓库刑"标签。

**统一规则：**
- 同一对地支如果既符合"冲"又符合"刑"，输出时只按"冲"来算，不再额外记一条"刑"。
- 输出层面不再单独说"墓库刑"这四个字。

---

## §6. 流年天干/地支风险拆分与上半年/下半年运势判断

### §6.1 总原则：天干算天干的，地支算地支的

从本次改动开始，对于每一年的风险，我们要把**流年天干**和**流年地支**的贡献拆开计算：

- `risk_from_gan`：  
  只统计**因为"流年天干"参与**才产生的风险。
- `risk_from_zhi`：  
  只统计**因为"流年地支"参与**才产生的风险。

`total_risk_percent` 仍然保留用来综合显示（= risk_from_gan + risk_from_zhi + 其它），  
但"上半年/下半年 是 好运/一般/坏运"的判断**全部只看自己那一半**：

- 上半年运势：只看 `risk_from_gan` + 天干是不是用神；
- 下半年运势：只看 `risk_from_zhi` + 地支是不是用神。

其它来源（比如线运加成），也要按"由哪个侧触发"分别加到 gan 或 zhi 对应的 risk 中。

### §6.2 「冲 + 枭神夺食 / 伤官见官」的最终规则

1. **模式仍按之前规则检测：**

   - 只在同一排配对：
     - 天干 ↔ 天干；
     - 地支（主气） ↔ 地支（主气）。
   - 不能"干 + 支"混配。
   - 两种模式：
     - 伤官见官：一端「伤官」，一端「正官」；
     - 枭神夺食：一端「偏印」，一端「食神」。

2. **流年层面的模式计分（不与冲重合的那些）：**

   - 对所有"包含流年端"的配对：
     - 默认这一对模式加**15%**风险；
     - 如果这一对中包含「命局月支」（pillar="month", kind="zhi"），这一对改为**25%**；
   - 这些模式被算进：
     - 如果是流年天干配的 → 加到 `risk_from_gan`；
     - 如果是流年地支配的 → 加到 `risk_from_zhi`。

3. **关键特殊情况：同一对既是冲，又是模式**

   - 对某一对地支（例如卯酉）：
     - 它们首先按既有的规则算出「冲」的风险 `clash_risk_old`：
       - 基础冲；
       - 墓库冲加成；
       - 线运加成等。
     - 如果这对地支在十神上又满足：
       - 偏印 + 食神（枭神夺食），或
       - 伤官 + 正官（伤官见官），
     - 那么：  
       **不再为这对地支单独生成模式事件（不再 +15/25%），  
       而是在这条"冲"的 risk 上额外 +10%。**

     即：  
     `clash_risk_new = clash_risk_old + 10.0`

   - 这 +10% 属于**流年地支引起的风险**，计入 `risk_from_zhi`。

4. **展示要求（必须打印）**

   所有对 `total_risk_percent` 有贡献的东西，都要在 CLI 中打印出来。

   对于"既冲又是模式"的一对，展示建议如下：

   - 在"冲"部分打印：
     - `卯酉冲：基础冲 10.00%（+墓库加成 X%，+线运加成 Y%）`
   - 紧接着打印一行说明：
     - `同一对为枭神夺食，额外加成：+10.00%`
   - 这样用户一眼能看出：  
     - 有冲；  
     - 又是枭神夺食/伤官见官；  
     - 所以这条冲的风险被从 10% 提高到 20%。

### §6.3 流年天干（上半年）的「好运 / 一般 / 坏运」

#### 6.3.1 首先确定两个量

对某一年，关于**流年天干**，我们只关心：

1. **是不是用神**  
   - 用现有逻辑看流年天干五行是否属于当年用神五行集合 `yongshen_elements`。

2. **流年天干自己引起的风险 `risk_from_gan`**  
   只包含下列来源：

   - 流年天干参与的**枭神夺食 / 伤官见官（天干一排）**：
     - 按 15%/25% 记入；
   - 流年天干触发的**忌神**相关负面（后续会继续细化）；  
   - 任何其它"明确由流年天干作为触发端"的风险事件。  
   - **不包括** 地支引起的冲、刑、地支模式等。

#### 6.3.2 天干是用神时

如果流年天干五行 ∈ 用神五行集合：

- `risk_from_gan ≤ 15%`  
  → 上半年：**好运**

- `15% < risk_from_gan ≤ 30%`  
  → 上半年：**好坏都有**  
  （用神，但动得比较厉害）

- `risk_from_gan > 30%`  
  → 上半年：**坏运**  
  （虽然是用神，但天干这边变化过大、麻烦过多）

#### 6.3.3 天干不是用神时

如果流年天干五行 ∉ 用神五行集合：

- `risk_from_gan ≤ 15%`  
  → 上半年：**一般**  
  （非用神，但没惹出明显大事）

- `15% < risk_from_gan ≤ 30%`  
  → 上半年：**一般（有变动）**  
  （非用神，但引起了一些事件、变化）

- `risk_from_gan > 30%`  
  → 上半年：**坏运**  
  —— 这类通常就是：
  - 流年天干不是用神，
  - 又主动引动了枭神夺食、伤官见官，或者忌神特别强。

**注意：**  
坏运的判断**不再用 total_risk_percent**，而是只看 `risk_from_gan` 和"天干是不是用神"。

### §6.4 流年地支（下半年）的「好运 / 一般 / 坏运」

#### 6.4.1 流年地支自己的风险 `risk_from_zhi`

只统计**因为流年地支参与**而产生的风险，包括：

1. **冲**（以流年地支为一端的所有冲）：
   - 基础冲；
   - 墓库冲加成；
   - 线运加成（线运命中时 +6%）；
   - 如果这同一对又是枭神夺食 / 伤官见官 → 在这条冲基础上额外 +10%。

2. **刑**（以流年地支为一端的所有刑）：
   - 风险计算沿用现在的刑规则：
     - 普通刑：按"宫位力量"的 50%；
     - 月柱作为目标时：固定 10%；  
   - 这部分 risk 全部记入 `risk_from_zhi`。

3. **地支层面的枭神夺食 / 伤官见官**：
   - 流年地支 + 命局 / 大运地支的配对；
   - 只要不是与"冲"同一对重叠，就按 15%/25% 单独加在 `risk_from_zhi`。

#### 6.4.2 地支是用神时

如果流年地支五行 ∈ 用神五行集合：

- `risk_from_zhi ≤ 15%`  
  → 下半年：**好运**  
  （用神，冲刑等影响较轻）

- `15% < risk_from_zhi ≤ 30%`  
  → 下半年：**好坏都有**  
  （用神，但有明显变动——例如：线运内冲 10%+6%=16%，就落在这一档）

- `risk_from_zhi > 30%`  
  → 下半年：**坏运**  
  （用神但下半年动得太猛，风险远大于收益）

#### 6.4.3 地支不是用神时

如果流年地支五行 ∉ 用神五行集合：

- `risk_from_zhi ≤ 15%`  
  → 下半年：**一般**

- `15% < risk_from_zhi ≤ 30%`  
  → 下半年：**一般（有变动）**  
  （非用神且冲刑比较明显）

- `risk_from_zhi > 30%`  
  → 下半年：**坏运**  
  —— 这条和原话完全一致：  
  > "地支坏运是当流年地支引起的危险系数超过30%。  
  > 如果地支只引起15%以上，则按一般运。"

### §6.5 年度整体标签（年运：好运 / 一般 / 坏运）

对于每年，我们最终要有三个层次：

- 上半年状态：`first_half_label`（基于天干）
- 下半年状态：`second_half_label`（基于地支）
- 年度整体标签：`year_label`

年度整体标签规则：

1. 如果 `first_half_label == "好运"` 且 `second_half_label == "好运"`  
   → `year_label = "好运"`

2. 如果 `first_half_label == "坏运"` 且 `second_half_label == "坏运"`  
   → `year_label = "坏运"`

3. 其他所有组合（例如 好运+一般、好运+坏运、一般+坏运、一般+一般、好坏都有+一般 等）  
   → `year_label = "一般/混合"`（具体用词可以定为"普通/混合"，但保持统一）。

**注意：**  
原来可能存在的"直接按 total_risk_percent 切三档"的逻辑请移除，  
年度运势只通过「上半年+下半年」来组合判断。

`total_risk_percent` 仍然可以保留显示和用于之前的**suggestion_level（normal / be_careful / strong_warning）**，  
但这套半年度逻辑不依赖它。

### §6.6 CLI 输出要求：所有影响 total risk 的因素都要打印出来

在 `bazi/cli.py` 里，打印每一年流年时，需要确保：

1. **列出所有有风险贡献的事件：**

   - 冲（含基础冲、墓库加成、线运加成）；
   - 刑（以及这条刑对应的风险加成）；
   - 枭神夺食 / 伤官见官（不与冲重叠的那些单独模式）；
   - 冲+模式 同时出现时的"额外 +10%"必须单独指出；
   - 天克地冲（在冲的基础上额外 +10%）必须单独指出；
   - 线运加成（+6%）也应该有一行说明（例如"线运命中：+6.00%"）。

2. 每一类事件都要带上：

   - 哪两个字：例如"卯酉冲"、"子卯刑"；
   - 对应哪两个宫位：根基宫 / 婚姻宫 / 夫妻宫 / 事业家庭宫；
   - 对 total_risk 的数值加成：例如"墓库加成：+5.00%"、"刑加成：+5.00%"。

3. 对于"既冲又刑"的同一对地支：

   - 仍然沿用原先规则：**只视为冲**；
   - 不再单独打印"刑"的那一条，同时也不再为这对刑叠加风险。

4. 对于"既冲又是枭神夺食/伤官见官"的同一对：

   - 冲的风险照算；
   - 单独打印一行：
     - "该冲同时为枭神夺食/伤官见官，额外+10.00%"；
   - 不再为这对模式单独记 15/25%。

5. **流年输出中不显示年度整体标签**：

   - 删除「年度整体：XXX」这段文案，不再显示年度标签；
   - 只保留 "年份 + 干支 + 虚龄 + 总风险 + 上半年/下半年标签" 的信息。

---

## §7. 天克地冲逻辑（冲基础上 +10%）

### §7.1 定义

天克地冲 = 两个柱的地支互冲 + 两个柱的天干五行互相克，  
在原有"冲"的风险基础上，额外增加 +10% 风险，并在输出中标注出来"天克地冲"。

### §7.2 五行克制关系（用于天干互克）

使用传统五行克：

- 木克土
- 土克水
- 水克火
- 火克金
- 金克木

给定两个天干 gan1、gan2：

- e1 = GAN_WUXING[gan1]
- e2 = GAN_WUXING[gan2]

判定这两个天干"互克"的条件：

- KE_MAP[e1] == e2  或  KE_MAP[e2] == e1

只要单向成立（A 克 B 或 B 克 A），就认为"天干互相克"成立，不要求双向。

### §7.3 地支互冲条件

仍然用现有 `clash.py` 的冲规则（子午、丑未、寅申、卯酉、辰戌、巳亥等）。  
天克地冲只在**已经被认定为"冲"的那一对地支**上额外判定，不改变原有冲判定逻辑和冲的力量计算。

### §7.4 哪些组合需要检查天克地冲

需要检查的柱与柱组合：

1. **流年柱 vs 命局四柱**
2. **流年柱 vs 当前大运柱**
3. **大运柱 vs 命局四柱**（用于大运风险计算）

在已有"冲事件"基础上扩展：

- 每当你生成一条 clash 事件时，事件里已经包括：
  - 两个柱：source / pillar / gan / zhi / 宫位；
  - 冲的风险计算（基础冲 + 墓库加成 + 线运加成等）；
- 在这条 clash 事件上额外调用一个"天克地冲检查函数"：
  - 输入：两柱的 gan、zhi、source、pillar；
  - 条件：这对 zhi 互冲 + 天干五行互克；
  - 如果满足 → 标记为"天克地冲"，在冲的风险上额外 +10%。

### §7.5 风险数值：在冲的基础上额外 +10%

对一条已经算完 risk 的冲事件，假设原先是：

- `clash_risk_old`  = 基础冲风险  
  + 墓库加成  
  + 线运加成  
  + （如果同一对又是枭神夺食 / 伤官见官，则已经在冲上加了那 **额外 +10%**）

在满足"天克地冲"的情况下，再加一层：

- `clash_risk_new = clash_risk_old + 10.0`

这多出来的 10%：

- 属于**这一对冲事件本身的风险**；
- 如果是流年地支参与的冲，则计入：
  - `risk_from_zhi += 10.0`（对那一年的下半年风险有效）；
- 如果是大运地支参与的冲，则计入：
  - `risk_dayun_zhi += 10.0`（对这一步大运的风险有效）；

注意：

- 不改变 "地支力量百分比" 的算法，只增加风险；
- 与"冲 + 枭神夺食/伤官见官"的 +10% 可叠加：
  - 同一对地支：  
    - 既是冲；  
    - 又是枭神夺食/伤官见官（所以在冲上 +10%）；  
    - 又构成天克地冲（再 +10%）；  
  - 最终这条冲事件可能总共额外多出 20% 风险。

### §7.6 标记"哪个柱被天克地冲"

生成天克地冲时，需要记录"谁是被冲的柱"，以便 CLI 输出：

1. 如果是 「流年柱 vs 命局某柱」：
   - victim_source = "natal"
   - victim_pillar = 对应的 "year"/"month"/"day"/"hour"
   - 输出示例：
     - `天克地冲：命局 夫妻宫（日柱）被流年 壬辰 天克地冲，额外 +10.00%`

2. 如果是 「流年柱 vs 大运柱」：
   - victim_source = "dayun"
   - victim_pillar = "dayun"
   - 输出示例：
     - `天克地冲：本步大运 壬寅 被流年 壬辰 天克地冲，额外 +10.00%`

3. 如果是 「大运柱 vs 命局某柱」：
   - victim_source = "natal"
   - victim_pillar = 对应的 "year"/"month"/"day"/"hour"
   - 输出示例：
     - `天克地冲：命局 夫妻宫（日柱）被本步大运 壬寅 天克地冲，额外 +10.00%`

---

## §8. 大运好坏判定逻辑（重地支，用同一危险系数标准）

### §8.1 总原则

本次重点是重新定义**每一步大运是"好运 / 一般 / 坏运"**的规则，不再使用"十年平均风险"一类的逻辑。

原则：

- 大运也用和流年一样的危险系数标准（0–15、15–30、30+）；
- **大运重地支**：判断好坏时，大运地支是核心；
- 在地支是用神且风险不高时，大运判为好运；
- 如果大运干支都是用神，还要特别标注"非常好运"。

### §8.2 大运危险系数的计算（risk_dayun_percent）

为每一条大运定义：

- `risk_dayun_zhi`：  
  由"大运地支参与的各种事件"产生的风险总和；
- `risk_dayun_gan`：  
  由"大运天干参与的各种事件"产生的风险总和；
- `risk_dayun_total = risk_dayun_zhi + risk_dayun_gan`。

这里的大运事件，主要是**大运柱 vs 命局四柱**的结构性关系（不包含具体某个流年的流年柱）：

- 大运地支 vs 命局地支：
  - 冲（含墓库冲加成、天克地冲额外 +10 等）；
  - 刑（按之前的刑规则）；
  - 枭神夺食 / 伤官见官（支排模式）；
- 大运天干 vs 命局天干：
  - 枭神夺食 / 伤官见官（干排模式）；
  - 若满足天克地冲（天干克+支冲），并加 10%。

注意：

- **大运 vs 流年**之间发生的冲、刑、天克地冲，是在具体流年里算的风险，不计入大运长期风险；
- 大运风险更像是"这十年本身格局对命局的长期压力"。

### §8.3 大运是否为用神

对于每一条大运：

- 根据 dayun_gan、dayun_zhi 的五行，结合用神五行集合 `yongshen_elements`，判断：
  - `is_dayun_zhi_yongshen`：大运地支五行 ∈ 用神；
  - `is_dayun_gan_yongshen`：大运天干五行 ∈ 用神。

### §8.4 大运好坏判定逻辑

使用和流年相同的阈值（0–15、15–30、30+），但规则改为：

#### 8.4.1 地支是用神的大运（重点）

如果 `is_dayun_zhi_yongshen == True`：

- 若 `risk_dayun_total < 30%`：  
  → 这一条大运整体判定为：**"好运"**（不再看平均十年，只看这一步大运自身结构的风险）。

- 若 `risk_dayun_total ≥ 30%`：  
  → 这一条大运整体判定为：**"坏运"** 或 "用神过激的大运"；  
    具体标签可以用 "坏运（用神过旺/变动过大）"。

额外标记：

- 如果同时 `is_dayun_zhi_yongshen == True` 且 `is_dayun_gan_yongshen == True`，并且 `risk_dayun_total < 30%`：
  → 在这条大运上额外打一个标记，比如文案中加一句：
  - "干支皆用神：非常好运的大运"。

#### 8.4.2 地支不是用神的大运

如果 `is_dayun_zhi_yongshen == False`：

- 若 `risk_dayun_total ≤ 15%`：  
  → 大运标签：**"一般"**（非用神，但风险不大）

- 若 `15% < risk_dayun_total ≤ 30%`：  
  → 大运标签：**"一般（有变动）"**  
  （非用神，同时结构性冲刑/模式比较多）

- 若 `risk_dayun_total > 30%`：  
  → 大运标签：**"坏运"**

总之：

- **大运好坏不再用"流年平均风险"来算，只用自身 dayun_total 风险 + 用神情况来判。**

### §8.5 大运输出中需要打印的内容

在 `cli.py` 打印每一条大运时，请调整格式为类似：

```
【大运 2】 壬寅（起运年份 2009，虚龄 3 岁） → 好运  [大运危险：24.00%]
  （若干支皆用神，则再加一句：干支皆用神：非常好运的大运）
```

并在该大运下面打印该步大运参与的所有结构性事件（只看 dayun vs natal）：

1. **冲事件（大运支 ↔ 命局支）**
   - 冲：寅申冲（婚姻宫 ↔ 某宫位）
   - 基础冲：10.00%
   - 墓库加成：+5.00%（若有）
   - 若同一对又是枭神夺食/伤官见官：冲上再 +10.00%（保持现有逻辑）
   - 若这对又满足天克地冲：再 +10.00%
   - 最后这条冲对大运危险的贡献：XX.00%

2. **刑事件（大运支 ↔ 命局支）**
   - 刑：寅巳刑（某宫 ↔ 某宫）
   - 基础力量：XX.00%
   - 风险贡献：YY.00%（按之前刑的算法）

3. **枭神夺食 / 伤官见官（大运干/支 ↔ 命局干/支）**
   - 一对一列出：  
     - 例如：大运天干壬（偏印） + 命局时干丙（食神） → 枭神夺食，+15.00%  
     - 或涉及月支则 +25.00%

4. **天克地冲（大运 ↔ 命局）**
   - 例如：
     - `天克地冲：命局 夫妻宫（日柱）被本步大运 壬寅 天克地冲，额外 +10.00%`

所有这些事件的 risk 都要计入 `risk_dayun_zhi` / `risk_dayun_gan`，从而影响 `risk_dayun_total`，并最终决定这一步大运被标为"好运 / 一般 / 坏运"，以及是否加上"非常好运"的标签。

---

## §10. 刑（punishment）的新规则

### §10.1 只保留两种强度：普通刑 5%，墓库刑 6%

从现在起，所有"刑"的危险系数不再按宫位力量比例来算，统一改成固定值：

- **普通刑**：  
  - 任意非"墓库之间"的刑（比如寅巳刑、子卯刑等）  
  - `risk_percent = 5.0`（百分比）

- **墓库刑**：  
  - 刑的双方都是 **辰、戌、丑、未** 中的任意两个，但**不包括辰未组合**（辰未不刑）；  
  - 具体组合：辰戌、丑未（以 `punishment.py` 的 `GRAVE_PUNISH_PAIRS` 表为准）；  
  - `risk_percent = 6.0`

以后不再出现 "按 base_power_percent * 0.5" / "月柱刑按 10%" 等逻辑。  
刑的危险强度完全由"是否墓库刑"来决定，不看宫位力量。

### §10.2 base_power_percent 仍然可以保留但只用来展示

- 可以继续计算被刑宫位的 `base_power_percent`（这个数字对分析有用），  
- 但**不参与刑的 `risk_percent` 计算**，只在输出里展示。

### §10.3 与冲的关系

保持之前定的规则不变：

如果同一对地支同时满足"冲"和"刑"，  
→ 只按冲来算，不再单独生成刑事件（避免重复计分）。

也就是说，刑事件只在"纯刑、不同时又是冲"的组合上出现。

---

## §11. 线运加成调整：每年每根线运柱只加一次 +6%

### §11.1 线运定义保持不变

线运仍然按照命局 4 根地支来划分年龄段：

- 年柱地支：0–16 岁
- 月柱地支：17–32 岁
- 日柱地支：33–48 岁
- 时柱地支：49 岁以后

线运只对命局四支生效（year/month/day/hour 的地支），大运和流年自己的地支不算线运柱。

### §11.2 新规则：每年每柱最多只加一次 +6%

本命线运加成从现在起改为：

对于某一年，当某个命局地支所在的年龄段被触发时，不管这根柱上发生了多少事件（冲、刑、枭神夺食、伤官见官、天克地冲等），整个年份里这根柱只获得一次 +6% 的线运加成。

举例：

某年年龄在 20 岁：
- 对应线运柱 = 命局月支。
- 如果这一年，月支发生：
  - 被流年冲一次；
  - 又被大运冲一次；
  - 又有一组枭神夺食；

新规则：  
→ 不管发生几次，只要"月支这一柱有至少一个事件"，  
就给这根柱加一次 +6%，只记一次。

### §11.3 天干侧和地支侧分开计算

- 天干侧的事件（天干层模式）命中线运柱 → 天干侧线运加成 +6%
- 地支侧的事件（冲、刑、地支层模式）命中线运柱 → 地支侧线运加成 +6%

如果同一根柱既有天干侧事件又有地支侧事件，可能分别获得天干侧和地支侧的线运加成（各+6%）。

---

## §9. 静态十神模式被流年激活的逻辑

### §9.1 适用范围

本次逻辑只针对两种"坏力量"十神模式：

1. **伤官见官（hurt_officer）**
   - 一端：伤官
   - 一端：正官

2. **枭神夺食（pianyin_eatgod）**
   - 一端：偏印
   - 一端：食神

### §9.2 三层模式：原局 / 大运 / 流年

每一个模式类型 P ∈ {"hurt_officer", "pianyin_eatgod"}，在系统中存在三种层次：

1. **原局静态模式（natal）**
   - 命盘自己就带的模式
   - 例如：natal_patterns["hurt_officer"] = [pair1, pair2, ...]

2. **大运静态模式（dayun）**
   - 某一步大运的干支与命局干支形成的长期格局
   - 对每一条大运：dayun_patterns[dayun_index]["hurt_officer"] = [...]

3. **流年动态模式（liunian）**
   - 某一年，流年干/支与命局 / 当前大运形成的模式
   - 对每一年：liunian_patterns[year]["hurt_officer"] = [...]

### §9.3 静态模式被激活的三个必要条件

核心要求：

> 某一年，原局或大运中的一个静态模式 pair，要被视为被该年流年激活，必须同时满足：

1. **模式类型相同**
   - 都是伤官见官，或者都是枭神夺食
   - 伤官见官不能激活枭神夺食，反之亦然

2. **层级相同（kind 相同）**
   - 要么都是天干模式（kind == "gan"）
   - 要么都是地支模式（kind == "zhi"）
   - 不允许"天干枭神夺食"被"地支枭神夺食"激活，反之也不行

3. **具体两个字一模一样（顺序不要求一致）**
   - 静态 pair 是 (charA, charB)
   - 流年对应 pair 必须也是 {charA, charB} 这一对（集合意义相同，顺序可以不同）
   - 例如：
     - 静态：丁 + 辛
     - 流年：丁 + 辛 或 辛 + 丁 → 视为"同一对"
   - 如果静态是 丁 + 辛，而流年这一年是 乙 + 辛（也是伤官见官）
     → 不能算作"同一股力量"，该静态 pair 不被这一年的流年激活

只有同时满足这三条，静态那对才算在本年被引动。

### §9.4 处理步骤

对每一年 year、当前大运 dayun_idx、每种模式类型 P（"hurt_officer" / "pianyin_eatgod"）：

1. **先按 P 拿出三层的所有 pair**
   - natal_pairs_P = natal_patterns.get(P, [])
   - dayun_pairs_P = dayun_patterns_for_this_step.get(P, [])
   - liunian_pairs_P = liunian_patterns_for_this_year.get(P, [])

2. **按 kind 拆成干/支两层**
   - natal_gan_pairs_P / natal_zhi_pairs_P
   - dayun_gan_pairs_P / dayun_zhi_pairs_P
   - liunian_gan_pairs_P / liunian_zhi_pairs_P

3. **天干层激活规则**
   - 如果 len(liunian_gan_pairs_P) == 0：当年天干没有这个模式类型 P，原局和大运的天干层模式 P 全部保持"静态"，不算入当年风险
   - 如果 len(liunian_gan_pairs_P) > 0：对每一个流年天干 pair lp，在 natal_gan_pairs_P 和 dayun_gan_pairs_P 中找到所有静态 pair np 满足 set({np["char1"], np["char2"]}) == set({lp["char1"], lp["char2"]})
   - 静态 pair 只计一次，即使有多条流年 pair 都匹配到同一静态 pair

4. **地支层激活规则**
   - 规则完全一样，只是 kind == "zhi"

### §9.5 被激活的静态模式如何计算风险

#### 9.5.1 天干层静态激活风险

对模式 P 的天干层：
- 为每一对被激活的静态天干 pair 分配一个固定风险：**每对 pair 计 15% 风险**
- `static_risk_gan_P = 15.0 * (len(activated_natal_gan_pairs_P) + len(activated_dayun_gan_pairs_P))`
- 然后加入年度风险：
  - `risk_from_gan += static_risk_gan_P`
  - `total_risk_percent += static_risk_gan_P`

#### 9.5.2 地支层静态激活风险

对模式 P 的地支层：
- 基础：每对地支模式 P → **15%**
- 如果这对中包含命局月支地支（source="natal" 且 pillar="month" 且 kind="zhi" 的那个字参与这个 pair），则这一对 → **25%**
- `static_risk_zhi_P` 累加所有被激活的地支 pair 风险
- 然后加入年度风险：
  - `risk_from_zhi += static_risk_zhi_P`
  - `total_risk_percent += static_risk_zhi_P`

#### 9.5.3 模式 P 的总静态激活风险事件

为模式 P 创建一个汇总事件，包含：
- type: "pattern_static_activation"
- pattern_type: P
- risk_percent: static_risk_gan_P + static_risk_zhi_P
- risk_from_gan: static_risk_gan_P
- risk_from_zhi: static_risk_zhi_P
- activated_natal_gan_pairs / activated_dayun_gan_pairs / activated_natal_zhi_pairs / activated_dayun_zhi_pairs
- liunian_pairs_trigger_gan / liunian_pairs_trigger_zhi

注意：不要重复为流年模式 pair 计分，这些流年模式本身已经有各自的事件和风险计算规则。"静态激活"只为激活的静态 pair（原局 + 大运）再增加一段风险。

### §9.6 CLI 输出要求

当某种模式 P 有 pattern_static_activation 事件时，请按以下结构展示：

```
—— 本年十神模式：伤官见官 ——

流年触发：
  - 天干：流年丁（伤官） + 大运辛（正官）
  - （如果还有别的流年 pair，也列出来）

原局 / 大运同字模式被激活：
  - 原局已有 1 组伤官见官：丁 + 辛
  - 本步大运已有 1 组伤官见官：丁 + 辛

本年伤官见官总力量：
  - 同字组合 丁 + 辛 共 3 股（流年 1 + 原局 1 + 大运 1）
  - 本年因静态模式被激活额外增加风险：30.00%
```

要点：
- 明确区分："今年流年自己有哪些 P" 和 "原局 / 大运里有哪些同字同层的 P 被这一年激活"
- 数字要和实际计算一致：总股数 = 激活的静态 pair 数量 + 流年 pair 数量
- 风险数值 = 本次静态激活增加的 static_risk_gan_P + static_risk_zhi_P

---

## §12. Regression 测试用例

### §12.1 基础规则回归（main函数中运行）

1. **test_chenwei_not_punishment** - 辰未不刑规则（表级断言）
2. **test_chen_no_wei_target** - 辰不刑未的运行时断言
3. **test_traits_T1** - Traits 回归 T-1：2005-09-20 10:00 男
4. **test_traits_T2** - Traits 回归 T-2：2007-01-28 12:00 男
5. **test_yongshen_special_rule_wood** - 用神补木回归：2007-01-28 12:00
6. **test_yongshen_special_rule_fire** - 用神补火回归：2005-09-20 10:00
7. **test_lineyun_case_a** - 线运回归用例A：2005-09-20 10:00 男，2024年
8. **test_lineyun_case_b** - 线运回归用例B：2007-01-28 12:00 男，2022年
9. **test_harmonies_2005_09_20** - 合类事件回归：2005-09-20 10:00 男
10. **test_harmonies_2007_01_28** - 合类事件回归：2007-01-28 12:00 男
11. **test_sanhe_complete_2007_01_28** - 完整三合局检测回归：2007-01-28 12:00 男
12. **test_sanhui_complete_2005_09_20** - 完整三会局检测回归：2005-09-20 10:00 男

### §12.2 黄金回归用例（main函数后单独运行）

#### 例A（2005-09-20 10:00 男）

13. **test_golden_case_A_2021** - 2021年
    - 期望：总风险=65%（丑未冲35=10+5+20；运年相冲15=10+5；天克地冲20；墓库加成必须出现两次）

14. **test_golden_case_A_2033** - 2033年（已更新为包含三合/三会逢冲额外加分）
    - 期望：总风险70%
    - 丑戌冲 15%
    - 日柱天克地冲 20%
    - 新规则：巳午未三会里的未，冲了巳酉丑三合里的丑，额外 35%（两个字都在局/会里）

15. **test_golden_case_A_2059** - 2059年
    - 期望：core_total=203.5（不含线运）加上线运6% = 209.5

#### 例B（2007-01-28 12:00 男）

16. **test_golden_case_B_2021** - 2021年
    - 期望：core_total=40（丑未冲25=10+5+10；运年相冲15=10+5；墓库加成必须出现两次）

17. **test_golden_case_B_2012** - 2012年（新增：包含三合/三会逢冲额外加分）
    - 期望：核心风险45%
    - 辰戌冲：基础冲20% + 墓库10%（5%×2个柱） = 30%
    - 新规则：寅午戌三合局被冲（辰戌冲），辰不是用神 → 额外 15%

18. **test_golden_case_B_2016** - 2016年（新增：包含三合/三会逢冲额外加分）
    - 期望：总风险80%
    - 运年天克地冲 20%
    - 寅申冲 10%
    - 寅申枭神夺食 15%
    - 新规则：寅午戌三合冲申，额外 35%（申是用神）

19. **test_golden_case_B_2030** - 2030年
    - 期望：core_total≈82（当前实现值，未单独扣除线运）（丑戌刑6+静态刑6=12；辰戌冲15+静态冲15+TKDC10=40，运年天克地冲再加10% = 50%，其余地支层风险合计约32）

### §12.3 原局问题回归用例（main函数后单独运行）

20. **test_natal_punishment_case_A** - 原局刑回归用例A：2005-09-20 10:00，酉酉自刑（只有1个，5%）

21. **test_natal_punishment_case_B** - 原局刑回归用例B：2007-01-28 12:00，丑戌刑两次（各6%，共12%）

22. **test_marriage_wuhe_hints_case_A** - 天干五合争合/双合婚恋提醒回归用例A：2006-3-22 14:00 女
    - 原局：应识别1次（在"婚恋结构提示"里出现一行，包含被争合或命主合两个之一；并包含具体合名）
    - 流年2026：应识别1次，断言包含第三者介入，并包含合名
    - 流年2021：应识别1次，断言包含第三者介入，并包含合名

23. **test_marriage_wuhe_hints_case_B** - 天干五合争合/双合婚恋提醒回归用例B：2006-12-17 12:00 男
    - 流年2025：应识别1次，断言包含第三者介入，并包含合名
    - 流年2035：应识别1次（若是争合则断言第三者介入；若是双合则断言三角恋；并包含合名）

24. **test_marriage_wuhe_hints_case_C** - 天干五合争合/双合婚恋提醒回归用例C：1984-9-20 4:00 女
    - 流年2022：断言包含防止陷入三角恋，并包含合名
    - 流年2037：断言包含第三者介入，并包含合名
    - 大运2：在"大运批注最下面"断言包含防止陷入三角恋，并包含合名

25. **test_marriage_wuhe_hints_no_false_positive** - 天干五合争合/双合婚恋提醒回归测试（无引动不触发）
    - 2006-3-22 14:00 女在2080和2079年不能打印婚恋提醒（因为没有引动）

26. **test_marriage_wuhe_hints_dayun_no_duplicate** - 天干五合争合/双合婚恋提醒回归测试（大运层不重复打印）
    - 2006-12-17 12:00 男在大运6里：
      - 2055年应该打印（流年天干引动）
      - 2054年不应该打印（只有大运引动，没有流年引动）
      - 2057年不应该打印（只有大运引动，没有流年引动）

27. **test_marriage_wuhe_hints_dual_hints** - 天干五合争合/双合婚恋提醒回归测试（同一年两条提醒）
    - 1996-6-13 10:00 女
    - 如果2040年流年层有提醒，则必须同时出现两条提醒（被争合 + 三角恋），且不串层
    - 如果2030年流年层有提醒，则必须同时出现两条提醒（被争合 + 三角恋），且不串层

28. **test_natal_punish_zu_shang_marriage_explanation** - 原局刑解释回归测试：祖上宫-婚姻宫 刑
    - 2007-1-28 12:00 男：断言输出包含"祖上宫-婚姻宫 丑戌刑 成长过程中波折较多，压力偏大"（或相反顺序/地支顺序）

---

**总计：28个 regression 用例（随功能增加而更新）**
- main函数中运行：16个（基础规则 + 合类/婚配/原局打印等）
- main函数后单独运行：12个（黄金回归7个 + 原局问题2个 + 天干五合婚恋提醒6个 + 原局刑解释1个）

