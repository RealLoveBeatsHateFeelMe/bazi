# 八字系统业务规则说明

> **系统架构/接口契约请看 [`docs/architecture.md`](../docs/architecture.md)**  
> 本文档只管业务规则（计算公式、输出模板、口径规范）。

---

## §0. 核心业务口径（2026-01-13 更新）

### §0.1 十神标签映射（SHISHEN_LABEL_MAP）

十神标签是权威来源，渲染层必须从此映射取标签，禁止缺省为空。

| 十神 | 用神=是 | 用神=否 |
|------|---------|---------|
| 正官 | 认可/升迁/名誉 | 规章压力/束缚/被考核/开销大 |
| 七杀 | 领导赏识/扛事机会/突破 | 工作压力/对抗强/紧张感/开销大 |
| 正印 | 贵人/支持/学习证书 | 胡思乱想/思前顾后/效率低 |
| 偏印 | 偏门技术/思想突破/学习研究/灵感 | 多想/孤立/节奏乱 |
| 食神 | 产出/表现/生活舒适/技术突破 | 贪舒服/拖延/松散 |
| 伤官 | 表达/创新/技术突破/灵感 | 顶撞权威/口舌/冲突/贪玩 |
| 正财 | 努力得回报/方向更清晰/稳步积累(生活&工作) | 现实压力/精神压力大/想不开 |
| 偏财 | 机会钱/副业/人脉/意外之财 | 开销大/现实压力/精神压力大 |
| 比肩 | 自信独立/同辈助力/合伙资源/行动力 | 竞争争夺/冲动分心/投机或赌博破财/购置不动产化解 |
| 劫财 | 自信独立/同辈助力/合伙资源/行动力 | 竞争争夺/冲动分心/投机或赌博破财/购置不动产化解 |

### §0.2 year_detail 输出模板（4段结构）

当输出年度详情时（YEAR_DETAIL_TEXT），必须包含以下4段，不可省略：

```
【YYYY年总评】
流年干支：{gan}{zhi}
整体评估：{凶（棘手/意外）|明显变动（可克服）|有变动|一般}
上半年：{label}，下半年：{label}

【为什么会这样？】
主要风险来源：天干 {gan_risk}% / 地支 {zhi_risk}% / 总体 {total_risk}%
天干 {gan}（{gan_shishen}）：{用神得力|非用神}，{gan_label}
地支 {zhi}（{zhi_shishen}）：{用神得力|非用神}，{zhi_label}

关键触发结构：
• 【冲】{branch1}冲{branch2}（{source}冲{target}）
• 【刑】{branches}{type}
• 【模式】{pattern_label}
• 【三合/三会逢冲】{group_name}额外增{risk}%风险
（无触发时写：无显著冲刑害结构，风险主要来自十神非用神或时运波动）

【具体表现与提示】
• {hint1}
• {hint2}
• ...
（无提示时写：今年暂无特定事件提示）

【总体提示】
{B口吻建议，描述倾向/风险点/更可能发生什么，避免命令式}
```

### §0.3 last5 业务口径

| 规则 | 说明 |
|------|------|
| **年份窗口** | `[base_year-4, base_year-3, base_year-2, base_year-1, base_year]`（今年+往前4年） |
| **输出顺序** | 固定旧→新（升序），后端返回数组，前端按数组顺序渲染，不做二次排序 |
| **简版格式** | 每年两行：天干行（十神/用神/标签/上半年危险系数）+ 地支行（十神/用神/标签/下半年危险系数） |
| **下钻规则** | 凡 `total_risk >= 25` 或 `year_category in {凶, 有变动}` 的年份，必须追加 YEAR_DETAIL_TEXT（全部下钻，不限数量） |
| **非凶/非变动年** | 只输出简版十神特点，不下钻、不展开细节 |

### §0.4 风险百分比规范

| 规则 | 说明 |
|------|------|
| **取值范围** | 0–100（整数百分比） |
| **后端输出** | 统一输出 `risk_percent`（0–100），如源数据为小数概率则 ×100 |
| **前端展示** | 只负责加 `%`，禁止再乘 100/10000 |
| **边界处理** | `clamp(0, 100)`，禁止出现 1000%/5000% |

---

## §1. 基础计算规则

### §1.1 日主强弱计算

日主强弱通过计算四柱八字中所有位置对日主的生扶/消耗影响来确定。

**计算规则：**

1. **位置权重（POSITION_WEIGHTS）：**
   - 年干：0.10
   - 年支：0.10
   - 月干：0.10
   - 月支：0.35（最重要）
   - 日干：0.00（不参与给自己加分）
   - 日支：0.10
   - 时干：0.10
   - 时支：0.15

2. **五行关系系数（RELATION_COEFF）：**
   - 对每个位置的字，根据其五行与日主五行的关系确定系数：
     - +1.0：生扶/同气（例如：日主为火，木生火=+1.0，火同气=+1.0）
     - -1.0：泄/克/被克（例如：日主为火，土泄火=-1.0，水克火=-1.0）

3. **计算过程：**
   - 对每个位置：`贡献 = 位置权重 × 关系系数`
   - 正向力量（support_score）= 所有 +1.0 位置的贡献之和
   - 负向力量（drain_score）= 所有 -1.0 位置的贡献绝对值之和
   - 净得分（net_score）= 正向 - 负向
   - 总强度（total_strength）= 所有位置贡献的绝对值之和

4. **强弱百分比（strength_percent）：**
   ```
   strength_percent = (net_score + total_strength) / (2 × total_strength) × 100.0
   ```
   - 范围：0-100%
   - 全部有利 → 100%
   - 全部不利 → 0%

### §1.2 用神计算规则

用神根据日主天干、日主强弱百分比和全局五行占比来确定。

**全局五行占比计算：**
- 使用位置权重（POSITION_WEIGHTS）计算四柱八字中每个位置的五行占比
- 日干（day_gan）权重为0，不参与计算
- 天干用 GAN_WUXING 映射，地支用 ZHI_WUXING 映射

**用神确定规则：**

1. **甲乙木：**
   - 强（strength_percent >= 50）：用神 = ["火", "土"]
   - 弱（strength_percent < 50）：用神 = ["水", "木"]

2. **丙丁火：**
   - 强（strength_percent >= 50）：用神 = ["金", "水"]
   - 弱（strength_percent < 50）：用神 = ["木", "火"]

3. **戊己土：**
   - 强（strength_percent >= 50）：用神 = ["金", "水"]
   - 弱（strength_percent < 50）：用神 = ["火", "土"]

4. **庚金：**
   - 强（strength_percent >= 25）：用神 = ["木", "火"]
   - 弱（strength_percent < 25）：用神 = ["土", "金"]

5. **辛金：**
   - 如果全局水占比 > 70%：用神 = ["木", "火"]（调候优先）
   - 否则：
     - 强（strength_percent >= 20）：用神 = ["水", "木"]
     - 弱（strength_percent < 20）：用神 = ["土", "金"]

6. **壬癸水：**
   - 强（strength_percent >= 50）：用神 = ["木", "火"]
   - 弱（strength_percent < 50）：用神 = ["金", "水"]

### §1.3 十神计算规则

十神是根据日主天干与其他天干/地支的五行关系和阴阳属性来确定的。

**计算规则：**

1. **同五行：**
   - 同阴阳 → 比肩
   - 异阴阳 → 劫财

2. **我生他：**
   - 同阴阳 → 食神
   - 异阴阳 → 伤官

3. **他生我：**
   - 同阴阳 → 偏印
   - 异阴阳 → 正印

4. **我克他：**
   - 同阴阳 → 偏财
   - 异阴阳 → 正财

5. **他克我：**
   - 同阴阳 → 七杀
   - 异阴阳 → 正官

**地支十神：**
- 地支使用主气代表天干（ZHI_MAIN_GAN）来计算十神
- 例如：子→癸，丑→己，寅→甲，等等

### §1.4 五大十神类别映射

将具体十神映射到五大类别：
- **比劫**：比肩、劫财
- **财星**：正财、偏财
- **食伤**：食神、伤官
- **官杀**：正官、七杀
- **印星**：正印、偏印

---

## §1.5 数据结构：hints 列表系统（统一真相源）

**设计原则：**

系统采用"单一真相源"（Single Source of Truth）设计，所有用户可见的关键提示句子只在 `hints` 列表中生成一次，CLI/LLM/API 全部只读 `hints`，不允许在别处重复拼接同类文案。

**数据结构字段：**

1. **`natal["hints"]`** (List[str])
   - 类型：字符串列表
   - 内容：原局层面的提示句子列表（婚恋结构提示等）
   - 说明：这是原局提示的唯一真相源，CLI 从该列表读取并格式化输出

2. **`natal["marriage_hint"]`** (str)
   - 类型：字符串
   - 内容：婚配倾向提示句子（例如："更容易匹配：虎兔蛇马；或 木，火旺的人。"）
   - 说明：独立的婚配倾向字段，不包含"【婚配倾向】"前缀，前缀由 CLI 输出时添加

3. **`dayun_group["hints"]`** (List[str])
   - 类型：字符串列表
   - 内容：大运层面的提示句子列表（用神互换提示、大运层婚恋提醒等）
   - 说明：大运提示的唯一真相源

4. **`year["hints"]`** (List[str])
   - 类型：字符串列表
   - 内容：流年层面的提示句子列表（流年层婚恋提醒、风险提示等）
   - 说明：流年提示的唯一真相源

**数据生成位置：**

- `bazi/enrich.py`：所有 `hints` 的生成逻辑集中在此文件
  - `enrich_natal()`：生成原局 hints 和 marriage_hint
  - `enrich_dayun()`：生成大运 hints
  - `enrich_liunian()`：生成流年 hints

**输出格式要求：**

- CLI 输出时只从 `hints` 列表读取，不允许硬编码提示句子
- LLM 上下文构建时只从 `hints` 列表取文本
- API 返回时原样返回 `hints` 列表，不进行二次拼接

---

## §1.6 数据结构：Indexes 系统（Dayun Index + Relationship Index）

**设计原则：**

系统提供索引（Indexes）系统，用于快速查询和筛选特定类型的事件。**重要：Index 只是 Router 的目录页（辅助决策），不是内容真理源。facts 是唯一真相源，Index 仅用于快速查询和筛选，不用于生成模块内容。**

**体系口径（必须严格遵守）：**

- **facts 是唯一真相源**：所有关键内容和结论必须来自 `natal`、`luck`、`turning_points` 等 facts 数据
- **Index 只是 Router 的辅助目录**：Index 仅用于解释 Router 决策，不用于生成模块内容
- **"看到的 = API = 模型吃到的"对齐的是 presenter/打印层当前产出的那份产品输出（模块化输出对象），不是 Index**
- **打印层（presenter）是"内容生产/模块组装"的主体**：
  - UI 展示的任何关键内容必须来自 API 返回对象（facts 数据）
  - LLM 输入也必须使用同一份 API 返回对象中的模块输出
  - 允许 presenter 组装模块输出，但禁止出现"只在打印层临时推导、API/LLM 不存在"的隐藏结论
- **Index 可以作为 trace/审计字段返回**：但仅用于解释 Router 决策，不用于生成模块内容

**`analyze_complete()` 返回结构：**

`analyze_complete()` 函数返回完整的分析结果，包含以下字段：

```python
{
    "schema_version": "1.0.0",  # 数据格式版本号
    "natal": {...},              # 原局数据（包含 hints、marriage_hint 等）
    "luck": {...},               # 大运/流年数据（包含 hints 等）
    "turning_points": [...],     # 大运转折点列表
    "indexes": {                 # 索引系统（Router 辅助目录，不用于生成模块内容）
        "dayun": {...},          # Dayun Index (Index-3)：用神互换变动窗口信号
        "relationship": {...},   # Relationship Index (Index-5)：感情变动窗口信号
    }
}
```

**Dayun Index (Index-3) 字段结构：**

```python
{
    "yongshen_shift": {
        "hit": bool,                    # 是否存在用神互换窗口（默认 false）
        "windows": List[Dict],          # 用神互换窗口列表（排序稳定，按大运顺序）
    }
}
```

**window 结构（只包含可审计的最小信息，禁止写建议或行业方向）：**

```python
{
    "dayun_seq": int,                   # 第几步大运（从0开始）
    "year_range": {
        "start_year": int,              # 窗口起始年份
        "end_year": int,                # 窗口结束年份
    },
    "from_elements": List[str],         # 互换前用神五行集合（排序稳定，例如 ["木", "火"]）
    "to_elements": List[str],           # 互换后用神五行集合（排序稳定，例如 ["金", "水"]）
}
```

**字段说明：**

1. **`hit`** (bool)
   - 说明：整体命中开关，表示是否存在任何用神互换窗口
   - 计算：`hit = len(windows) > 0`
   - 默认值：`false`

2. **`windows`** (List[Dict])
   - 说明：用神互换窗口列表（排序稳定，按大运顺序/年份顺序固定）
   - 排序：按 `dayun_seq` 排序（升序），确保每次生成顺序一致
   - 合并规则：连续触发的大运（年份连续且 from_elements/to_elements 相同）会被合并为一个窗口
   - 默认值：空列表 `[]`

3. **`dayun_seq`** (int)
   - 说明：第几步大运（从0开始，即大运索引），用于唯一定位该大运
   - 示例：`3` 表示第4步大运（大运索引为3）

4. **`year_range`** (Dict)
   - 说明：窗口的年份范围
   - `start_year`：窗口起始年份（大运起始年份）
   - `end_year`：窗口结束年份（下一个大运起始年份 - 1，或当前大运起始年份 + 9）

5. **`from_elements`** (List[str])
   - 说明：互换前用神五行集合（排序稳定，例如 `["木", "火"]`）
   - 排序：按五行顺序排序，确保每次生成顺序一致

6. **`to_elements`** (List[str])
   - 说明：互换后用神五行集合（排序稳定，例如 `["金", "水"]`）
   - 注意：只记录五行信息，不包含"应该从事XX工作/行业"等建议性内容
   - 排序：按五行顺序排序，确保每次生成顺序一致

**数据生成位置：**

- `bazi/dayun_index.py::generate_dayun_index()`：Dayun Index 的生成逻辑
- `bazi/lunar_engine.py::analyze_complete()`：在主入口函数中调用并生成 Dayun Index

**Facts 原子信息依赖：**

Dayun Index 的生成依赖于以下 facts 原子信息（均在大运数据中）：

1. **大运数据**：`luck.groups[].dayun` - 大运列表
2. **用神互换信息**：`dayun.yongshen_swap_hint` - 用神互换提示信息（已在 `enrich_dayun` 中生成）
3. **原局用神**：`natal.yongshen_elements` - 原局用神五行列表

**输出口径约束：**

- **Index 只记录"变动事实"**：发生在哪步大运、年份范围、从哪些用神五行侧重 → 到哪些五行侧重
- **严禁在 Index 中写"应该从事什么工作/行业"等建议性内容**
- **Overview 场景只允许输出一句轻提示**："存在用神侧重变化窗口（仅提示变动，不展开原因；需要可继续追问）"
- **禁止输出"应该从事XX工作/行业"等建议性内容**
- **追问才允许 detail 模块解释原因与范围**（仍必须趋势/范围表达，不下单事件断言）

---

**Relationship Index (Index-5) 字段结构：**

```python
{
    "hit": bool,                    # 整体命中开关
    "types": List[str],             # 枚举类型列表（排序稳定）
                                   # 允许值：palace_clash, competing_combine_official_kill, competing_combine_wealth
    "years": List[int],             # 命中的年份列表（排序稳定，升序）
    "last5_hit": bool,              # 近5年是否命中（用于快速回答）
    "last5_years": List[int],       # 近5年命中的年份列表（排序稳定，升序）
}
```

**字段说明：**

1. **`hit`** (bool)
   - 说明：整体命中开关，表示是否存在任何感情变动窗口
   - 计算：`hit = len(years) > 0`

2. **`types`** (List[str])
   - 说明：命中的类型列表（去重、排序稳定）
   - 允许值：
     - `"palace_clash"`：冲到婚姻宫/夫妻宫
     - `"competing_combine_official_kill"`：天干争合官杀（女命）
     - `"competing_combine_wealth"`：天干争合财星（男命）
   - 排序：按字母顺序排序（`sorted()`），确保每次生成顺序一致

3. **`years`** (List[int])
   - 说明：所有命中年份的列表（排序稳定，升序）
   - 计算：收集所有满足触发条件的年份，去重后排序

4. **`last5_hit`** (bool)
   - 说明：近5年是否命中（用于"前五年回放/最近几年"场景快速回答）
   - 计算：`last5_hit = len(last5_years) > 0`
   - 近5年定义：包含当前年份往前推5年（包含当前年份）
   - 例如：如果 `base_year = 2024`，则近5年为 `[2024, 2023, 2022, 2021, 2020]`（last5_years = [base_year, base_year-1, base_year-2, base_year-3, base_year-4]）

5. **`last5_years`** (List[int])
   - 说明：近5年命中年份的列表（排序稳定，升序）
   - 计算：从 `years` 中筛选出在近5年范围内的年份，排序

**数据生成位置：**

- `bazi/relationship_index.py::generate_relationship_index()`：Relationship Index 的生成逻辑
- `bazi/lunar_engine.py::analyze_complete()`：在主入口函数中调用并生成 Relationship Index

**Facts 原子信息依赖：**

Relationship Index 的生成依赖于以下 facts 原子信息（均在流年数据中）：

1. **流年天干**：`liunian.gan` - 用于检测天干争合
2. **流年地支**：`liunian.zhi` - 用于检测冲
3. **冲信息**：`liunian.clashes_natal`（流年与命局的冲），`liunian.all_events`（所有事件，包含 `targets` 和 `pillar` 信息）
4. **争合信息**：`liunian.wuhe_events`（天干五合事件，包含 `is_zhenghe`、`few_side`、`many_side`、十神信息）

**输出口径约束：**

- **Index 只记录"变动事实"**：命中哪些年份、哪些类型
- **严禁在 Index 中写建议性内容**
- **Overview 场景**：只提示"有感情变动窗口"，不展开原因
- **Detail 场景**：用户追问时才展开具体原因（使用 `relationship.types` 和 `relationship.years`）
- **打印层禁止推导（硬约束）**：
  - 打印层必须只做"展示"，不得新增任何业务逻辑分支来决定是否提示、提示什么年份、命中什么类型
  - 所有关键结论/提示/命中结果必须在 facts 或 index 的字段中；打印层只能渲染这些字段，不得再推导新结论

---

## §1.7 Chat API：统一返回壳（answer/index/trace/error）

**设计原则：**

Chat API 提供统一的返回结构，确保前端能同时展示 LLM 的回答、Request Index v0（摘要目录页）和全链路 trace。

**关键边界：**

- **facts（用户建档生成的全量事实）仍是唯一真相源**：不要把推理散落到打印层
- **Index 是请求级派生快照**：随 base_year（服务器本地年）变化，尤其 last5/last3。可以做缓存，但语义必须等价于每次请求派生
- **Router 做决策只读 index**：不要扫 facts 全书

**统一返回壳（API 合同必须固定）：**

无论任何问题、任何模块、未来是否超限，都必须返回同一个外壳：

```python
{
    "answer": "string",           # 给用户看的自然语言
    "index": { /* Request Index v0 */ },  # 本次请求派生出来的 Index v0
    "trace": { /* 全审计 */ },    # 审计链路
    "findings": { /* Findings（facts/hints/links） */ },  # 结构化产物（可选附件）
    "error": null                 # MVP 先固定为 null（以后扩展）
}
```

**Request Index v0（字段契约：少、稳定、可空、可 diff）：**

Index 只做抽取/汇总，不做解释，不扫 events 大段文本；字段缺失必须保守默认（空列表/false/空字符串），字段名稳定不改。

**index.meta（必须有）：**

- `index_version`: "0.1.0"（固定存在，版本化）
- `base_year`: int（服务器本地年份）
- `last5_years`: 包含当年，固定为 `[base_year, base_year-1, base_year-2, base_year-3, base_year-4]`
- `last3_years`: `[base_year, base_year-1, base_year-2]`

最近几年默认=last5；用户明确说"三年"才用 last3。

**index.dayun（必须有）：**

- `current_dayun`: object（当前大运摘要，至少包含起止年 + 一个好运/一般/坏运标签）
- `yongshen_swap`: 稳定结构，永远存在
  - `has_swap`: bool
  - `items`: list（无互换则 []）
  - `hint`: string（无互换则 ""）

验收要点：黄金A 若涉及用神互换：has_swap=true 且 items 非空（能被 Router/前端稳定捕捉）；不涉及互换的人：has_swap=false 且 items=[]，不得影响流程。

**index.turning_points（必须有）：**

- `all`: list（可空，但字段必须存在）
- `nearby`: list（all 裁剪到窗口 `[base_year-3, base_year+3]`，包含今年，前后各三年）
- `should_mention`: bool（nearby 非空即 true）

窗口规则："临近才提"：窗口为 `[base_year-3, base_year+3]`（包含今年，前后各三年）。

**index.year_grade（近五年回放：必须含当年 + 必须展示上下半年条件）：**

- `last5`: 长度=5，顺序严格按 `meta.last5_years` 排序（year 从大到小）

每一项结构至少：
- `year`: int
- `Y`: float（= total_risk_percent）
- `year_label`: string

`year_label` 规则（必须按用户最新口径）：
- `Y >= 40.0` → `"全年 凶（棘手/意外）"`
- `25.0 <= Y < 40.0` → `"全年 明显变动（可克服）"`
- `Y < 25.0` → 必须输出上下半年（回放里就显示，不等追问）

当 `Y < 25` 时，必须额外输出两个 half：
- `half1`: {H, half_label} 其中 `H = risk_from_gan`
- `half2`: {H, half_label} 其中 `H = risk_from_zhi`

`half_label` 规则（必须按用户最新口径）：
- `H <= 10.0`：用神 → `"好运"`；非用神 → `"一般"`
- `10.0 < H < 20.0`：`"有轻微变动"`
- `H >= 20.0`：`"凶（棘手/意外）"`

用神/非用神的判断：沿用已有体系（Index 只存结果，不解释推导）。

**index.relationship（只提示"窗口"，不展开）：**

- `hit`: bool
- `years_hit`: list[int]（命中列表）
- `last5_years_hit`: list[int]（years_hit 与 meta.last5_years 的交集，保持排序与 last5_years 一致）

MVP 不需要精确解释"为什么命中"，只要能识别并提示"有变动窗口"。

**Router（只读 index 决策 + 输出可审计结果）：**

Router 输入：用户 query + index
Router 输出必须写入 trace，并决定 modules：

**intent 识别最低限度（MVP）：**

至少识别这些意图：
- `overall_recent`（整体/最近几年/模糊时间）→ 默认 years=last5
- `recent_3_years`（用户明确说"三年/近三年"）→ years=last3
- `named_year`（点名某年）→ years=[that_year]（是否补 dayun 背景由 Router 决定，但 trace 必须说明）

**叙述口径（必须贯彻）：**

"大运是气候、流年是天气"：
- 整体/最近几年：先引用 `index.dayun.current_dayun`（气候）+ 若 `turning_points.should_mention=true` 则提 nearby turning point；再用 `year_grade.last5` 做天气回放索引。
- 点名某年：可直接讲该年，但允许一句话带 dayun 背景（从 index.dayun 取，不扫 facts）。

**Modules（只做 facts 切片，不推理）：**

Modules 的职责：按计划切片 facts 或 index，喂给 LLM；不负责计算四档、不负责生成 turning points、不负责决定 years。

MVP 至少要支持这几个 module 名称（可以合并，但 trace 里必须能看出内容来源）：
- `DAYUN_OVERVIEW`（从 index.dayun / turning_points 取需要的摘要）
- `LAST5_YEAR_GRADE`（从 index.year_grade.last5 取）
- `RELATIONSHIP_WINDOW`（从 index.relationship 取）

**Trace（必须"全部都显示"）：**

trace 必须完整可视化审计链路，至少包含：

```python
{
    "router": {
        "intent": "...",
        "base_year": 2025,
        "years_used": [2025,2024,2023,2022,2021],
        "reasons": ["..."]   # 简短原因列表
    },
    "modules": [
        {"name": "DAYUN_OVERVIEW"},
        {"name": "LAST5_YEAR_GRADE"},
        {"name": "RELATIONSHIP_WINDOW"}
    ],
    "module_inputs": {
        "DAYUN_OVERVIEW": ["index.dayun.current_dayun", "index.dayun.yongshen_swap", "index.turning_points.nearby"],
        "LAST5_YEAR_GRADE": ["index.year_grade.last5"],
        "RELATIONSHIP_WINDOW": ["index.relationship"]
    },
    "backend_called": true,
    "token_usage": {"prompt": null, "completion": null, "total": null}
}
```

- `backend_called`: MVP 先固定 true（未来做超限时会变 false）
- `token_usage`: MVP 可以 null 占位，但字段必须存在（保持接口稳定）

**必须修正的口径冲突（写进 BAZI_RULES & 行为一致）：**

`last5_years` 包含当年（全局统一：meta.last5_years、year_grade.last5、relationship.last5_years_hit 都一致）。

**实现文件：**

- `bazi/request_index.py::generate_request_index()`：Request Index v0 生成逻辑
- `bazi/router.py::route()`：Router 决策逻辑（只读 index）
- `bazi/modules.py`：Modules 组装逻辑
- `bazi/chat_api.py::chat_api()`：Chat API 主入口

---

## §1.8 Findings：结构化产物（facts/hints/links）

**设计原则：**

Findings 是从 facts 中提取的结构化产物，包含 `facts[]`（原子事实）、`hints[]`（提示）、`links[]`（因果链接）。Findings 是可选附件，缺省或为空时不影响 API/router 正常工作。

**关键边界：**

- **Findings 是可选附件**：缺省或为空时，API 返回与未来 router 都能正常工作
- **单点生成原则**：Findings 只能由 `extract_findings_from_facts(facts)->findings` 产出；API/router 只能调用，不得各自拼 hints
- **只加不改原则**：不删除/不改已有字段语义，只新增 findings 字段或内部结构
- **ID确定性原则**：fact_id/hint_id 不用随机数；同一输入重复跑 ID 不变；拼接/哈希的 key_fields 必须排序稳定
- **trace 默认关闭原则**：trace 不参与业务逻辑；router 不读 trace；模型输入默认不含 trace

**Findings 固定结构：**

```python
{
    "facts": [
        {
            "fact_id": "string",  # 稳定的 fact_id（12位十六进制）
            "type": "string",      # fact 类型（如 "branch_clash", "pattern"）
            "kind": "string",      # kind 类别（如 "clash", "pattern"）
            "scope": "string",     # 作用域（如 "natal", "liunian_2024"）
            "label": "string",     # 简短标签
            # ... 其他 key_fields 字段
        }
    ],
    "hints": [
        {
            "hint_id": "string",   # 稳定的 hint_id（12位十六进制）
            "domain": "string",    # 领域（如 "relationship", "career"）
            "level": "string",     # 级别（如 "light", "moderate", "serious"）
            "label": "string",     # 提示文本
            # ... 其他 key_fields 字段（可选）
        }
    ],
    "links": [
        {
            "hint_id": "string",   # 指向的 hint_id
            "fact_ids": ["string"], # 关联的 fact_id 列表
            "rule_id": "string"    # 可选，规则标识
        }
    ],
    "meta": {}  # 可选，元信息
}
```

**字段说明：**

1. **`facts`** (List[Dict])
   - 说明：原子事实列表（可为空）
   - 每条 fact 有 `fact_id`、`type`、`kind`、`scope`、`label` 等字段
   - `fact_id` 使用 `hashlib.md5` 生成，确保稳定（同一输入重复跑 ID 不变）

2. **`hints`** (List[Dict])
   - 说明：提示列表（可为空）
   - 每条 hint 有 `hint_id`、`domain`、`level`、`label` 等字段
   - `hint_id` 使用 `hashlib.md5` 生成，确保稳定

3. **`links`** (List[Dict])
   - 说明：因果链接列表（可为空）
   - 每条 link 包含 `hint_id`（指向的 hint）、`fact_ids[]`（关联的 fact ID 列表）、`rule_id`（可选）
   - 每条 hint 必须能在 links 里找到对应的 fact_id[]

4. **`meta`** (Dict, 可选)
   - 说明：元信息（可选，可以缺失）

**Findings 缺省或为空时的处理：**

- Findings 可以为空结构：`{"facts": [], "hints": [], "links": []}`
- Findings 字段可以缺失（向后兼容）
- Findings 缺省或为空时，API 返回与未来 router 都能正常工作
- Router 不读 findings，只读 index

**数据生成位置：**

- `bazi/extract_findings.py::extract_findings_from_facts()`：Findings 提取逻辑（单点生成）
- `bazi/findings_collector.py::FindingsCollector`：Findings 收集器，ID 生成逻辑
- `bazi/chat_api.py::chat_api()`：在主入口函数中调用 `extract_findings_from_facts` 并添加到返回

**Facts 原子信息依赖：**

Findings 的生成依赖于以下 facts 原子信息（均在 luck 数据中）：
- 流年事件：`luck.groups[].liunian[].all_events` - 所有事件列表
- 冲事件：`all_events` 中的 `type="branch_clash"` 事件
- 模式事件：`all_events` 中的 `type="pattern"` 事件（如"枭神夺食"、"伤官见官"）

**输出口径约束：**

- **Findings 只记录"结构化事实"**：原子事实、提示、因果链接
- **严禁在 Findings 中写建议性内容**
- **Findings 是可选附件**：缺省或为空时不影响 API/router 正常工作

**核心原则（必须严格遵守）：**

1. **单点生成原则**：Findings 只能由 `extract_findings_from_facts(facts)->findings` 产出；API/router 只能调用，不得各自拼 hints

2. **附件原则**：Findings 是可选附件；Findings 缺省或为空时，API 返回与未来 router 都能正常工作

3. **只加不改原则**：不删除/不改已有字段语义，只新增 findings 字段或内部结构

4. **ID确定性原则**：fact_id/hint_id 不用随机数；同一输入重复跑 ID 不变；拼接/哈希的 key_fields 必须排序稳定（使用 `sorted(key_fields.items())`）

5. **trace 默认关闭原则**：trace 不参与业务逻辑；router 不读 trace；模型输入默认不含 trace

---

## §1.9 打印层架构规范（Print Layer Architecture）

**设计原则：单一真理源**

所有 CLI 输出格式必须集中定义在 `bazi/presenter/` 模块中：

| 组件 | 位置 | 职责 |
|-----|------|-----|
| 格式字符串 | `presenter/templates/constants.py` | 所有模板、标签、分隔符 |
| 格式化函数 | `presenter/formatters/*.py` | 纯函数：`(facts) -> str` |
| 渲染入口 | `presenter/render.py` | 编排所有 section |

**规则：**

1. 所有格式字符串必须定义在 `bazi/presenter/templates/constants.py`
2. 打印函数必须是纯函数：`(facts: Dict) -> str`
3. 禁止在打印函数中执行计算逻辑
4. CLI 输出修改必须同步更新 regression snapshots

**详细架构设计：** 见 `docs/architecture.md` §10

---

## §2. 位置权重与宫位定义

### §2.1 位置权重表

| 位置 | 权重 | 说明 |
|------|------|------|
| 年干 | 0.10 | 祖上宫天干 |
| 年支 | 0.10 | 祖上宫地支 |
| 月干 | 0.10 | 婚姻宫天干 |
| 月支 | 0.35 | 婚姻宫地支（最重要） |
| 日干 | 0.00 | 日主本身，不参与给自己加分 |
| 日支 | 0.10 | 夫妻宫地支 |
| 时干 | 0.10 | 事业家庭宫天干 |
| 时支 | 0.15 | 事业家庭宫地支 |

### §2.2 四柱宫位名称

- **年柱** → 祖上宫（家庭出身、早年环境）
- **月柱** → 婚姻宫
- **日柱** → 夫妻宫（特别强调这一点）
- **时柱** → 事业家庭宫（工作 / 子女 / 后期家庭）

---

## §3. 流年/大运与命局的相互作用

### §3.0 流年明细覆盖范围

**流年明细覆盖范围：**

流年明细覆盖范围从**出生年**（或建模定义的起始年）一直到 `year_range` 终点（第十步大运结束年）。其中**"起运前的年份"**（出生年到第一个有效大运起始年份之前的年份）也会生成流年条目。

**数据层面说明：**

- `luck.groups` 列表中，第一个组可能为 `{"dayun": None, "liunian": [...]}`，表示"大运开始之前的流年"组
- 后续组为正常的大运组：`{"dayun": {...}, "liunian": [...]}`
- 所有流年条目的数据结构与计算逻辑完全一致，只是"起运前的流年"没有对应的大运信息

**年份合法范围校验：**

Router/Time Index 校验年份 `year` 合法时，起点不再是 `luck.groups[0].dayun.start_year`（如果第一个组是"起运前的流年"组，则 `groups[0].dayun` 为 `None`），而是**"流年明细的最早年份"**（通常就是出生年）。

获取流年明细最早年份的方法：
- 遍历 `luck.groups` 中的所有 `liunian` 列表
- 找到最早年份：`earliest_year = min(ln["year"] for group in luck["groups"] for ln in group.get("liunian", []))`
- 或从第一个非空流年组中获取：`earliest_year = luck["groups"][0]["liunian"][0]["year"]`

**叙述策略不变：**

- **大运仍然是"气候"**：大运代表长期运势趋势（十年周期）
- **流年是"天气"**：流年代表短期运势变化（一年周期）
- 只是在**数据层面**补齐了起运前的流年条目，使得流年明细覆盖从出生年开始，叙述策略和业务逻辑保持不变

---

### §3.1 冲（branch_clash）

冲是指流年或大运的地支与命局中的地支构成相冲关系。

#### 3.1.1 基础冲力量计算

对于某个被冲地支 `target_branch`，先计算其在命局中的"宫位力量"：

```
base_power_percent = （它出现在年支 / 月支 / 日支 / 时支上的 POSITION_WEIGHTS 之和） × 100%
```

#### 3.1.2 普通冲

普通冲的最终风险值为：

```
risk_percent = base_power_percent
```

#### 3.1.3 墓库冲加成

墓库冲特指辰戌、丑未之间的互冲关系。

对于墓库冲，如果命局中有 N 个相同的目标墓库地支被同一个流年/大运地支冲到（即命局中 N 个不同宫位都含有该墓库地支），则：

```
墓库加成 = 5% × N（百分比）
risk_percent = base_power_percent + 5% × N
```

单事件风险封顶 100（年度总风险不封顶，可>100）。

**举例：**

命局年支为戌、日支为戌，流年地支为辰：
- `base_power_percent` = 20%（年支0.1 + 日支0.1 = 0.2，× 100）
- N = 2（两个宫位都被冲到）
- 墓库加成 = 5% × 2 = 10%
- 最终 `risk_percent` = 20% + 10% = 30%

#### 3.1.4 三合/三会逢冲额外加分

当冲事件发生时，如果冲的两个字中至少有一个属于某个已成立的三合局或三会局，则触发额外加分规则。

**触发条件：**
1. 当年确实发生冲（流年与命局的冲，或运年相冲）
2. 冲的两个字中至少有一个属于某个已成立的三合/三会局

**判定规则：**

Step A：确认当年发生的冲是谁和谁冲（使用现有的冲检测结果）

Step B：检查这次冲是否冲到某个已成立的三合/三会
- 若两个字都不属于任何三合/三会成员 → 规则不触发
- 若至少有一个字属于三合/三会 → 继续

Step C：区分"局内字"和"单独字"，判断单独字是否为用神
- **只有一个字属于三合/三会：**
  - 属于局/会的字 = "局内字"
  - 另一个字 = "单独字"
  - 判断单独字的五行是否在用神五行集合中：
    - 单独字是用神 → 额外 +35%
    - 单独字不是用神 → 额外 +15%
- **两个字都属于三合/三会：**
  - 直接额外 +35%（不需要判断单独字）

**封顶规则：**
- 15% 和 35% 当年只能加一次
- 如果同一年出现多个候选命中，35% 优先于 15%
- 加完后立刻锁死本年这条规则，不再叠加

**计入风险：**
- 三合/三会逢冲额外加分计入 `risk_from_zhi`（因为冲是地支事件）
- 在打印"冲总影响"时，会显示：`动态 X% + 静态 Y% + 三合/三会逢冲 Z% = 总和%`

**打印顺序：**
1. 先打印：谁和谁冲（例如"丑戌冲"、"辰戌冲"、"寅申冲"）
2. 再打印：哪个字属于哪个三合/三会、哪个是单独字
   - 例如："寅午戌三合火局被冲到：冲对中'寅'属于三合；'申'是单独字"
3. 再打印：单独字是不是用神（如果有单独字）
   - 例如："单独字申：是用神" 或 "单独字申：不是用神"
4. 最后打印：本规则本年额外加分是多少（+15 或 +35），并声明本年封顶已用掉
   - 例如："三合/三会逢冲额外：+35%（本年只加一次）"

**举例：**

例A（2005-9-20 10:00 男，2033年）：
- 丑戌冲 15%
- 日柱天克地冲 20%
- 新规则：巳午未三会里的未，冲了巳酉丑三合里的丑，额外 35%（两个字都在局/会里）
- 总计：70%

例B（2007-1-28 12:00 男，2012年）：
- 辰戌冲：基础冲20% + 墓库10%（5%×2个柱） = 30%
- 新规则：寅午戌三合局被冲（辰戌冲），辰不是用神 → 额外 15%
- 核心风险：30% + 15% = 45%

例B（2007-1-28 12:00 男，2016年）：
- 运年天克地冲 20%
- 寅申冲 10%
- 寅申枭神夺食 15%
- 新规则：寅午戌三合冲申，额外 35%（申是用神）
- 总计：80%

#### 3.1.5 其他规则

- 冲事件的 `type = "branch_clash"`，`role = "base"`
- 影响档位判断：
  - `impact_level`: ≤15% → minor, 15–30% → moderate, >30% → major
  - `suggestion_level`: 相应映射为 normal/be_careful/strong_warning

---

### §3.2 刑（punishment）

（刑的规则见其他文档或后续补充）

---

### §3.3 线运（年龄段对应宫位）

线运是指根据当前年龄对应的主要宫位，当基础事件作用在该宫位时，会额外增加风险分。

#### 3.3.1 年龄段与宫位映射

根据当前虚龄，确定线运对应的宫位：

- **0–16 岁**：对应 **年柱**（year）
- **17–32 岁**：对应 **月柱**（month）
- **33–48 岁**：对应 **日柱**（day）
- **49 岁及以上**：对应 **时柱**（hour）

#### 3.3.2 线运加成规则

**重要：线运加成是按年份计算的，每一年最多只加一次 6%，不会按事件数量反复累加。且需要命中 active_pillar 的基础事件 risk_percent >= 10.0 才触发。**

具体规则如下：

1. 根据当前年龄 `age` 确定 `active_pillar`（year/month/day/hour）：
   - 0–16 岁：`active_pillar = "year"`
   - 17–32 岁：`active_pillar = "month"`
   - 33–48 岁：`active_pillar = "day"`
   - 49 岁及以上：`active_pillar = "hour"`

2. 扫描该年所有**基础事件**（`role="base"`，例如冲 branch_clash，未来的枭神夺食、伤官见官等）：
   - 判定触发：存在至少一条 base 事件满足：
     1. 该事件命中 `active_pillar`（即该事件的 `targets` 中有 `pillar == active_pillar`）
     2. 且该事件的 `risk_percent >= 10.0`
   - 只要有一条满足条件的事件就立即触发，不再继续扫描其他事件。

3. 一旦触发线运加成：
   - 本年整体额外增加一次 6% 的风险分：`lineyun_bonus = 6.0`。
   - **全年最多只加一次 6%，不叠加、不分干支。**

4. 年度总风险计算更新为：
   ```
   other_effect = 所有 role != "punisher" 事件的 risk_percent 之和（不包含线运加成）
   punish_total = 所有刑事件贡献之和
   lineyun_bonus = 6.0（如果该年触发线运）否则 0.0
   total_risk_percent = other_effect + punish_total + lineyun_bonus
   ```
   
   **注意：年度总风险不封顶（可>100），只对单事件风险按各自规则封顶（例如冲事件自身封顶100）。**

5. 线运事件记录：
   - 生成一条 `role="lineyun"` 的事件记录，用于解释：
     - `type: "lineyun_bonus"`
     - `risk_percent: 6.0`
     - `active_pillar: "year"/"month"/"day"/"hour"`
     - `trigger_events: [<触发来源事件的简化引用>]`

**举例：**

- 某年虚龄 25 岁（对应月柱），该年有一个基础事件命中月柱且 `risk_percent = 10.0`：
  - 触发线运加成
  - `lineyun_bonus = 6.0`（只加一次）

- 若命中 active_pillar 的基础事件 `risk_percent = 9.9`，则不触发线运加成，`lineyun_bonus = 0.0`

---

## §4. 十神力量与格局提示

### §4.1 五大十神类别（分类规则）

将常见十神合并成 5 个大类：

- **比劫**：比肩、劫财
- **财星**：正财、偏财
- **食伤**：食神、伤官
- **官杀**：正官、七杀
- **印星**：正印、偏印

以后只要出现具体的十神名（正印、偏印、七杀等），都可以映射到这 5 大类之一，用于统计力量占比和格局提示。

### §4.2 五大十神类别的力量占比

在一个八字中，计算上述 5 大类别的"力量占比"（0–100%），方法类似于当前的"五行力量占比"：

1. 遍历四柱八字的 8 个位置（天干 + 地支主气）：
   - 年干、年支、月干、月支、日干、日支、时干、时支；
   - 每个位置都有一个位置权重 POSITION_WEIGHTS：
     - `year_gan` / `year_zhi` / `month_gan` / `month_zhi` / `day_gan` / `day_zhi` / `hour_gan` / `hour_zhi`。

2. 对每个字：
   - 先根据日干（日主）计算该字对应的具体十神（正印、七杀、食神、正财等），用项目里现有的十神算法；
   - 再把这个具体十神映射到 5 大类之一（比劫 / 财星 / 食伤 / 官杀 / 印星）。

3. 将该字所在位置的权重累加到对应类别上：
   - 例如：月干为七杀，位置权重 0.10 → 官杀 +0.10；
   - 月支主气为正官，位置权重 0.35 → 官杀 +0.35；
   - 日干本身也有十神（比肩），日干位置的权重为 `day_gan`，在统计时纳入计算。

4. 遍历完 8 个字后，将各类别的总和归一到 0–100%，得到：

   - 比劫：XX%
   - 财星：XX%
   - 食伤：XX%
   - 官杀：XX%
   - 印星：XX%

并将这组数据在 `analyze_basic` 的返回值中以字段形式返回。

### §4.3 壬癸水日主 + 官杀（土）很重 + 身弱 → 用神加"木"

在日主为壬、癸水时，需要一个特殊调整规则：

**触发条件（必须同时满足）：**

1. **日主为壬水或癸水**：
   - 日干 = "壬" 或 "癸"；
   - 日主五行 = 水。

2. **日主被判定为"身弱"**：
   - 使用当前系统中已有的日主强弱计算（`strength_percent` 0–100%），
   - 这里暂定：`strength_percent < 50` 视为"身弱"（包含偏弱、很弱）。

3. **官杀（土）类别的力量占比 > 40%**：
   - 在 4.2 中计算得到的 `shishen_category_percentages["官杀"]`，
   - 如果该值 > 40，即认为"官杀（土）过重"。

**当以上三个条件都满足时：**

在当前的用神五行列表基础上，额外加入"木"作为用神（如果已经包含木则不重复添加）。

也就是说，这种命局的用神变成（去重后）：

- 原本为水日主身弱时的标准用神（比如金、水），
- 再加上"木"这一项，
- 最终返回给用户的 `yongshen_elements` 至少包含 金、水、木。

### §4.4 用神与运势的关系：好运判断（大运 / 流年）

用神会随着身强身弱、十神结构等调整而变化。

在运势判断上，不需要解释复杂的原因，只要基于"是否走到用神 + 危机程度"做一个简单的"好运 / 非好运"判断。

**约定：**

**对 大运：**

- 大运的"自身五行"取自其天干和地支：`gan_element`、`zhi_element`。
- 如果天干或地支的五行中，至少有一个落在当下的用神列表 `yongshen_elements` 中，
- 并且该步大运的平均风险程度不高（可以使用该大运 10 个流年的 `total_risk_percent` 的**平均值**或**中位数**），
- 若该平均风险 ≤ 15%，则将该步大运整体标记为"好运"；
- 否则，不标记为好运（可以视为"普通 / 一般 / 混合"，在代码里仍用 `is_good=False` 处理）。

**对 流年：**

- 流年的天干、地支对应的五行：`gan_element`、`zhi_element`。
- 只要其中至少一个五行落在用神列表 `yongshen_elements` 中，
- 并且本年计算出来的 `total_risk_percent ≤ 15`，
- 就认为该流年是"好运年"，可标记 `is_good=True`。

不需要对外额外解释"为什么好运"（例如"因为木可以制官杀"），这些原因留在内部逻辑中就好。

可以在数据结构中新增字段，例如：

- 大运：`dayun["total_risk_average"]`（该步大运下所有流年风险平均值）、`dayun["is_good"]`（基于用神 + 风险 ≤15% 的综合判断）
- 流年：`liunian["is_good"]`（基于用神 + 风险 ≤15% 的判断）

CLI 层面只需要展示"好运 / 坏运 / 一般"等简单标签，不必解释具体原理。

### §4.5 天干格局提示：哪类十神在天干上成势

在本命四柱中，仅针对**年干、月干、日干、时干**做一个格局提示。

**规则：**

1. 对四个天干分别计算其具体十神（正印、七杀、比肩等），再映射到 4.1 中的五大类别。

2. 按"类别"分组，统计每一类在天干上出现的次数：
   - 例如：
     - 年干：正印 → 印星
     - 时干：偏印 → 印星
     - → 则印星类在天干中出现 2 次。

3. 对于那些在天干中出现**次数 ≥ 2** 的类别，生成提示信息，包括：
   - 类别名（印星 / 官杀 / 食伤 / 财星 / 比劫）；
   - 具体是哪些柱、什么天干、对应的具体十神。

这些信息放入 `analyze_basic` 的返回结果中，例如：

```python
\"stem_pattern_summary\": [
    {
        \"category\": \"印星\",
        \"members\": [
            {\"pillar\": \"year\", \"gan\": \"甲\", \"shishen\": \"正印\"},
            {\"pillar\": \"hour\", \"gan\": \"乙\", \"shishen\": \"偏印\"},
        ],
    },
    ...
]
```

### §4.6 主要性格（dominant_traits）

在五大十神类别的基础上，为用户给出一个**主要性格 / 气质倾向**的总结字段 `dominant_traits`，并作为 `analyze_basic` 的一部分返回给前端。

#### 4.6.1 统计口径

- **只看原局（natal）**，不看大运 / 流年；
- **排除日干**：`day.gan` 不计入任何统计；
- 计入的位置为：
  - 年干 / 月干 / 时干（3 个天干）；
  - 四柱地支主气（年支 / 月支 / 日支 / 时支，经主气代表天干后计算十神）；
- 权重统一使用 `POSITION_WEIGHTS`：
  - 天干：`year_gan` / `month_gan` / `hour_gan`；
  - 地支：`year_zhi` / `month_zhi` / `day_zhi` / `hour_zhi`。

每个位置的字先换算为**具体十神**（正印、偏印、正财、偏财、正官、七杀、食神、伤官、比肩、劫财），
再映射到五大类之一（印星 / 财星 / 官杀 / 食伤 / 比劫）。

#### 4.6.2 全局占比与子类占比

在上述 7 个位置（3 干 + 4 支）的有效权重中，定义：

- **五大类总占比**：
  - 对每个大类（印星 / 财星 / 官杀 / 食伤 / 比劫），累加所有属于该类的位置权重之和；
  - 用该类权重 / 所有有效权重之和，得到 `total_percent`（0–100%）。
- **子类占比**：
  - 每个大类下再区分**子类**：
    - 印星：正印 / 偏印；
    - 财星：正财 / 偏财；
    - 官杀：正官 / 七杀；
    - 食伤：食神 / 伤官；
    - 比劫：比肩 / 劫财；
  - 子类占比使用同一套权重和分母：
    - 例如：`偏印_percent = 偏印对应所有位置权重之和 / 所有有效权重之和 × 100`。

#### 4.6.3 纯 / 混杂与 stems_visible_count

1. **混杂判定（mix_label）**
   - 对每个大类，统计其下子类中**权重 > 0** 的具体十神种类数：
     - 若同一大类下至少两个子类都有权重（如正官+七杀、正印+偏印），则：
       - `mix_label = "混杂"`；
     - 若只有一个子类有权重（如只有偏印），则：
       - `mix_label = "纯" + 子类名`  
       - 例如："纯偏印"、"纯正财"、"纯七杀"、"纯食神"、"纯比肩" 等。

2. **stems_visible_count（天干透出次数）**
   - 仅统计**年干 / 月干 / 时干**这 3 个天干；
   - 对每个天干位置：
     - 换算具体十神；
     - 若属于上述任何一个子类（如偏印、正财等），则该子类的 `stems_visible_count += 1`；
   - 地支主气只参与权重统计，不计入 `stems_visible_count`。

#### 4.6.4 输出结构（dominant_traits）

`analyze_basic` 在返回中新增字段：

```python
basic["dominant_traits"] = [  # 若无任何有效类别，可为空列表
  {
    "group": "印",           # 五大类之一（印 / 财 / 官杀 / 食伤 / 比劫）
    "total_percent": 30.0,   # 该大类的总占比
    "mix_label": "纯偏印",   # 纯 / 混杂标签（正偏印混杂 / 官杀混杂 / 纯偏财 等）
    "detail": [
      {
        "name": "正印",
        "percent": 0.0,
        "stems_visible_count": 0,
        "breakdown": {
          "stems_percent": 0.0,
          "branches_percent": 0.0,
        },
      },
      {
        "name": "偏印",
        "percent": 30.0,
        "stems_visible_count": 3,
        "breakdown": {
          "stems_percent": 30.0,
          "branches_percent": 0.0,
        },
      },
    ],
  },
  {
    "group": "财",
    "total_percent": 45.0,
    "mix_label": "纯偏财",
    "detail": [
      {
        "name": "正财",
        "percent": 0.0,
        "stems_visible_count": 0,
        "breakdown": {...},
      },
      {
        "name": "偏财",
        "percent": 45.0,
        "stems_visible_count": 2,
        "breakdown": {...},
      },
    ],
  },
  ...
]
```

> 备注：
> - `dominant_traits` 列表按 `total_percent` 降序排序，便于展示；
> - 示例中的数值仅为结构展示，真实数值以代码计算为准。

#### 4.6.5 性格打印格式（CLI输出）

在 `bazi/cli.py` 中，性格输出分为两个部分：

**1. 主要性格**
- 筛选规则：
  - `total_percent >= 35%` → 主要性格
  - 透干次数 >= 2 → 主要性格
  - 透干次数 >= 1 且该大类五行是用神 → 主要性格（额外晋级）

**2. 其他性格**
- 五大类全量（含 0%）
- 当 `total_percent == 0` 时：
  - 整组不打印（不输出任何行）

#### 4.6.5.1 新格式：正/偏比例 + 透干 + 得月令（结构化打印）

**触发条件与边界：**

1. **组是否打印**
   - 若该组 正% + 偏% == 0：整组不打印（不输出任何行）

2. **偏占比计算（仅在并存时）**
   - 仅当 正% > 0 且 偏% > 0 才计算偏占比：
     - 偏占比 = 偏% / (正% + 偏%)
   - 偏占比打印 保留 1 位小数（四舍五入，0.75 → 0.8）

3. **口径阈值（只看偏占比）**
   - 偏占比 <= 0.30 → 正主导（口径句：{正十神}明显更多（{偏十神}只算一点））
   - 0.30 < 偏占比 <= 0.60 → 并存（口径句：{正十神}与{偏十神}并存）
   - 偏占比 > 0.60 → 偏主导（口径句：{偏十神}明显更多（{正十神}只算一点））

4. **"纯"判定（并存以外）**
   - 若 正% > 0 且 偏% == 0：结构标签用 纯{正十神}{正%}%
   - 若 偏% > 0 且 正% == 0：结构标签用 纯{偏十神}{偏%}%
   - 纯的情况下：不打印"偏占多少/混杂口径"两行

**透干（升级为"具体十神 + 柱位"）：**

- 识别口径：在「主要性格」打印中，对 **命局四柱的天干（年/月/日/时）**逐柱计算其"具体十神"（正/偏等），并归入对应组
- 打印格式（固定顺序）：
  - 只打印本组对应的具体十神（例如财组只打印正财/偏财；官杀只打印正官/七杀）
  - 柱位固定顺序：年柱；月柱；日柱；时柱
  - 每条格式：{柱位}{具体十神}透干×1
  - 多条用全角分号连接：年柱偏财透干×1；时柱偏财透干×1
  - 注意：这是 按柱位逐条列出（已指定），不是汇总"×2"

**得月令（升级为"具体十神"）：**

- 识别口径：使用现有"月支主气天干"体系（项目里已经是主气天干），将该主气天干转换为"具体十神"（正/偏等）
- 得月令只属于 一个具体十神，并落到对应组
- 打印格式：仅在该组命中得月令时打印：得月令：{具体十神}（例如：得月令：偏财）

**最终打印格式（必须一字不差的结构与顺序）：**

对每个组（印/官杀/食伤/比劫/财），输出如下：

**第一行（总览行，字段顺序固定）**

模板（用全角分号 ； 分隔段）：
```
{组名}（{组总占比:.1f}%）：{主标签}；{得月令段(可选)}；{透干段(可选)}；{结构段}
```

- **{主标签}**：
  - 纯：就是该具体十神（例：偏财、正印、七杀）
  - 并存：
    - 偏主导 → 主标签=偏十神
    - 正主导 → 主标签=正十神
    - 并存区间 → 主标签={正十神}与{偏十神}
- **{得月令段}**：得月令：{具体十神}（无则整段省略）
- **{透干段}**：按上述列举（无则整段省略）
- **{结构段}**：
  - 纯：纯{具体十神}{占比:.1f}%
  - 并存：{正十神}{正%:.1f}%，{偏十神}{偏%:.1f}%（中文逗号 ，）

要求：如果可选段不存在，不能出现空段或连续 ；；。

**后续行（Bullet 行，顺序固定）**

- 若并存（正%>0 且 偏%>0），在第一行后依次打印三行：
  - `- 偏占多少：{偏占比:.1f}`
  - `- 混杂口径：{口径句}`
  - `- {组名}的五行：{五行}；{组名}为用神` 或 `- {组名}的五行：{五行}；{组名}不为用神`
- 若纯（只一边>0），只打印最后一行：
  - `- {组名}的五行：{五行}；{组名}为用神/不为用神`

#### 4.6.6 六亲助力（liuqin_zhuli）

#### 4.6.7 CLI 输出格式：原局信息 sections

**输出格式说明：**

在 CLI 输出中，原局信息按以下独立 sections 组织，每个 section 使用统一的标题格式（"—— 标题 ——"）：

1. **"—— 用神信息 ——" section**
   - 位置：在性格信息之后
   - 内容：
     - `用神五行（候选）： {五行列表}`（只包含用神五行，不夹带婚配倾向）
     - `用神（五行→十神）：...`（如果存在）
     - `用神落点：...`（如果存在）
     - `原局六合：...`（如果存在，格式：宫位和宫位合（XX合））
     - `原局半合：...`（如果存在，格式：宫位 与 宫位 半合（XX半合））
     - `原局天干五合：...`（如果存在）
   - 说明：所有"合类结构事实"（半合/六合/三会/三合/天干五合）都在此 section，不在"婚配倾向"section

2. **"—— 婚配倾向 ——" section**
   - 位置：在用神信息之后
   - 内容：
     - `更容易匹配：{生肖串}；或 {五行列表}旺的人。`
   - 说明：此 section 只包含匹配倾向句子，不包含任何原局结构事实（如半合/六合/三会/三合/天干五合等）

3. **"—— 婚恋结构 ——" section**
   - 位置：在婚配倾向之后
   - 内容：
     - 列表形式，每条提示一行（不包含"婚恋结构提示："前缀）
     - 包含内容：官杀混杂、正偏财混杂、原局层天干五合婚恋提醒等
   - 说明：
     - 所有原局婚恋结构提示统一在此 section 展示
     - 从 `natal["hints"]` 列表中读取，去除"婚恋结构提示："前缀后输出
     - 保持中立口吻（例如："官杀混杂，桃花多，易再婚，找不对配偶难走下去"）

4. **"—— 用神互换 ——" section**
   - 位置：在婚恋结构之后，大运信息之前
   - 内容：
     - `{起始年份}-{结束年份}年：{行业方向描述}`
     - 多段区间时，每段一行
   - 标题格式：统一使用"—— 用神互换 ——"（前后各两个破折号）
   - 说明：汇总所有大运中触发的用神互换区间，按年份范围合并展示

**Section 顺序：**

```
—— 用神信息 ——
  （用神五行、用神落点、原局六合/半合/天干五合等）
—— 婚配倾向 ——
  （匹配倾向句子）
—— 婚恋结构 ——
  （婚恋结构提示列表）
—— 用神互换 ——
  （用神互换区间汇总）
```

#### 4.6.8 天干五合争合/双合婚恋提醒（marriage_wuhe_hints）

**功能概述：**

基于天干五合（甲己合、乙庚合、丙辛合、丁壬合、戊癸合）检测婚恋关系中的争合和三角恋情况，提供婚恋变化提醒。

**天干五合固定集合：**

- 丁壬合
- 乙庚合
- 甲己合
- 戊癸合
- 丙辛合

**配偶星X与争合字Y的映射规则：**

根据日主五行和性别，确定配偶星X和争合字Y（同五行一端）：

**女命（X = 官杀：克日主）：**
- 日主木（甲/乙）：X=庚，Y=乙（乙庚合）
- 日主火（丙/丁）：X=壬，Y=丁（丁壬合）
- 日主土（戊/己）：X=甲，Y=己（甲己合）
- 日主金（庚/辛）：X=丙，Y=辛（丙辛合）
- 日主水（壬/癸）：X=戊，Y=癸（戊癸合）

**男命（X = 财：被日主克）：**
- 日主木（甲/乙）：X=己，Y=甲（甲己合）
- 日主火（丙/丁）：X=辛，Y=丙（丙辛合）
- 日主土（戊/己）：X=癸，Y=戊（戊癸合）
- 日主金（庚/辛）：X=乙，Y=庚（乙庚合）
- 日主水（壬/癸）：X=丁，Y=壬（丁壬合）

**三层检测范围：**

1. **原局层**：只看原局四柱天干（4个），不需要引动
2. **大运层**：原局四柱天干 + 当前大运天干，必须大运天干是X或Y才触发
3. **流年层**：原局四柱天干 + 当前大运天干 + 当前流年天干，必须流年天干是X或Y才触发（避免重复打印大运层已打印的提醒）

**提醒类型：**

**A) 他人争合（别人抢配偶星）：**

触发条件（在该层天干集合中）：
- 出现X（女：官杀；男：财）
- 出现Y（X的五合对象，且是日主同五行一端）
- 参与这次五合的X与Y都不是"日干那一颗"
- 如果Y恰好等于日干字（如女丁日主Y=丁），则必须有"另一颗Y"参与（即Y的实例不是日干那柱的Y）

打印文案：
- 女命：`婚恋变化提醒（如恋爱）：天干官杀星被争合，{合名}合走官杀星，注意，防止感情竞争/第三者介入`
- 男命：`婚恋变化提醒（如恋爱）：天干财星被争合，{合名}合走财星，注意，防止感情竞争/第三者介入`

**B) 命主双合（命主自己脚踏两只船/三角恋 - 分支B1）：**

触发条件（在该层天干集合中）：
- 日干本字 = Y（即日干就是那一端能与X五合的字）
- 并且集合里出现两个X（同一种X出现≥2次，可跨原局/大运/流年凑齐）

打印文案：
- 女命：`婚恋变化提醒（如恋爱）：命主合两个官杀星，{合名}，注意，防止陷入三角恋`
- 男命：`婚恋变化提醒（如恋爱）：命主合两个财星，{合名}，注意，防止陷入三角恋`

**B2) 命主三角恋（分支B2）：**

触发条件（在该层天干集合中）：
- 日干本字 = Y（命主本身就是五合的一端）
- 出现X（能与日干Y构成五合的那一字）
- 同时还存在另一个配偶星Z（同类但不是X，且不要求能五合）
  - 女命：Z为另一颗官杀（比如乙日主，官杀=庚辛；若X=庚，则Z=辛）
  - 男命：Z为另一颗财星（比如庚日主，财=甲乙；若X=乙，则Z=甲）

打印文案：
- 女命：`婚恋变化提醒（如恋爱）：命主合两个官杀星，{合名}，注意，防止陷入三角恋`
- 男命：`婚恋变化提醒（如恋爱）：命主合两个财星，{合名}，注意，防止陷入三角恋`

**数据结构与输出位置：**

1. **原局层命中**：
   - 数据存储：添加到 `natal["hints"]` 列表中，格式为 `"婚恋结构提示：{hint_text}"`
   - CLI 输出：在独立的"—— 婚恋结构 ——" section 中打印，去除"婚恋结构提示："前缀，每条提示一行
   - 输出格式：与其他原局婚恋结构提示（如官杀混杂、正偏财混杂）合并，统一在"—— 婚恋结构 ——" section 中以列表形式展示

2. **大运层命中**：
   - 数据存储：添加到对应 `dayun_group["hints"]` 列表中
   - CLI 输出：打印在对应大运批注的最下面，每命中一条就打一行；若A与B同时命中，两行都打

3. **流年层命中**：
   - 数据存储：添加到对应 `year["hints"]` 列表中
   - CLI 输出：打印在对应流年批注的最下面（在"总危险系数"之前），每命中一条就打一行；若A与B同时命中，两行都打

**分层打印隔离规则：**

- 原局命中的提醒只打印在原局（"婚恋结构提示"那一块）
- 大运命中的提醒只打印在大运批注最下面
- 流年命中的提醒只打印在流年批注最下面
- 不要出现"原局有提醒 → 所有年份都打印"或"大运包含 → 所有流年都打印"的串层行为
- 流年层只检查流年天干是否引动（避免重复打印大运层已打印的提醒）

**举例：**

例1（女命乙日主，原局天干有辛；当原局/大运/流年天干集合里出现庚时）：
- 乙庚合成立，同时辛也在
- 触发分支B2：命主三角恋
- 打印：`婚恋变化提醒（如恋爱）：命主合两个官杀星，乙庚合，注意，防止陷入三角恋`

例2（同一年同时命中两条提醒）：
- 如果某年同时满足"他人争合"和"命主三角恋"的条件
- 则打印两行提醒，顺序建议先"被争合"再"三角恋"


---

### §4.6.9 Relationship Index (Index-5)：感情变动窗口白名单

**功能概述：**

Relationship Index (Index-5) 用于识别和汇总感情变动窗口，基于两类触发条件生成稳定的索引数据，供 Router 快速查询使用。

**触发条件（relationship_hit 判定规则）：**

Relationship Index 只由以下两类触发条件决定（任意命中即 `hit=true`）：

**A. 冲到婚姻宫/夫妻宫**

只要出现"冲"并且目标落点命中用户的婚姻宫/夫妻宫，就判定为感情变动窗口。

- **婚姻宫/夫妻宫定义**：
  - 月柱 = 婚姻宫
  - 日柱 = 夫妻宫
  - 使用项目中已定义的宫位口径（`PILLAR_PALACE`），复用现有字段/函数

- **检测逻辑**：
  - 检查流年与命局的冲（`liunian.all_events` 中的 `type="branch_clash"` 事件）
  - 检查冲事件的 `targets` 列表中是否包含 `pillar="month"` 或 `pillar="day"`
  - 如果命中，则标记该年为感情变动窗口，类型为 `palace_clash`

- **注意**：运年相冲（大运与流年相冲）不直接命中命局宫位，因此不纳入检测范围。

**B. 天干争合官杀或财星**

只要检测到"天干争合"事件，并且争合目标在十神分类里属于官杀（女命）或财星（男命），就判定为感情变动窗口。

- **争合定义**：
  - 必须是争合（`is_zhenghe=True`），不是普通1对1合
  - 争合中，`few_side`（少的一侧）是被争合的目标，`many_side`（多的一侧）是争合的一方

- **检测逻辑**：
  - 复用现有的 `gan_wuhe` 检测能力（`liunian.wuhe_events`）
  - 遍历所有五合事件，查找争合（`is_zhenghe=True`）
  - 检查 `few_side`（被争合的目标）的天干是否是配偶星 X（官杀/财星）
  - 使用 `marriage_wuhe.get_spouse_star_and_competitor()` 获取配偶星 X：
    - 女命：X = 官杀（例如：日主为木，X=庚）
    - 男命：X = 财星（例如：日主为木，X=己）
  - 验证十神类别：使用 `shishen.classify_shishen_category()` 验证 `few_side` 的十神是否为官杀（女命）或财星（男命）
  - 如果命中，则标记该年为感情变动窗口，类型为：
    - 女命：`competing_combine_official_kill`（天干争合官杀）
    - 男命：`competing_combine_wealth`（天干争合财星）

- **复用现有能力**：
  - 使用 `gan_wuhe.detect_gan_wuhe()` 的结果，不重复实现
  - 使用 `marriage_wuhe.get_spouse_star_and_competitor()` 获取配偶星映射
  - 使用 `shishen.classify_shishen_category()` 判断十神类别

**类型枚举值：**

Relationship Index 支持以下三种类型（在 `types` 列表中枚举，排序稳定）：

1. **`palace_clash`**：冲到婚姻宫/夫妻宫
2. **`competing_combine_official_kill`**：天干争合官杀（女命）
3. **`competing_combine_wealth`**：天干争合财星（男命）

**生成函数：**

- **函数**：`bazi/relationship_index.py::generate_relationship_index()`
- **参数**：
  - `luck_data`：`analyze_luck` 返回的 luck 数据
  - `bazi`：八字字典
  - `day_gan`：日主天干
  - `is_male`：是否为男性
  - `current_year`：当前年份（用于计算 `last5_hit` 和 `last5_years`），如果为 None 则使用当前系统年份

- **返回**：Relationship Index 字典（见 §1.6 数据结构说明）

**集成位置：**

- `bazi/lunar_engine.py::analyze_complete()`：在主入口函数的步骤 6-7 中生成 Relationship Index
- 返回结果：`facts["indexes"]["relationship"]`

**实现文件：**

- `bazi/relationship_index.py`：Relationship Index 生成逻辑
  - `generate_relationship_index()`：主生成函数
  - `_check_clash_hits_marriage_palace()`：检查冲是否命中婚姻宫/夫妻宫
  - `_check_competing_combine_hits_spouse_star()`：检查天干争合是否命中官杀/财星
  - `_is_marriage_palace()`：判断柱位是否是婚姻宫或夫妻宫

**输出口径约束：**

- **Overview 场景**：只提示"有感情变动窗口"，不展开原因
- **Detail 场景**：用户追问时才展开具体原因（使用 `relationship.types` 和 `relationship.years`）

---

## §5. 信息层增强：十神模式与静态冲刑识别

### §5.1 四柱宫位名称（统一说明）

在规则文档里明确写清四柱对应的"宫位"：

- **年柱** → 根基宫（家庭出身、早年环境）
- **月柱** → 婚姻宫
- **日柱** → **夫妻宫**（特别强调这一点）
- **时柱** → 事业家庭宫（工作 / 子女 / 后期家庭）

以后凡是在"冲 / 刑 / 模式提示"里出现"宫位"，都按这套映射来说明。

### §5.2 十神模式：枭神夺食 & 伤官见官（按配对计分）

先只引入两个模式：

1. **伤官见官**
   - 一端是「伤官」；
   - 一端是「正官」。

2. **枭神夺食**
   - 一端是「偏印（枭神）」；
   - 一端是「食神」。

**关键修正：必须是"明确的两点一线配对"，不能只是"同一堆里面有两个十神就算模式"。**

#### 5.2.1 配对规则（只干对干，只支对支）

1. **所有模式判断只在同一排里面配对**：

   - **天干只能和天干发生关系**  
     - 例：流年天干为伤官，大运天干为正官 → 这一对记作"伤官见官（天干层）"；
     - "流年天干伤官 + 命局地支正官"这种组合**不算**一对。

   - **地支只能和地支发生关系**（用地支主气对应的十神）  
     - 例：流年地支主气为食神，命局月支主气为偏印 → 这一对记作"枭神夺食（地支层）"；
     - "流年地支偏印 + 命局天干食神"这种组合**不算**一对。

2. **"一对"的定义**：

   - 一对 = 两个位置（position）：
     - pos1 = (source, pillar, kind, char, shishen)
     - pos2 = (source, pillar, kind, char, shishen)
   - 要求：
     - `kind` 必须相同（要么都是 "gan"，要么都是 "zhi"）；
     - `shishen` 组合满足其中一种：
       - 伤官见官：{pos1.shishen, pos2.shishen} = {"伤官", "正官"}
       - 枭神夺食：{pos1.shishen, pos2.shishen} = {"偏印", "食神"}

3. **不允许的情况**：
   - 不允许"天干 + 地支"混合起来凑一对模式；
   - 不允许只是"集合里同时存在伤官和正官"就算一个模式，必须明确是哪两个位置配对。

### §5.3 模式出现的三个层级：命局 / 大运 / 流年

对每一种模式（伤官见官、枭神夺食），分三个层级进行识别：

1. **命局层（静态）**

   - 范围：本命四柱的：
     - 四个天干；
     - 四个地支主气；
   - 只在干↔干、支↔支之间找配对，一旦发现一对：
     - 记录一条"原局模式"；
     - 保存参与这对的两个位置（pillar / kind / char / shishen）。
   - 命局层的模式**只用于展示，不直接加当年风险**。

2. **大运层（静态）**

   - 范围：本命四柱 + 当前大运：
     - 干排：命局四个天干 + 当前大运天干；
     - 支排：命局四个地支主气 + 当前大运地支主气。
   - 只在"天干这一排"内部、以及"地支这一排"内部配对：
     - 满足伤官+正官 或 偏印+食神的两两组合；
   - 至少有一个位置来自「大运本身」（source="dayun"），才算这一步大运带来的模式；
   - 大运层模式**用于展示本步大运的格局背景，不单独计入某一年的风险**。

3. **流年层（动态 + 计分）**

   - 范围：命局 + 当前大运 + 当前流年：
     - 干排：命局天干 + 大运天干 + 流年天干；
     - 支排：命局地支主气 + 大运地支主气 + 流年地支主气。
   - 只建立"包含流年位置"的配对：
     - 对每个"流年天干"位置，和所有其它天干位置配对；
     - 对每个"流年地支主气"位置，和所有其它地支主气位置配对；
     - 若两者 shishen 组合满足：
       - {"伤官", "正官"} → 一对伤官见官；
       - {"偏印", "食神"} → 一对枭神夺食；
     - 则这一对视为"本年被触发的一次模式"。
   - 流年层是**唯一真正计入该年 risk 的地方**：
     - 命局 / 大运只提供可以参与配对的静态点；
     - 只要配对里包含流年这一端，才为当年增加风险。

**总结：**  
> 只有"流年参与的配对"才加风险；  
> 命局 / 大运里即使有枭神夺食 / 伤官见官，如果流年没有参与的那一对，就只是静态信息。

### §5.4 枭神夺食 / 伤官见官：每一对的风险加成

当我们在**流年层**找到一对有效的"伤官见官 / 枭神夺食"时，这一对会给当年风险系数增加一个固定的百分比。

规则如下：

1. **默认规则：一对 = +15% 风险**

   - 不区分是"天干这排的配对"还是"地支这排的配对"；
   - 也不区分是枭神夺食还是伤官见官；
   - 只要有一对有效的模式，就按 15% 加一次。

2. **唯一例外：涉及"命局月支"的一对 = +25%**

   - 如果这一对当中，有一个位置是**命局的月支**（pillar="month", kind="zhi", source="natal"），  
     则这一对的风险加成改为**+25%**；
   - 其他所有位置（年支、日支、时支、大运支、流年支等）一律还是按 15% 算。

3. **同一个流年可能出现多对，风险可以叠加**

   - 比如：
     - 流年天干（伤官）和大运天干（正官）是一对 → +15%；
     - 同一个流年天干（伤官）又和命局月干（正官）是一对 → 再 +15%；
     - 流年地支（食神）和命局月支（偏印）又是一对 → 再 +25%。
   - 则该年模式总加成 = 15 + 15 + 25 = 55%（年度总风险不封顶，可>100）。

4. **静态层（命局 / 大运）不单独加分**

   - 即使命局单独就有枭神夺食 / 伤官见官，大运也单独有；
   - 若这一年流年没有参与任何一对模式配对 → 本年**不因为这些模式增加风险**；
   - 只是在命局部分、大运部分提示"这里存在这种格局"。

### §5.5 冲 / 刑 的静态标注规则

除了流年层面之前已有的冲 / 刑以外，现在要在"命局"和"大运"层面也标注出来：

1. **命局内部的冲 / 刑**
   - 范围：四柱地支之间的两两组合；
   - 冲：六冲（子午、丑未、寅申、卯酉、辰戌、巳亥）；
   - 刑：子卯、寅巳、巳申、申寅、辰戌、丑未。
   - **重要：辰未不属于刑**（以 `punishment.py` 的 `ALL_PUNISH_PAIRS` 表为准）。
   - 输出说明：标注哪两柱、哪两个字在冲 / 刑、对应的宫位名称。
   - **特别规则**：
     - 如果同一对地支"既是冲，又是刑"（例如辰戌这类），在输出中只记**冲**，不再额外输出"刑"；
     - 输出中不需要出现"墓库刑"四个字，只统一叫"刑"，或者直接不提这一对的"刑"。

2. **大运 + 命局之间的冲 / 刑**
   - 范围：每一步大运的地支，和四柱地支之间的组合；
   - 用同样的冲 / 刑规则识别；
   - 如果同一对既冲又刑，只输出冲，不输出刑，不提"墓库刑"。

3. **流年层面既有冲又有刑时的统一规则**
   - 对于同一对地支，如果判断出既有冲、又有刑，**以冲为准**：
     - 只保留"冲"的事件记录和输出；
     - 对应的"刑"事件可以不生成，或者生成后在汇总展示时过滤掉；
     - 同样不再额外打"墓库刑"标签。

**统一规则：**
- 同一对地支如果既符合"冲"又符合"刑"，输出时只按"冲"来算，不再额外记一条"刑"。
- 输出层面不再单独说"墓库刑"这四个字。

---

## §6. 流年天干/地支风险拆分与上半年/下半年运势判断

### §6.1 总原则：天干算天干的，地支算地支的

从本次改动开始，对于每一年的风险，我们要把**流年天干**和**流年地支**的贡献拆开计算：

- `risk_from_gan`：  
  只统计**因为"流年天干"参与**才产生的风险。
- `risk_from_zhi`：  
  只统计**因为"流年地支"参与**才产生的风险。

`total_risk_percent` 仍然保留用来综合显示（= risk_from_gan + risk_from_zhi + 其它），  
但"上半年/下半年 是 好运/一般/坏运"的判断**全部只看自己那一半**：

- 上半年运势：只看 `risk_from_gan` + 天干是不是用神；
- 下半年运势：只看 `risk_from_zhi` + 地支是不是用神。

其它来源（比如线运加成），也要按"由哪个侧触发"分别加到 gan 或 zhi 对应的 risk 中。

### §6.2 「冲 + 枭神夺食 / 伤官见官」的最终规则

1. **模式仍按之前规则检测：**

   - 只在同一排配对：
     - 天干 ↔ 天干；
     - 地支（主气） ↔ 地支（主气）。
   - 不能"干 + 支"混配。
   - 两种模式：
     - 伤官见官：一端「伤官」，一端「正官」；
     - 枭神夺食：一端「偏印」，一端「食神」。

2. **流年层面的模式计分（不与冲重合的那些）：**

   - 对所有"包含流年端"的配对：
     - 默认这一对模式加**15%**风险；
     - 如果这一对中包含「命局月支」（pillar="month", kind="zhi"），这一对改为**25%**；
   - 这些模式被算进：
     - 如果是流年天干配的 → 加到 `risk_from_gan`；
     - 如果是流年地支配的 → 加到 `risk_from_zhi`。

3. **关键特殊情况：同一对既是冲，又是模式**

   - 对某一对地支（例如卯酉）：
     - 它们首先按既有的规则算出「冲」的风险 `clash_risk_old`：
       - 基础冲；
       - 墓库冲加成；
       - 线运加成等。
     - 如果这对地支在十神上又满足：
       - 偏印 + 食神（枭神夺食），或
       - 伤官 + 正官（伤官见官），
     - 那么：  
       **不再为这对地支单独生成模式事件（不再 +15/25%），  
       而是在这条"冲"的 risk 上额外 +10%。**

     即：  
     `clash_risk_new = clash_risk_old + 10.0`

   - 这 +10% 属于**流年地支引起的风险**，计入 `risk_from_zhi`。

4. **展示要求（必须打印）**

   所有对 `total_risk_percent` 有贡献的东西，都要在 CLI 中打印出来。

   对于"既冲又是模式"的一对，展示建议如下：

   - 在"冲"部分打印：
     - `卯酉冲：基础冲 10.00%（+墓库加成 X%，+线运加成 Y%）`
   - 紧接着打印一行说明：
     - `同一对为枭神夺食，额外加成：+10.00%`
   - 这样用户一眼能看出：  
     - 有冲；  
     - 又是枭神夺食/伤官见官；  
     - 所以这条冲的风险被从 10% 提高到 20%。

### §6.3 流年天干（上半年）的「好运 / 一般 / 坏运」

#### 6.3.1 首先确定两个量

对某一年，关于**流年天干**，我们只关心：

1. **是不是用神**  
   - 用现有逻辑看流年天干五行是否属于当年用神五行集合 `yongshen_elements`。

2. **流年天干自己引起的风险 `risk_from_gan`**  
   只包含下列来源：

   - 流年天干参与的**枭神夺食 / 伤官见官（天干一排）**：
     - 按 15%/25% 记入；
   - 流年天干触发的**忌神**相关负面（后续会继续细化）；  
   - 任何其它"明确由流年天干作为触发端"的风险事件。  
   - **不包括** 地支引起的冲、刑、地支模式等。

#### 6.3.2 天干是用神时

如果流年天干五行 ∈ 用神五行集合：

- `risk_from_gan ≤ 15%`  
  → 上半年：**好运**

- `15% < risk_from_gan ≤ 30%`  
  → 上半年：**好坏都有**  
  （用神，但动得比较厉害）

- `risk_from_gan > 30%`  
  → 上半年：**坏运**  
  （虽然是用神，但天干这边变化过大、麻烦过多）

#### 6.3.3 天干不是用神时

如果流年天干五行 ∉ 用神五行集合：

- `risk_from_gan ≤ 15%`  
  → 上半年：**一般**  
  （非用神，但没惹出明显大事）

- `15% < risk_from_gan ≤ 30%`  
  → 上半年：**一般（有变动）**  
  （非用神，但引起了一些事件、变化）

- `risk_from_gan > 30%`  
  → 上半年：**坏运**  
  —— 这类通常就是：
  - 流年天干不是用神，
  - 又主动引动了枭神夺食、伤官见官，或者忌神特别强。

**注意：**  
坏运的判断**不再用 total_risk_percent**，而是只看 `risk_from_gan` 和"天干是不是用神"。

### §6.4 流年地支（下半年）的「好运 / 一般 / 坏运」

#### 6.4.1 流年地支自己的风险 `risk_from_zhi`

只统计**因为流年地支参与**而产生的风险，包括：

1. **冲**（以流年地支为一端的所有冲）：
   - 基础冲；
   - 墓库冲加成；
   - 线运加成（线运命中时 +6%）；
   - 如果这同一对又是枭神夺食 / 伤官见官 → 在这条冲基础上额外 +10%。

2. **刑**（以流年地支为一端的所有刑）：
   - 风险计算沿用现在的刑规则：
     - 普通刑：按"宫位力量"的 50%；
     - 月柱作为目标时：固定 10%；  
   - 这部分 risk 全部记入 `risk_from_zhi`。

3. **地支层面的枭神夺食 / 伤官见官**：
   - 流年地支 + 命局 / 大运地支的配对；
   - 只要不是与"冲"同一对重叠，就按 15%/25% 单独加在 `risk_from_zhi`。

#### 6.4.2 地支是用神时

如果流年地支五行 ∈ 用神五行集合：

- `risk_from_zhi ≤ 15%`  
  → 下半年：**好运**  
  （用神，冲刑等影响较轻）

- `15% < risk_from_zhi ≤ 30%`  
  → 下半年：**好坏都有**  
  （用神，但有明显变动——例如：线运内冲 10%+6%=16%，就落在这一档）

- `risk_from_zhi > 30%`  
  → 下半年：**坏运**  
  （用神但下半年动得太猛，风险远大于收益）

#### 6.4.3 地支不是用神时

如果流年地支五行 ∉ 用神五行集合：

- `risk_from_zhi ≤ 15%`  
  → 下半年：**一般**

- `15% < risk_from_zhi ≤ 30%`  
  → 下半年：**一般（有变动）**  
  （非用神且冲刑比较明显）

- `risk_from_zhi > 30%`  
  → 下半年：**坏运**  
  —— 这条和原话完全一致：  
  > "地支坏运是当流年地支引起的危险系数超过30%。  
  > 如果地支只引起15%以上，则按一般运。"

### §6.5 流年运势判词的总控逻辑（先看年总，再决定是否分半年）

流年运势判词采用新的总控逻辑：**先看总危险系数，再决定是否分上半年/下半年**。

#### 6.5.1 判词集合

固定为 5 个判词（逐字匹配）：
- 好运
- 一般
- 有轻微变动
- 明显变动（可克服）
- 凶（棘手/意外）

#### 6.5.2 年度标题行输出规则（核心：先看总危险系数）

记：
- Y = 总危险系数（百分数数值）
- H1 = 上半年危险系数（天干引起）
- H2 = 下半年危险系数（地支引起）
- is_yongshen_gan / is_yongshen_zhi：仍按已有用神五行判定（天干看天干五行；地支看主气藏干五行）

**A) 若 Y >= 40：**
- 年度标题行改为：`全年 凶（棘手/意外）`
- 且在风险块里新增一行建议（只在此条件出现）：
  ```
  建议：买保险/不投机/守法/不轻易辞职/控制情绪/三思后行
  ```

**B) 若 25 <= Y < 40：**
- 年度标题行改为：`全年 明显变动（可克服）`
- 不打印建议行（只有年总超过40%才打印）

**C) 若 Y < 25：**
- 才允许输出上/下半年计算
- 计算上半年判词 S1（只看 H1 和 is_yongshen_gan）：
  - 若 H1 <= 10：用神→好运；非用神→一般
  - 若 10 < H1 < 20：有轻微变动（不看用神）
  - 若 H1 >= 20：凶（棘手/意外）（不看用神）
- 计算下半年判词 S2（同理用 H2 和 is_yongshen_zhi）
- 年度标题行输出：`上半年 {S1}，下半年 {S2}`

**边界规则：**
- 先看 Y，只要 Y>=25 就"全年口径"
- 只有 Y<25 才输出半年口径
- 天克地冲不参与半年判词，只影响总危险系数数值

#### 6.5.3 年度整体标签（已废弃）

**注意：**  
原来的"年度整体标签"逻辑（基于上半年+下半年组合判断）已被新的总控逻辑替代。  
现在年度标题行直接由总危险系数 Y 决定，不再通过「上半年+下半年」来组合判断。

`total_risk_percent` 仍然可以保留显示和用于之前的**suggestion_level（normal / be_careful / strong_warning）**，  
但这套新判词逻辑优先于半年度组合逻辑。

### §6.6 CLI 输出要求：所有影响 total risk 的因素都要打印出来

在 `bazi/cli.py` 里，打印每一年流年时，需要确保：

1. **列出所有有风险贡献的事件：**

   - 冲（含基础冲、墓库加成、线运加成）；
   - 刑（以及这条刑对应的风险加成）；
   - 枭神夺食 / 伤官见官（不与冲重叠的那些单独模式）；
   - 冲+模式 同时出现时的"额外 +10%"必须单独指出；
   - 天克地冲（在冲的基础上额外 +10%）必须单独指出；
   - 线运加成（+6%）也应该有一行说明（例如"线运命中：+6.00%"）。

2. 每一类事件都要带上：

   - 哪两个字：例如"卯酉冲"、"子卯刑"；
   - 对应哪两个宫位：根基宫 / 婚姻宫 / 夫妻宫 / 事业家庭宫；
   - 对 total_risk 的数值加成：例如"墓库加成：+5.00%"、"刑加成：+5.00%"。

3. 对于"既冲又刑"的同一对地支：

   - 仍然沿用原先规则：**只视为冲**；
   - 不再单独打印"刑"的那一条，同时也不再为这对刑叠加风险。

4. 对于"既冲又是枭神夺食/伤官见官"的同一对：

   - 冲的风险照算；
   - 单独打印一行：
     - "该冲同时为枭神夺食/伤官见官，额外+10.00%"；
   - 不再为这对模式单独记 15/25%。

5. **流年输出中不显示年度整体标签**：

   - 删除「年度整体：XXX」这段文案，不再显示年度标签；
   - 只保留 "年份 + 干支 + 虚龄 + 总风险 + 上半年/下半年标签" 的信息。

---

## §7. 天克地冲逻辑（冲基础上 +10%）

### §7.1 定义

天克地冲 = 两个柱的地支互冲 + 两个柱的天干五行互相克，  
在原有"冲"的风险基础上，额外增加 +10% 风险，并在输出中标注出来"天克地冲"。

### §7.2 五行克制关系（用于天干互克）

使用传统五行克：

- 木克土
- 土克水
- 水克火
- 火克金
- 金克木

给定两个天干 gan1、gan2：

- e1 = GAN_WUXING[gan1]
- e2 = GAN_WUXING[gan2]

判定这两个天干"互克"的条件：

- KE_MAP[e1] == e2  或  KE_MAP[e2] == e1

只要单向成立（A 克 B 或 B 克 A），就认为"天干互相克"成立，不要求双向。

### §7.3 地支互冲条件

仍然用现有 `clash.py` 的冲规则（子午、丑未、寅申、卯酉、辰戌、巳亥等）。  
天克地冲只在**已经被认定为"冲"的那一对地支**上额外判定，不改变原有冲判定逻辑和冲的力量计算。

### §7.4 哪些组合需要检查天克地冲

需要检查的柱与柱组合：

1. **流年柱 vs 命局四柱**
2. **流年柱 vs 当前大运柱**
3. **大运柱 vs 命局四柱**（用于大运风险计算）

在已有"冲事件"基础上扩展：

- 每当你生成一条 clash 事件时，事件里已经包括：
  - 两个柱：source / pillar / gan / zhi / 宫位；
  - 冲的风险计算（基础冲 + 墓库加成 + 线运加成等）；
- 在这条 clash 事件上额外调用一个"天克地冲检查函数"：
  - 输入：两柱的 gan、zhi、source、pillar；
  - 条件：这对 zhi 互冲 + 天干五行互克；
  - 如果满足 → 标记为"天克地冲"，在冲的风险上额外 +10%。

### §7.5 风险数值：在冲的基础上额外 +10%

对一条已经算完 risk 的冲事件，假设原先是：

- `clash_risk_old`  = 基础冲风险  
  + 墓库加成  
  + 线运加成  
  + （如果同一对又是枭神夺食 / 伤官见官，则已经在冲上加了那 **额外 +10%**）

在满足"天克地冲"的情况下，再加一层：

- `clash_risk_new = clash_risk_old + 10.0`

这多出来的 10%：

- 属于**这一对冲事件本身的风险**；
- 如果是流年地支参与的冲，则计入：
  - `risk_from_zhi += 10.0`（对那一年的下半年风险有效）；
- 如果是大运地支参与的冲，则计入：
  - `risk_dayun_zhi += 10.0`（对这一步大运的风险有效）；

注意：

- 不改变 "地支力量百分比" 的算法，只增加风险；
- 与"冲 + 枭神夺食/伤官见官"的 +10% 可叠加：
  - 同一对地支：  
    - 既是冲；  
    - 又是枭神夺食/伤官见官（所以在冲上 +10%）；  
    - 又构成天克地冲（再 +10%）；  
  - 最终这条冲事件可能总共额外多出 20% 风险。

### §7.6 标记"哪个柱被天克地冲"

生成天克地冲时，需要记录"谁是被冲的柱"，以便 CLI 输出：

1. 如果是 「流年柱 vs 命局某柱」：
   - victim_source = "natal"
   - victim_pillar = 对应的 "year"/"month"/"day"/"hour"
   - 输出示例：
     - `天克地冲：命局 夫妻宫（日柱）被流年 壬辰 天克地冲，额外 +10.00%`

2. 如果是 「流年柱 vs 大运柱」：
   - victim_source = "dayun"
   - victim_pillar = "dayun"
   - 输出示例：
     - `天克地冲：本步大运 壬寅 被流年 壬辰 天克地冲，额外 +10.00%`

3. 如果是 「大运柱 vs 命局某柱」：
   - victim_source = "natal"
   - victim_pillar = 对应的 "year"/"month"/"day"/"hour"
   - 输出示例：
     - `天克地冲：命局 夫妻宫（日柱）被本步大运 壬寅 天克地冲，额外 +10.00%`

---

## §8. 大运好坏判定逻辑（重地支，用同一危险系数标准）

### §8.0 大运数量配置

**参数说明：**

`analyze_complete()` 和 `analyze_luck()` 函数支持 `max_dayun` 参数，用于控制计算的大运数量。

- **默认值**：`max_dayun = 10`
- **说明**：每个大运持续 10 年，默认计算 10 个大运（共 100 年）
- **可调整范围**：理论上可以设置任意数量，取决于 `lunar_python` 库返回的大运数量（通常足够多）
- **使用位置**：
  - `bazi/lunar_engine.py::analyze_complete()`：主入口函数参数
  - `bazi/luck.py::analyze_luck()`：大运分析函数参数
  - `bazi/cli.py::run_cli()`：CLI 调用时的参数

### §8.0.1 回归样本（golden inputs / outputs）

本项目的**唯一真相源叫 facts**（即 `compute_facts(...)` 的运行结果，等同于打印层展示的结构）。

回归测试只保存：
- **golden inputs**：固定生日输入（例如 `tests/regression/samples.json`）
- **golden outputs**：最终 API 统一返回壳（不保存第二套“facts 快照文件”）

### §8.1 总原则

本次重点是重新定义**每一步大运是"好运 / 一般 / 坏运"**的规则，不再使用"十年平均风险"一类的逻辑。

原则：

- 大运也用和流年一样的危险系数标准（0–15、15–30、30+）；
- **大运重地支**：判断好坏时，大运地支是核心；
- 在地支是用神且风险不高时，大运判为好运；
- 如果大运干支都是用神，还要特别标注"非常好运"。

### §8.2 大运危险系数的计算（risk_dayun_percent）

为每一条大运定义：

- `risk_dayun_zhi`：  
  由"大运地支参与的各种事件"产生的风险总和；
- `risk_dayun_gan`：  
  由"大运天干参与的各种事件"产生的风险总和；
- `risk_dayun_total = risk_dayun_zhi + risk_dayun_gan`。

这里的大运事件，主要是**大运柱 vs 命局四柱**的结构性关系（不包含具体某个流年的流年柱）：

- 大运地支 vs 命局地支：
  - 冲（含墓库冲加成、天克地冲额外 +10 等）；
  - 刑（按之前的刑规则）；
  - 枭神夺食 / 伤官见官（支排模式）；
- 大运天干 vs 命局天干：
  - 枭神夺食 / 伤官见官（干排模式）；
  - 若满足天克地冲（天干克+支冲），并加 10%。

注意：

- **大运 vs 流年**之间发生的冲、刑、天克地冲，是在具体流年里算的风险，不计入大运长期风险；
- 大运风险更像是"这十年本身格局对命局的长期压力"。

### §8.3 大运是否为用神

对于每一条大运：

- 根据 dayun_gan、dayun_zhi 的五行，结合用神五行集合 `yongshen_elements`，判断：
  - `is_dayun_zhi_yongshen`：大运地支五行 ∈ 用神；
  - `is_dayun_gan_yongshen`：大运天干五行 ∈ 用神。

### §8.4 大运好坏判定逻辑

使用和流年相同的阈值（0–15、15–30、30+），但规则改为：

#### 8.4.1 地支是用神的大运（重点）

如果 `is_dayun_zhi_yongshen == True`：

- 若 `risk_dayun_total < 30%`：  
  → 这一条大运整体判定为：**"好运"**（不再看平均十年，只看这一步大运自身结构的风险）。

- 若 `risk_dayun_total ≥ 30%`：  
  → 这一条大运整体判定为：**"坏运"** 或 "用神过激的大运"；  
    具体标签可以用 "坏运（用神过旺/变动过大）"。

额外标记：

- 如果同时 `is_dayun_zhi_yongshen == True` 且 `is_dayun_gan_yongshen == True`，并且 `risk_dayun_total < 30%`：
  → 在这条大运上额外打一个标记，比如文案中加一句：
  - "干支皆用神：非常好运的大运"。

#### 8.4.2 地支不是用神的大运

如果 `is_dayun_zhi_yongshen == False`：

- 若 `risk_dayun_total ≤ 15%`：  
  → 大运标签：**"一般"**（非用神，但风险不大）

- 若 `15% < risk_dayun_total ≤ 30%`：  
  → 大运标签：**"一般（有变动）"**  
  （非用神，同时结构性冲刑/模式比较多）

- 若 `risk_dayun_total > 30%`：  
  → 大运标签：**"坏运"**

总之：

- **大运好坏不再用"流年平均风险"来算，只用自身 dayun_total 风险 + 用神情况来判。**

### §8.5 大运输出格式（方案A结构层级）

在 `cli.py` 打印每一条大运时，采用以下结构化格式：

#### 8.5.1 大运标题行

```
【大运 2】 壬寅（起运年份 2009，虚龄 3 岁） → 好运  [大运危险：24.00%]
  （若干支皆用神，则再加一句：干支皆用神：非常好运的大运）
```

#### 8.5.2 大运十神打印（结构化）

在标题行之后，立即打印大运的十神信息，采用"方案A结构层级"：

**大运主轴（地支定调）：**
```
        大运主轴（地支定调）：
        地支 <支>｜十神 <十神>｜用神 <是/否>｜标签：...
```

**天干补充（不翻盘）：**
```
        天干补充（不翻盘）：
        天干 <干>｜十神 <十神>｜用神 <是/否>｜标签：...
```

**规则说明：**
- 主轴永远是地支那行，天干永远在"补充"段落里
- 不再使用80/20权重数字
- 用神判定/十神/标签词库完全沿用流年那套（地支用主气藏干）
- 十神计算：天干直接计算；地支使用主气藏干计算十神

#### 8.5.3 大运转折点标记

如果该步大运是转折点，在提示汇总区打印（作为提示汇总的第一条）：

```
        这是大运转折点：<年份> 年：<from_state> → <to_state>（<change_type>）
```

**转折点定义：**
- 只看大运地支决定的"好运/一般"状态变化
- 一般 → 好运：转好
- 好运 → 一般：转弱
- 使用发生转折的那步大运的起始年份

**打印位置：**
- 转折点标记直接打印在发生转折的那步大运块内的提示汇总区
- 作为提示汇总区的第一条（紧跟定调区之后）
- 不单独列出转折点列表

#### 8.5.3.1 原局模块中的大运转折点汇总

在原局模块的「— 原局问题 —」下方新增「— 大运转折点 —」section，作为汇总展示。

**打印位置：**
- 在原局问题块内容结束之后
- 在进入大运模块（出现 【大运）之前

**打印格式：**
- 标题行（固定）：`— 大运转折点 —`
- 内容行：
  - 如果存在转折点：每个转折点独立一行，格式：`YYYY 年：X → Y（转好/转弱）`
  - 如果没有任何转折点：打印一行 `无转折点`

**数据来源：**
- 复用现有 turning point 计算结果（同一套只看大运地支用神/非用神的规则）
- 转折点定义：
  - 一般→好运 = 转好
  - 好运→一般 = 转弱

**注意：**
- 该 section 每次都打印（即使无转折点也打印"无转折点"）
- 该 section 不替换、不去重、不合并现有"大运条目里紧跟的 turning point"打印
- 现有"大运条目里紧跟的 turning point"打印完全保持不变

#### 8.5.3.2 单条大运打印顺序

单条大运打印顺序固定为：**Header → 事实 → 定调（地支主轴/天干补充） → 提示汇总（含 turning point、用神互换等）**

**具体顺序：**

1. **Header**：`【大运 n】 干支 (起运年份, 虚龄) → 好运/一般 [干 元素 ✓/× / 支 元素 ✓/×]`

2. **事实区**：所有事实描述行（按现有顺序）
   - 大运六合
   - 大运半合
   - 大运完整三合局
   - 大运完整三会局
   - 大运天干五合
   - 命局冲（大运）
   - 天克地冲详细信息

3. **定调区**：
   - 大运主轴（地支定调）：+ 地支行
   - 天干补充（不翻盘）：+ 天干行

4. **提示汇总区**：
   - 这是大运转折点：...（turning point，第一条）
   - 【用神互换提示】...
   - 婚恋变化提醒（如恋爱）：...（大运层）

**注意：**
- turning point 文案/触发不变，只是归入提示汇总且优先显示（紧跟定调之后第一条）
- 用神互换提示也在提示汇总里
- 所有行的内容（文案、标点、括号、箭头、缩进）保持原样，只调整拼接顺序

#### 8.5.4 大运事件打印

在该大运下面打印该步大运参与的所有结构性事件（只看 dayun vs natal）：

1. **冲事件（大运支 ↔ 命局支）**
   - 冲：寅申冲（婚姻宫 ↔ 某宫位）
   - 基础冲：10.00%
   - 墓库加成：+5.00%（若有）
   - 若同一对又是枭神夺食/伤官见官：冲上再 +10.00%（保持现有逻辑）
   - 若这对又满足天克地冲：再 +10.00%
   - 最后这条冲对大运危险的贡献：XX.00%

2. **刑事件（大运支 ↔ 命局支）**
   - 刑：寅巳刑（某宫 ↔ 某宫）
   - 基础力量：XX.00%
   - 风险贡献：YY.00%（按之前刑的算法）

3. **三合/三会局打印**

   **大运完整三合局：**
   - 按三合局的顺序列出每个字的来源
   - 格式：`时柱（家庭事业宫）巳，大运 午，日柱（夫妻宫）未，巳午未三合火局。`
   - 用逗号连接各部分

   **大运完整三会局：**
   - 按三会局的顺序列出每个字的来源
   - **重要：不打印开头的"大运X"前缀**
   - 格式：`时柱（家庭事业宫）巳 大运 午 日柱（夫妻宫）未 巳午未三会火局。`
   - 用空格连接各部分

4. **枭神夺食 / 伤官见官（大运干/支 ↔ 命局干/支）**
   - 一对一列出：  
     - 例如：大运天干壬（偏印） + 命局时干丙（食神） → 枭神夺食，+15.00%  
     - 或涉及月支则 +25.00%

5. **天克地冲（大运 ↔ 命局）**
   - 例如：
     - `天克地冲：命局 夫妻宫（日柱）被本步大运 壬寅 天克地冲，额外 +10.00%`

所有这些事件的 risk 都要计入 `risk_dayun_zhi` / `risk_dayun_gan`，从而影响 `risk_dayun_total`，并最终决定这一步大运被标为"好运 / 一般 / 坏运"，以及是否加上"非常好运"的标签。

---

## §10. 刑（punishment）的新规则

### §10.1 只保留两种强度：普通刑 5%，墓库刑 6%

从现在起，所有"刑"的危险系数不再按宫位力量比例来算，统一改成固定值：

- **普通刑**：  
  - 任意非"墓库之间"的刑（比如寅巳刑、子卯刑等）  
  - `risk_percent = 5.0`（百分比）

- **墓库刑**：  
  - 刑的双方都是 **辰、戌、丑、未** 中的任意两个，但**不包括辰未组合**（辰未不刑）；  
  - 具体组合：辰戌、丑未（以 `punishment.py` 的 `GRAVE_PUNISH_PAIRS` 表为准）；  
  - `risk_percent = 6.0`

以后不再出现 "按 base_power_percent * 0.5" / "月柱刑按 10%" 等逻辑。  
刑的危险强度完全由"是否墓库刑"来决定，不看宫位力量。

### §10.2 base_power_percent 仍然可以保留但只用来展示

- 可以继续计算被刑宫位的 `base_power_percent`（这个数字对分析有用），  
- 但**不参与刑的 `risk_percent` 计算**，只在输出里展示。

### §10.3 与冲的关系

保持之前定的规则不变：

如果同一对地支同时满足"冲"和"刑"，  
→ 只按冲来算，不再单独生成刑事件（避免重复计分）。

也就是说，刑事件只在"纯刑、不同时又是冲"的组合上出现。

---

## §11. 线运加成调整：每年每根线运柱只加一次 +6%

### §11.1 线运定义保持不变

线运仍然按照命局 4 根地支来划分年龄段：

- 年柱地支：0–16 岁
- 月柱地支：17–32 岁
- 日柱地支：33–48 岁
- 时柱地支：49 岁以后

线运只对命局四支生效（year/month/day/hour 的地支），大运和流年自己的地支不算线运柱。

### §11.2 新规则：每年每柱最多只加一次 +6%

本命线运加成从现在起改为：

对于某一年，当某个命局地支所在的年龄段被触发时，不管这根柱上发生了多少事件（冲、刑、枭神夺食、伤官见官、天克地冲等），整个年份里这根柱只获得一次 +6% 的线运加成。

举例：

某年年龄在 20 岁：
- 对应线运柱 = 命局月支。
- 如果这一年，月支发生：
  - 被流年冲一次；
  - 又被大运冲一次；
  - 又有一组枭神夺食；

新规则：  
→ 不管发生几次，只要"月支这一柱有至少一个事件"，  
就给这根柱加一次 +6%，只记一次。

### §11.3 天干侧和地支侧分开计算

- 天干侧的事件（天干层模式）命中线运柱 → 天干侧线运加成 +6%
- 地支侧的事件（冲、刑、地支层模式）命中线运柱 → 地支侧线运加成 +6%

如果同一根柱既有天干侧事件又有地支侧事件，可能分别获得天干侧和地支侧的线运加成（各+6%）。

---

## §9. 静态十神模式被流年激活的逻辑

### §9.1 适用范围

本次逻辑只针对两种"坏力量"十神模式：

1. **伤官见官（hurt_officer）**
   - 一端：伤官
   - 一端：正官

2. **枭神夺食（pianyin_eatgod）**
   - 一端：偏印
   - 一端：食神

### §9.2 三层模式：原局 / 大运 / 流年

每一个模式类型 P ∈ {"hurt_officer", "pianyin_eatgod"}，在系统中存在三种层次：

1. **原局静态模式（natal）**
   - 命盘自己就带的模式
   - 例如：natal_patterns["hurt_officer"] = [pair1, pair2, ...]

2. **大运静态模式（dayun）**
   - 某一步大运的干支与命局干支形成的长期格局
   - 对每一条大运：dayun_patterns[dayun_index]["hurt_officer"] = [...]

3. **流年动态模式（liunian）**
   - 某一年，流年干/支与命局 / 当前大运形成的模式
   - 对每一年：liunian_patterns[year]["hurt_officer"] = [...]

### §9.3 静态模式被激活的三个必要条件

核心要求：

> 某一年，原局或大运中的一个静态模式 pair，要被视为被该年流年激活，必须同时满足：

1. **模式类型相同**
   - 都是伤官见官，或者都是枭神夺食
   - 伤官见官不能激活枭神夺食，反之亦然

2. **层级相同（kind 相同）**
   - 要么都是天干模式（kind == "gan"）
   - 要么都是地支模式（kind == "zhi"）
   - 不允许"天干枭神夺食"被"地支枭神夺食"激活，反之也不行

3. **具体两个字一模一样（顺序不要求一致）**
   - 静态 pair 是 (charA, charB)
   - 流年对应 pair 必须也是 {charA, charB} 这一对（集合意义相同，顺序可以不同）
   - 例如：
     - 静态：丁 + 辛
     - 流年：丁 + 辛 或 辛 + 丁 → 视为"同一对"
   - 如果静态是 丁 + 辛，而流年这一年是 乙 + 辛（也是伤官见官）
     → 不能算作"同一股力量"，该静态 pair 不被这一年的流年激活

只有同时满足这三条，静态那对才算在本年被引动。

### §9.4 处理步骤

对每一年 year、当前大运 dayun_idx、每种模式类型 P（"hurt_officer" / "pianyin_eatgod"）：

1. **先按 P 拿出三层的所有 pair**
   - natal_pairs_P = natal_patterns.get(P, [])
   - dayun_pairs_P = dayun_patterns_for_this_step.get(P, [])
   - liunian_pairs_P = liunian_patterns_for_this_year.get(P, [])

2. **按 kind 拆成干/支两层**
   - natal_gan_pairs_P / natal_zhi_pairs_P
   - dayun_gan_pairs_P / dayun_zhi_pairs_P
   - liunian_gan_pairs_P / liunian_zhi_pairs_P

3. **天干层激活规则**
   - 如果 len(liunian_gan_pairs_P) == 0：当年天干没有这个模式类型 P，原局和大运的天干层模式 P 全部保持"静态"，不算入当年风险
   - 如果 len(liunian_gan_pairs_P) > 0：对每一个流年天干 pair lp，在 natal_gan_pairs_P 和 dayun_gan_pairs_P 中找到所有静态 pair np 满足 set({np["char1"], np["char2"]}) == set({lp["char1"], lp["char2"]})
   - 静态 pair 只计一次，即使有多条流年 pair 都匹配到同一静态 pair

4. **地支层激活规则**
   - 规则完全一样，只是 kind == "zhi"

### §9.5 被激活的静态模式如何计算风险

#### 9.5.1 天干层静态激活风险

对模式 P 的天干层：
- 为每一对被激活的静态天干 pair 分配一个固定风险：**每对 pair 计 15% 风险**
- `static_risk_gan_P = 15.0 * (len(activated_natal_gan_pairs_P) + len(activated_dayun_gan_pairs_P))`
- 然后加入年度风险：
  - `risk_from_gan += static_risk_gan_P`
  - `total_risk_percent += static_risk_gan_P`

#### 9.5.2 地支层静态激活风险

对模式 P 的地支层：
- 基础：每对地支模式 P → **15%**
- 如果这对中包含命局月支地支（source="natal" 且 pillar="month" 且 kind="zhi" 的那个字参与这个 pair），则这一对 → **25%**
- `static_risk_zhi_P` 累加所有被激活的地支 pair 风险
- 然后加入年度风险：
  - `risk_from_zhi += static_risk_zhi_P`
  - `total_risk_percent += static_risk_zhi_P`

#### 9.5.3 模式 P 的总静态激活风险事件

为模式 P 创建一个汇总事件，包含：
- type: "pattern_static_activation"
- pattern_type: P
- risk_percent: static_risk_gan_P + static_risk_zhi_P
- risk_from_gan: static_risk_gan_P
- risk_from_zhi: static_risk_zhi_P
- activated_natal_gan_pairs / activated_dayun_gan_pairs / activated_natal_zhi_pairs / activated_dayun_zhi_pairs
- liunian_pairs_trigger_gan / liunian_pairs_trigger_zhi

注意：不要重复为流年模式 pair 计分，这些流年模式本身已经有各自的事件和风险计算规则。"静态激活"只为激活的静态 pair（原局 + 大运）再增加一段风险。

### §9.6 CLI 输出要求

当某种模式 P 有 pattern_static_activation 事件时，请按以下结构展示：

```
—— 本年十神模式：伤官见官 ——

流年触发：
  - 天干：流年丁（伤官） + 大运辛（正官）
  - （如果还有别的流年 pair，也列出来）

原局 / 大运同字模式被激活：
  - 原局已有 1 组伤官见官：丁 + 辛
  - 本步大运已有 1 组伤官见官：丁 + 辛

本年伤官见官总力量：
  - 同字组合 丁 + 辛 共 3 股（流年 1 + 原局 1 + 大运 1）
  - 本年因静态模式被激活额外增加风险：30.00%
```

要点：
- 明确区分："今年流年自己有哪些 P" 和 "原局 / 大运里有哪些同字同层的 P 被这一年激活"
- 数字要和实际计算一致：总股数 = 激活的静态 pair 数量 + 流年 pair 数量
- 风险数值 = 本次静态激活增加的 static_risk_gan_P + static_risk_zhi_P

---

## §12. Regression 测试用例

### §12.1 基础规则回归（main函数中运行）

1. **test_chenwei_not_punishment** - 辰未不刑规则（表级断言）
2. **test_chen_no_wei_target** - 辰不刑未的运行时断言
3. **test_traits_T1** - Traits 回归 T-1：2005-09-20 10:00 男
4. **test_traits_T2** - Traits 回归 T-2：2007-01-28 12:00 男
5. **test_yongshen_special_rule_wood** - 用神补木回归：2007-01-28 12:00
6. **test_yongshen_special_rule_fire** - 用神补火回归：2005-09-20 10:00
7. **test_lineyun_case_a** - 线运回归用例A：2005-09-20 10:00 男，2024年
8. **test_lineyun_case_b** - 线运回归用例B：2007-01-28 12:00 男，2022年
9. **test_harmonies_2005_09_20** - 合类事件回归：2005-09-20 10:00 男
10. **test_harmonies_2007_01_28** - 合类事件回归：2007-01-28 12:00 男
11. **test_sanhe_complete_2007_01_28** - 完整三合局检测回归：2007-01-28 12:00 男
12. **test_sanhui_complete_2005_09_20** - 完整三会局检测回归：2005-09-20 10:00 男

13. **test_global_element_distribution_case_A** - 全局五行占比回归用例A

14. **test_global_element_distribution_case_B** - 全局五行占比回归用例B

15. **test_marriage_suggestion_case_A** - 婚配倾向回归用例A：2005-09-20 10:00 男
    - 期望：用神五行（候选）独立一行，不包含婚配倾向
    - 期望：独立段落"—— 婚配倾向 ——"出现，包含"更容易匹配：虎兔蛇马；或 木，火旺的人。"
    - 防漏改：婚配倾向 section 不应包含"原局半合"、"原局六合"、"原局天干五合"
    - 防漏改：不应包含旧前缀"婚恋结构提示："

16. **test_marriage_suggestion_case_B** - 婚配倾向回归用例B：2007-01-28 12:00 男
    - 期望：用神五行（候选）独立一行，不包含婚配倾向
    - 期望：独立段落"—— 婚配倾向 ——"出现，包含"更容易匹配：猪鼠猴鸡虎兔；或 金，水，木旺的人。"
    - 防漏改：同用例A

17. **test_gan_wuhe_case_A** - 天干五合检测回归用例A

18. **test_gan_wuhe_case_B** - 天干五合检测回归用例B

19. **test_yongshen_swap_case_1969** - 用神互换回归用例：1969-02-07 00:00 男

20. **test_traits_format_case_A** - 性格打印格式回归用例A

21. **test_traits_format_case_B** - 性格打印格式回归用例B

22. **test_traits_new_format_case_A** - 性格新格式回归用例A

23. **test_traits_new_format_case_B** - 性格新格式回归用例B

24. **test_traits_new_format_case_C** - 性格新格式回归用例C：2006-3-22 14:00 女

25. **test_traits_new_format_case_D** - 性格新格式回归用例D：1972-12-20 4:00 男

26. **test_traits_new_format_case_E** - 性格新格式回归用例E

27. **test_liuqin_zhuli_case_A** - 六亲助力回归用例A

28. **test_liuqin_zhuli_case_B** - 六亲助力回归用例B

29. **test_liuqin_zhuli_case_C** - 六亲助力回归用例C

30. **test_natal_issues_format** - 原局问题打印格式回归测试
    - 验证原局问题 section 的格式和内容

31. **test_marriage_structure_hint** - 婚恋结构回归测试
    - 1990-5-26 8:00 女：断言输出包含独立 section "—— 婚恋结构 ——" 和内容"官杀混杂，桃花多，易再婚，找不对配偶难走下去"
    - 2007-1-11 2:00 男：断言输出包含独立 section "—— 婚恋结构 ——" 和内容"正偏财混杂，桃花多，易再婚，找不对配偶难走下去"
    - 防漏改：NOT contains "婚恋结构提示："

32. **test_natal_punish_zu_shang_marriage_explanation** - 原局刑解释回归测试：祖上宫-婚姻宫 刑
    - 2007-1-28 12:00 男：断言输出包含"祖上宫-婚姻宫 丑戌刑 成长过程中波折较多，压力偏大"（或相反顺序/地支顺序）

### §12.2 黄金回归用例（main函数后单独运行）

#### 例A（2005-09-20 10:00 男）

#### 例A（2005-09-20 10:00 男）

33. **test_golden_case_A_2021** - 2021年
    - 期望：总风险=65%（丑未冲35=10+5+20；运年相冲15=10+5；天克地冲20；墓库加成必须出现两次）

34. **test_golden_case_A_2033** - 2033年（已更新为包含三合/三会逢冲额外加分）
    - 期望：总风险70%
    - 丑戌冲 15%
    - 日柱天克地冲 20%
    - 新规则：巳午未三会里的未，冲了巳酉丑三合里的丑，额外 35%（两个字都在局/会里）

35. **test_golden_case_A_2059** - 2059年
    - 期望：core_total=203.5（不含线运）加上线运6% = 209.5

36. **test_golden_case_A_marriage_hints** - 婚姻宫/夫妻宫合事件提示断言
    - 2024年：辰酉合 合进婚姻宫 → 提示一次
    - 2025年：巳酉半合 合进婚姻宫 → 提示一次
    - 2026年：午未合 合进夫妻宫 → 提示一次
    - 验证：每年每宫位只提示一次

37. **test_golden_case_A_shishen_labels** - 十神标签回归测试

38. **test_golden_case_A_year_labels** - 流年标签回归测试

39. **test_golden_case_A_clash_summary** - 冲摘要回归测试

40. **test_golden_case_A_dayun_shishen** - 大运十神回归测试

41. **test_golden_case_A_turning_points** - 大运转折点回归测试

42. **test_golden_case_A_yongshen_swap_intervals** - 用神互换区间汇总回归测试
    - 验证原局模块中的用神互换区间汇总
    - 大运4（壬午，2029起）和大运5（辛巳，2039起）都触发用神互换
    - 应合并为区间：2029-2048年
    - 标题应为"—— 用神互换 ——"（统一格式）
    - 位置应在大运转折点之后、大运模块之前

43. **test_golden_case_A_dayun_printing_order** - 大运打印顺序回归测试
    - 验证单条大运打印顺序：Header → 事实 → 分隔线 → 主轴/天干 → 提示汇总
    - 验证缩进统一为4空格，分隔线位置正确

44. **test_golden_case_A_liuyuan** - 流年回归测试

45. **test_golden_case_A_tkdc_summary** - 天克地冲摘要回归测试

46. **test_golden_case_A_merge_clash_combo** - 合冲组合提示回归测试
    - 2023年：夫妻宫半合 + 婚姻宫冲 → 组合识别
    - 2009年：夫妻宫冲 + 婚姻宫半合 → 组合识别
    - 验证组合提示行只出现1次

#### 例B（2007-01-28 12:00 男）

47. **test_golden_case_B_2021** - 2021年
    - 期望：core_total=40（丑未冲25=10+5+10；运年相冲15=10+5；墓库加成必须出现两次）

48. **test_golden_case_B_2012** - 2012年（新增：包含三合/三会逢冲额外加分）
    - 期望：核心风险45%
    - 辰戌冲：基础冲20% + 墓库10%（5%×2个柱） = 30%
    - 新规则：寅午戌三合局被冲（辰戌冲），辰不是用神 → 额外 15%

49. **test_golden_case_B_2016** - 2016年（新增：包含三合/三会逢冲额外加分）
    - 期望：总风险80%
    - 运年天克地冲 20%
    - 寅申冲 10%
    - 寅申枭神夺食 15%
    - 新规则：寅午戌三合冲申，额外 35%（申是用神）

50. **test_golden_case_B_2030** - 2030年
    - 期望：core_total≈82（当前实现值，未单独扣除线运）（丑戌刑6+静态刑6=12；辰戌冲15+静态冲15+TKDC10=40，运年天克地冲再加10% = 50%，其余地支层风险合计约32）

51. **test_golden_case_B_shishen_labels** - 十神标签回归测试

52. **test_golden_case_B_2023** - 2023年回归测试

53. **test_golden_case_B_year_labels** - 流年标签回归测试

54. **test_golden_case_B_marriage_hints** - 婚姻宫/夫妻宫合事件提示断言（2007-1-18）
    - 注意：这是新的黄金案例B（2007-1-18），与之前的2007-1-28不同

55. **test_golden_case_B_clash_summary** - 冲摘要回归测试

56. **test_golden_case_B_turning_points** - 大运转折点回归测试

57. **test_golden_case_B_liuyuan** - 流年回归测试

58. **test_golden_case_B_tkdc_summary** - 天克地冲摘要回归测试

59. **test_golden_case_B_love_field_OLD** - 黄金案例B情感领域（旧格式）回归测试

#### 例C（用例C）

60. **test_golden_case_C_2025** - 2025年回归测试

61. **test_golden_case_C_turning_points** - 大运转折点回归测试

62. **test_case_C_new_format** - 用例C新格式回归测试

### §12.3 原局问题回归用例（main函数后单独运行）

63. **test_natal_punishment_case_A** - 原局刑回归用例A：2005-09-20 10:00，酉酉自刑（只有1个，5%）

64. **test_natal_punishment_case_A_output** - 原局刑输出格式回归测试

65. **test_natal_punishment_case_2026** - 原局刑2026年回归测试

66. **test_natal_punishment_case_B** - 原局刑回归用例B：2007-01-28 12:00，丑戌刑两次（各6%，共12%）

67. **test_marriage_wuhe_hints_case_A** - 天干五合争合/双合婚恋提醒回归用例A：2006-3-22 14:00 女
    - 原局：应识别1次（在"—— 婚恋结构 ——" section 里出现一行，包含被争合或命主合两个之一；并包含具体合名）
    - 流年2026：应识别1次，断言包含第三者介入，并包含合名
    - 流年2021：应识别1次，断言包含第三者介入，并包含合名

68. **test_marriage_wuhe_hints_case_B** - 天干五合争合/双合婚恋提醒回归用例B：2006-12-17 12:00 男
    - 流年2025：应识别1次，断言包含第三者介入，并包含合名
    - 流年2035：应识别1次（若是争合则断言第三者介入；若是双合则断言三角恋；并包含合名）

69. **test_marriage_wuhe_hints_case_C** - 天干五合争合/双合婚恋提醒回归用例C：1984-9-20 4:00 女
    - 流年2022：断言包含防止陷入三角恋，并包含合名
    - 流年2037：断言包含第三者介入，并包含合名
    - 大运2：在"大运批注最下面"断言包含防止陷入三角恋，并包含合名

70. **test_marriage_wuhe_hints_no_false_positive** - 天干五合争合/双合婚恋提醒回归测试（无引动不触发）
    - 2006-3-22 14:00 女在2080和2079年不能打印婚恋提醒（因为没有引动）

71. **test_marriage_wuhe_hints_dayun_no_duplicate** - 天干五合争合/双合婚恋提醒回归测试（大运层不重复打印）
    - 2006-12-17 12:00 男在大运6里：
      - 2055年应该打印（流年天干引动）
      - 2054年不应该打印（只有大运引动，没有流年引动）
      - 2057年不应该打印（只有大运引动，没有流年引动）

72. **test_marriage_wuhe_hints_dual_hints** - 天干五合争合/双合婚恋提醒回归测试（同一年两条提醒）
    - 1996-6-13 10:00 女
    - 如果2040年流年层有提醒，则必须同时出现两条提醒（被争合 + 三角恋），且不串层
    - 如果2030年流年层有提醒，则必须同时出现两条提醒（被争合 + 三角恋），且不串层

### §12.4 用神互换回归用例（main函数后单独运行）

73. **test_yongshen_swap_intervals_no_swap** - 用神互换区间汇总回归测试：无互换时不显示section
    - 使用一个不会触发用神互换的用例（1969-02-07 00:00 男）
    - 验证：无互换时不应出现"—— 用神互换 ——" section

### §12.5 大运转折点回归用例（main函数后单独运行）

74. **test_turning_points_summary_format** - 原局模块大运转折点汇总格式测试
    - 验证大运转折点汇总 section 的格式和内容

### §12.6 Relationship Index 回归用例（main函数后单独运行）

75. **test_relationship_index_structure** - Relationship Index 结构回归测试
   - 断言：`facts["indexes"]["relationship"]` 存在且包含所有必需字段
   - 断言：`hit`、`types`、`years`、`last5_hit`、`last5_years` 字段类型正确
   - 断言：`types` 列表只包含允许的值（`palace_clash`、`competing_combine_official_kill`、`competing_combine_wealth`）
   - 断言：`years` 和 `last5_years` 列表已排序（升序）

76. **test_relationship_index_palace_clash** - Relationship Index 冲到婚姻宫/夫妻宫回归测试
   - 使用一个已知会触发冲到婚姻宫/夫妻宫的用例（例如：2005-09-20 10:00 男）
   - 断言：`relationship["hit"] == True`
   - 断言：`relationship["types"]` 包含 `palace_clash`
   - 断言：命中年份列表正确（例如：包含 2021、2023 等年份）

77. **test_relationship_index_competing_combine** - Relationship Index 天干争合官杀/财星回归测试
   - 使用一个已知会触发天干争合官杀/财星的用例
   - 断言：`relationship["hit"] == True`
   - 断言：`relationship["types"]` 包含对应的争合类型（`competing_combine_official_kill` 或 `competing_combine_wealth`）
   - 断言：命中年份列表正确
   - 断言：只检测争合（`is_zhenghe=True`），不检测普通1对1合

78. **test_relationship_index_last5_years** - Relationship Index 近5年回归测试
   - 使用一个已知的用例（例如：当前年份为 2024），验证 `last5_hit` 和 `last5_years` 的计算逻辑
   - 断言：`last5_years` 只包含当前年份往前推5年（不包括当前年份）的年份（例如：2024 年时，只包含 [2019, 2020, 2021, 2022, 2023]）
   - 断言：`last5_hit == (len(last5_years) > 0)`
   - 断言：`last5_years` 列表已排序（升序）

79. **test_relationship_index_golden_case_A** - Relationship Index 黄金案例A回归测试
   - 2005-09-20 10:00 男：验证 Relationship Index 的完整功能
   - 断言：`relationship["hit"] == True`
   - 断言：`relationship["types"]` 包含 `palace_clash` 和 `competing_combine_wealth`
   - 断言：`relationship["years"]` 包含预期的年份（例如：2009, 2011, 2021, 2023 等）
   - 断言：`relationship["last5_hit"] == True`（假设当前年份 >= 2024）
   - 断言：`relationship["last5_years"]` 包含近5年的命中年份

### §12.7 其他回归用例（main函数后单独运行）

80. **test_event_area_no_hints** - 事件区不应包含提示行回归测试
   - 通用断言：事件区不应出现以"提示："开头的行
    - 测试多个代表性年份，验证提示行只在"提示汇总："区域出现

---

**总计：80个 regression 用例（随功能增加而更新）**
- main函数中运行：32个（基础规则 + 合类/婚配/原局打印/格式测试等）
- main函数后单独运行：48个（黄金回归用例 + 原局问题 + 天干五合婚恋提醒 + 用神互换 + 大运转折点 + Relationship Index + 其他）

---

## §13. 性格天赋卡规则（Talent Cards）

> **更新日期**：2026-01-18
> **打印层** = 唯一真理，天赋卡只在"主要性格"段输出，其他性格段不输出。

### §13.1 天赋卡设计思路

天赋卡是对五大十神类别（印星、财星、比劫、官杀、食伤）的性格特点进行详细阐述的文字块。每张天赋卡包含：

1. **共性行**：该类别所有档位通用的特点（1行）
2. **主卡**：根据正/偏配比选择的具体卡片（5行 × 5栏）
3. **补充句**（可选）：仅在混杂且一方主导时追加（1行）

### §13.2 五档判定规则（pian_ratio 阈值）

对于有正/偏之分的十神类别（印星、财星、官杀），根据"偏占比"(pian_ratio) 判定档位：

```
pian_ratio = 偏% / (正% + 偏%)
```

| 档位 | 条件 | 输出结构 |
|------|------|----------|
| **纯正** | 只有正（偏%=0） | 共性 + 正主卡 |
| **纯偏** | 只有偏（正%=0） | 共性 + 偏主卡 |
| **正主导** | pian_ratio ≤ 0.30 | 共性 + 正主卡 + 偏补充句 |
| **正偏各半** | 0.30 < pian_ratio ≤ 0.60 | 共性 + 融合版 |
| **偏主导** | pian_ratio > 0.60 | 共性 + 偏主卡 + 正补充句 |

### §13.3 主要性格判定规则

天赋卡**只在"主要性格"段输出**。主要性格的判定规则：

1. `total_percent >= 35.0`（力量占比≥35%）
2. `stem_hits >= 2`（透干次数≥2）
3. `stem_hits >= 1 && is_yongshen`（透干≥1次且为用神）

满足以上任一条件即进入主要性格，否则进入其他性格（不输出天赋卡）。

### §13.4 印星天赋卡

**共性**：
```
印星共性：重理解、重支撑、重体系感，也重思想与认知；更吃「认同/资源/老师/环境/长辈」的加成。
```

**正印主卡（5栏）**：
- 思维天赋：耐心、坐得住，学习能力强；更擅长循序渐进，把基础打牢再往上搭。
- 社交天赋：仁慈、善良、乐善好施、守规矩；给人可靠、讲原则、值得信任的感觉。
- 兴趣取向：更偏经典与主流体系，喜欢有标准、有脉络、可验证的知识与方法。
- 生活方式：重秩序与稳定节奏，做事偏「稳、全、合规」，不喜欢失控感与无序变化。
- 提高方向：在守住原则的前提下更敢推进；避免过度求稳导致行动变慢，先做出一版再完善。

**偏印主卡（5栏）**：
- 思维天赋：善于从细节与碎片信息中抓规律，偏好把复杂问题「想通、想透」再行动；直觉与逻辑经常同时在线。
- 社交天赋：偏向独处充电，但在群体中察言观色能力强，能读懂气氛与他人真实情绪；更倾向少数深交而非广撒网。
- 兴趣取向：更容易被小众、偏门、非主流的事物吸引，研究欲强，追求独特路径与个人理解框架。
- 生活方式：讨厌低质量重复与不透明规则；对「做事的意义与方法」有独特追求，但容易把精力过多消耗在「想清楚/准备更充分」而不是「先交付一版」。
- 提高方向：多做事、少空想；先做后看，用行动校准；在不确定中保持坚定信念与节奏感。

**融合版（5栏）**：正偏各半时使用

**补充句**：
- 偏印补充：思绪更容易过深、喜欢钻牛角尖；也更容易被文学、艺术、玄学等偏门主题吸引。
- 正印补充：同时带一点求稳与守规则的底色，更愿意把事情做完整、做合规。

### §13.5 财星天赋卡

**共性**：
```
财星共性：重现实回报与资源分配，重价值交换与结果；对「钱、成本、性价比、生活质感」更敏感，也更在意体面与边界。
```

**正财主卡（5栏）**：
- 思维天赋：务实、稳健，适合长期积累的财富；更偏向「确定性与可持续」的路径，做事踏实肯干、一步一步把结果做出来。
- 社交天赋：偏可靠、讲信用、守边界；不靠花哨取胜，更擅长用稳定兑现与责任感建立信任，给人踏实感。
- 兴趣取向：更偏向稳定收益与看得见的成果（资产、技能、家庭责任、长期建设）；对规则与成本意识更强；关系倾向：感情/关系上更容易出现「多线选择窗口」或暧昧机会（统计口径：并行尝试的概率更高，男性更明显）。
- 生活方式：勤俭节约，重预算与秩序感；日常更踏实肯干，愿意靠持续投入换稳定回报；也容易出现两份工作/兼职的状态，但容易把自己绷得太紧。
- 提高方向：在稳的基础上保留弹性；适当允许享受与试错，不要因为过度谨慎错过窗口，同时别把压力全揽在自己身上。

**偏财主卡（5栏）**：
- 思维天赋：对机会、资源、交换关系很敏感，反应快、会算「值不值」；行动力强，有想法往往会立刻付诸行动，擅长在变化里抓窗口与优先级。
- 社交天赋：社交面更广，氛围感强，会表达、浪漫、大方；更擅长用互动与体面把关系推顺，让人感觉被照顾到。
- 兴趣取向：更容易对「钱、资源、交易、市场、人情世故、好东西」上心；对新鲜事物与现实结果反馈更敏感；关系倾向：感情/关系上更容易出现「多线选择窗口」或暧昧机会（统计口径：并行尝试的概率更高，男性更明显）。
- 生活方式：更愿意把生活过得有质感、有效率，出手相对爽快；欲望与比较心一旦失控，容易变成「越想要越焦虑」，现实压力随之放大；也容易出现两份工作/兼职的状态。
- 提高方向：把大方与热情放在「值得的人和事」上；注意开销与预算边界，先定原则与节奏，再谈投入与回报，避免被外界节奏牵着走。

**融合版（5栏）**：正偏各半时使用

**补充句**：
- 偏财补充：同时带一点机会嗅觉与社交氛围感，出手更爽快、也更讲体面。

### §13.6 比劫天赋卡

> 比劫类别特殊：比肩/劫财共用同一张卡，不区分正偏。

**共性**：
```
比劫共性：重自我与主导权，重独立与对等；不喜欢被安排，遇到竞争更容易被点燃，关系里更在意尊重与边界。
```

**通用卡（比肩/劫财相同）**：
- 思维天赋：主见强、反应快，遇事更倾向自己拍板、自己承担；独立性强，但也更容易以自我立场为先，显得固执。
- 社交天赋：表面朋友可能多、圈子看起来热闹，但真心朋友往往偏少；因更「顾自己」的底色，不一定容易吸引同类/同行长期绑定，关系更容易停留在浅层互利或阶段性来往。
- 兴趣取向：更喜欢竞争、对抗、排名、PK、证明自己；同时常有某种抽象但难以言说的追求与执念，宁可按自己的标准走，也不太愿意随大流。
- 生活方式：强调自主与掌控感，讨厌被安排、被管束；遇到冲突更倾向硬顶或冷处理，不太爱解释。
- 提高方向：不要太自我、不要太固执，学会听劝；在关键选择上给他人意见一个入口，把「独立」从硬扛变成「能协作、能调整」。

### §13.7 官杀天赋卡

**共性**：
```
官杀共性：重规矩与责任，重秩序与边界；对「管束、标准、权威、对错」更敏感，也更在意形象与分寸。
```

**正官主卡（5栏）**：
- 思维天赋：稳健、讲章法，擅长在规则框架内把事情做到位；重逻辑与流程，对「合不合规」天然敏感。
- 社交天赋：端正、有分寸、重礼节；给人靠谱、守信、有底线的印象，擅长用可预期的方式建立信任。
- 兴趣取向：偏好有标准、有规矩、有评判体系的领域；对权威与主流路径的认同度更高。
- 生活方式：重秩序与节奏感，做事偏「稳、正、到位」；讨厌失控与越界，容易对自己和他人有要求。
- 提高方向：在守规矩的同时允许灵活调整；避免过度拘束导致僵化，学会在合规的前提下抓重点。

**七杀主卡（5栏）**：
- 思维天赋：反应快、决断力强，遇事敢拍板、敢承压；行动导向明显，更习惯用结果说话。
- 社交天赋：气场硬、边界感强，不太喜欢被试探；给人「不太好惹」或「说一不二」的印象，但真认可的人会直接护短。
- 兴趣取向：偏好竞争性强、压力显现的领域；对挑战与对抗有天然兴趣，讨厌拖泥带水和无效内耗。
- 生活方式：强调效率与掌控感，讨厌被管太细或被人质疑；容易绷紧神经，但也更能扛压。
- 提高方向：把「硬」转化为「稳」；在坚持原则的同时学会柔性沟通，避免把对抗变成常态。

**融合版（5栏）**：正官七杀各半时使用
- 思维天赋：既讲章法与规矩，也有决断力与行动力；「稳」和「狠」的两种处事方式并存。
- 社交天赋：既端正有分寸，也气场硬、边界感强；能靠靠谱建立信任，也能靠果断赢得尊重。
- 兴趣取向：一边认可规则与主流路径，一边对竞争与挑战有兴趣；既要「合规」，也要「出结果」。
- 生活方式：重秩序与节奏感，但也强调效率与掌控；容易在「守规矩」和「不想被管」之间拉扯。
- 提高方向：用规矩托住决断；在守住底线的前提下抓重点、敢行动，把「稳」和「狠」协调起来。

**补充句**：
- 七杀补充：同时带一点决断力与压迫感，遇事更敢拍板，边界感也更强。
- 正官补充：同时带一点守规矩与讲分寸的底色，给人更靠谱、有章法的感觉。

### §13.8 食伤天赋卡（待实现）

> 食伤类别（食神/伤官）的天赋卡暂未实现，后续补充。

### §13.9 天赋卡回归测试用例

| 用例 | 日期 | 性别 | 场景 | 验证点 |
|------|------|------|------|--------|
| 纯正官 | 1995-5-10 16:00 | 男 | 官杀在主要性格 | 共性+正官主卡，无补充 |
| 纯七杀 | 2000-2-14 16:00 | 男 | 官杀在主要性格 | 共性+七杀主卡，无补充 |
| 正官主导 | 1971-10-25 8:00 | 男 | pian_ratio=0.14 | 共性+正官主卡+七杀补充 |
| 七杀主导 | 1983-1-25 6:00 | 女 | pian_ratio=0.82 | 共性+七杀主卡+正官补充 |
| 官杀各半 | 2007-1-28 12:00 | 男 | pian_ratio=0.36 | 共性+融合版 |
| 其他性格不输出 | 1970-1-5 14:00 | 男 | 官杀在其他性格 | 不输出官杀天赋卡 |

---

## §14. 流年提示汇总区打印规则（2026-01-25 更新）

### §14.1 提示汇总区打印顺序

流年提示汇总区的打印顺序由 `cli.py::_build_hint_summary_v2()` 控制，固定为：

1. **模式** (pattern)：伤官见官、枭神夺食
2. **天克地冲**：
   - 月柱/日柱天克地冲（通用提示）
   - 时柱天克地冲（搬家/换工作提示）
3. **冲/合**：
   - 有提示的冲（婚姻宫/夫妻宫 → 感情提示；事业家庭宫 → 搬家/换工作提示）
   - 有提示的合（婚姻宫/夫妻宫 → 宫引动提示）
4. **额外提示**：合冲同现
5. **风险管理选项**：总风险 >= 40% 时输出
6. **无提示的事实**：（无提示）冲/合（祖上宫、事业家庭宫合等）

### §14.2 时柱冲/时柱天克地冲规则

| 情况 | 输出格式 | 提示文案 |
|------|----------|----------|
| 时柱天克地冲 | `- 天克地冲（时柱）：流年 {gan}{zhi} × 命局时柱 {target_gan}{target_zhi}（事业家庭宫） → 提示：可能搬家/换工作。` | `_HOUR_TKDC_HINT` |
| 时柱被冲（无天克地冲） | `- 冲：{flow_zhi}{target_zhi}冲（事业家庭宫） → 提示：可能搬家/换工作。` | `_HOUR_CLASH_HINT` |

**互斥规则**：时柱天克地冲 > 时柱被冲。若已有时柱天克地冲，则时柱被冲不单独输出。

### §14.3 宫位提示映射

| 宫位 | 冲提示 | 合提示 |
|------|--------|--------|
| 婚姻宫 | 感情（单身：更易暧昧/受阻；有伴侣：争执起伏） | 婚姻宫引动（单身：更容易出现暧昧/推进；有伴侣：关系推进或波动） |
| 夫妻宫 | 感情（单身：更易暧昧/受阻；有伴侣：争执起伏） | 夫妻宫引动（单身：更容易出现暧昧/推进；有伴侣：关系推进或波动） |
| 事业家庭宫 | 可能搬家/换工作 | 无专属提示（显示为"无提示"） |
| 祖上宫 | 无专属提示（若有感情hint则抑制，否则"无提示"） | 无专属提示（显示为"无提示"） |

### §14.4 回归测试用例

| 用例 | 日期 | 年份 | 场景 | 验证点 |
|------|------|------|------|--------|
| 时柱天克地冲 | 2005-09-20 10:00 男 | 2031 | 辛亥年，时柱天克地冲 | 输出"天克地冲（时柱）...可能搬家/换工作" |
| 时柱被冲（无TKDC） | 2005-09-20 10:00 男 | 2043 | 癸亥年，时柱被冲但无天克地冲 | 输出"冲：亥巳冲（事业家庭宫）...可能搬家/换工作" |
| 月柱天克地冲 | 2005-09-20 10:00 男 | 2059 | 己卯年，月柱天克地冲 | 输出"天克地冲（月柱）...可能出现意外、生活环境剧变..." |

---

## 更新记录

| 日期 | 变更内容 |
|------|----------|
| 2026-01-25 | 添加 §14 流年提示汇总区打印规则；修复时柱天克地冲/时柱被冲提示；finished year detail report showing, about to build payload |
| 2026-01-18 | 添加 §13 性格天赋卡规则（印星/财星/比劫/官杀/食伤） |
| 2026-01-13 | 初版创建 |

