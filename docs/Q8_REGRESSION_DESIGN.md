# Q8 Regression Test Design

**创建时间**：2026-01-30
**目的**：为Q8功能创建regression基准测试

---

## 一、关键澄清

### 1.1 打印层是最终口径

**重要**：所有逻辑的最终口径在**打印层**，不是JSON或其他数据结构。

**为什么**：
- 打印层是用户调试的核心
- 所有数据最终会通过打印层展示
- Q8功能应该从打印层读取数据

**文件位置**：
- `bazi/cli.py` - 打印逻辑
- `tests/regression/snapshots/liunian_v2/*.txt` - 打印层快照

### 1.2 Q8输出的感情信号类型

**Q8应该输出**：
1. ✅ **地支配偶星**：`[感情] 缘分(地支): 易遇合适伴侣（良缘）`
   - **强调**：地支配偶星 = 遇到对的人，可以结婚
2. ✅ **天干配偶星**：`[感情] 缘分(天干): 暧昧推进`
   - 有缘分但不保证合适，档次和天干五合相同
3. ✅ **地支合**（六合/半合）：`[无提示] XXX宫被合: X X合/半合`
   - **说明**：合 = 能谈恋爱
   - **重要**：只看地支合，**不看天干五合**

**Q8不应该输出**：
1. ❌ **天干五合**：不算"合"
2. ❌ **冲**：冲一般不能谈成
3. ❌ **宫位引动**（单独的hints）：这是由合/冲引发的，不单独作为类型

---

## 二、案例数据（从打印层提取）

### 2.1 案例1：2005-9-20 10:00 男

**未来5年（2026-2031）感情信号**：

| 年份 | 地支配偶星 | 天干配偶星 | 地支合 | 备注 |
|-----|-----------|-----------|--------|-----|
| 2026 | ❌ | ❌ | ❌ | 无感情信号 |
| 2027 | ❌ | ❌ | ❌ | 无感情信号 |
| **2028** | ✅ | ❌ | ✅ 申巳合（半合） | **地支配偶星** + 地支半合 |
| **2029** | ✅ | ❌ | ✅ 酉巳半合 | **地支配偶星** + 地支半合 |
| **2030** | ❌ | ✅ | ❌ | **天干配偶星** |
| **2031** | ❌ | ✅ | ❌ | **天干配偶星** |

**打印层原始输出**（示例）：

**2028年**：
```
- HINTS -
[感情] 缘分(地支): 易遇合适伴侣（良缘）

- DEBUG -
[无提示] 事业家庭宫被合: 申巳合
```

**2029年**：
```
- HINTS -
[感情] 缘分(地支): 易遇合适伴侣（良缘）

- DEBUG -
[无提示] 事业家庭宫被合: 酉巳半合
```

**2030年**：
```
- HINTS -
[感情] 缘分(天干): 暧昧推进
```

**2031年**：
```
- HINTS -
[感情] 缘分(天干): 暧昧推进
```

---

### 2.2 案例2：2006-12-17 12:00 男

**过去/当前5年（2020-2024）感情信号**：

| 年份 | 地支配偶星 | 天干配偶星 | 地支合 | 宫位引动 | 备注 |
|-----|-----------|-----------|--------|---------|-----|
| 2020 | ❌ | ❌ | ❌ | ❌ | （未检查）|
| 2021 | ❌ | ❌ | ❌ | ❌ | （未检查）|
| **2022** | ✅ | ❌ | ✅ 寅午半合 | ❌ | **地支配偶星** + 地支半合 |
| **2023** | ✅ | ❌ | ✅ 卯戌合（六合） | ❌ | **地支配偶星** + 地支六合 |
| **2024** | ❌ | ✅ | ✅ 辰子半合 | ✅ 婚姻宫被合 | **天干配偶星** + 地支半合 + 宫位引动 |

**打印层原始输出**（示例）：

**2022年**：
```
- HINTS -
[感情] 缘分(地支): 易遇合适伴侣（良缘）

- DEBUG -
[无提示] 事业家庭宫被合: 寅午半合
```

**2023年**：
```
- HINTS -
[感情] 缘分(地支): 易遇合适伴侣（良缘）

- DEBUG -
[无提示] 祖上宫被合: 卯戌合
```

**2024年**：
```
- HINTS -
[感情] 婚姻宫被合: 辰子半合 → 单身更容易暧昧/推进；有伴侣关系推进或波动
[感情] 缘分(天干): 暧昧推进

- DEBUG -
[无提示] 祖上宫被冲: 辰戌冲
```

---

## 三、Q8预期输出设计

### 3.1 案例1：2005-9-20 10:00 男（未来5年）

```
【未来5年感情运势】

⭐ 最有可能遇到对的人的年份（地支配偶星）：
- 2028年：地支配偶星（易遇合适伴侣（良缘））
  - 同时有地支合（申巳合）：能谈恋爱

- 2029年：地支配偶星（易遇合适伴侣（良缘））
  - 同时有地支合（酉巳半合）：能谈恋爱

📌 其他感情信号年份：
- 2030年：天干配偶星（暧昧推进）
- 2031年：天干配偶星（暧昧推进）

【婚配倾向】
[从 facts.natal.marriage_hint 提取]
```

### 3.2 案例2：2006-12-17 12:00 男（过去5年）

**注**：这是Q4的示例（过去感情）

```
【近5年感情状况】

⭐ 遇到对的人的年份（地支配偶星）：
- 2022年：地支配偶星（易遇合适伴侣（良缘））
  - 同时有地支合（寅午半合）：能谈恋爱

- 2023年：地支配偶星（易遇合适伴侣（良缘））
  - 同时有地支合（卯戌合）：能谈恋爱

📌 其他感情信号年份：
- 2024年：天干配偶星（暧昧推进）
  - 同时有地支合（辰子半合）：能谈恋爱
  - 婚姻宫被合：容易暧昧/推进

【婚配倾向】
[从 facts.natal.marriage_hint 提取]

【婚恋结构】
[从 facts.natal.marriage_structure 提取]
```

---

## 四、Relationship Index增强需求

### 4.1 需要检测的类型

基于打印层的发现，Relationship Index需要检测：

1. ✅ **地支配偶星**：
   - 检测规则：流年地支主气是配偶星（男财星，女官杀）
   - 提示文案：`"缘分(地支): 易遇合适伴侣（良缘）"`
   - **Index类型**：`spouse_star_in_zhi`

2. ✅ **天干配偶星**：
   - 检测规则：流年天干是配偶星（男财星，女官杀）
   - 提示文案：`"缘分(天干): 暧昧推进"`
   - **Index类型**：`spouse_star_in_gan`

3. ✅ **地支六合**：
   - 检测规则：地支六合（子丑、寅亥、卯戌、辰酉、巳申、午未）
   - DEBUG输出：`"XXX宫被合: X X合"`
   - **Index类型**：`zhi_liuhe_combine`

4. ✅ **地支半合/三合**：
   - 检测规则：地支半合、三合
   - DEBUG输出：`"XXX宫被合: X X半合"`
   - **Index类型**：`zhi_banhe_combine`

5. ❌ **天干五合**：**不检测**（不算"合"）

6. ❌ **冲到婚姻宫/夫妻宫**：已有，但**Q8不输出**

### 4.2 Index返回结构增强

```python
{
    "hit": bool,
    "types": [
        "palace_clash",                    # 已有：冲到婚姻宫/夫妻宫
        "competing_combine_official_kill", # 已有：天干争合官杀
        "competing_combine_wealth",        # 已有：天干争合财星
        "spouse_star_in_gan",              # 新增：天干配偶星
        "spouse_star_in_zhi",              # 新增：地支配偶星
        "zhi_liuhe_combine",               # 新增：地支六合
        "zhi_banhe_combine",               # 新增：地支半合/三合
    ],
    "years": [年份列表],
    "years_by_type": {                     # 新增：按类型分组
        "palace_clash": [年份],
        "competing_combine": [年份],
        "spouse_star_in_gan": [年份],
        "spouse_star_in_zhi": [年份],       # Q8重点
        "zhi_liuhe_combine": [年份],        # Q8需要
        "zhi_banhe_combine": [年份],        # Q8需要
    },
    "last5_hit": bool,
    "last5_years": [近5年年份列表],
    "last5_years_by_type": {               # 新增：Q4需要
        "palace_clash": [年份],
        "competing_combine": [年份],
        "spouse_star_in_gan": [年份],
        "spouse_star_in_zhi": [年份],
        "zhi_liuhe_combine": [年份],
        "zhi_banhe_combine": [年份],
    },
}
```

---

## 五、实施步骤

### Step 1: 创建regression测试快照（立即）

**目的**：先创建预期输出的快照，作为测试基准

**文件**：
- `tests/regression/snapshots/q8_v1/case1_2005_male.txt`
- `tests/regression/snapshots/q8_v1/case2_2006_male.txt`

### Step 2: 增强Relationship Index（P0）

**文件**：`bazi/relationship_index.py`

**修改**：
1. 增加新的类型常量
2. 增加配偶星检测逻辑（复用enrich.py的逻辑）
3. 增加地支合检测逻辑（从all_events提取）
4. 增加 `years_by_type` 和 `last5_years_by_type` 字段

### Step 3: 实现Q8输出函数（P1）

**文件**：`bazi/questions/q8_meet_partner.py`（新建）

**逻辑**：
1. 从 `index.relationship.years_by_type` 提取未来年份
2. 区分地支配偶星（重点）和天干配偶星
3. 提取地支合年份
4. 从 `facts.natal.marriage_hint` 提取婚配倾向
5. 生成分层输出（遇到对的人 + 其他感情信号）

### Step 4: 实现Q4输出函数（P1）

**文件**：`bazi/questions/q4_past_relationship.py`（新建）

**逻辑**：
1. 从 `index.relationship.last5_years_by_type` 提取过去5年
2. 输出所有感情相关的年份和类型
3. 包含婚配倾向和婚恋结构

---

## 六、验证清单

### 6.1 打印层验证

- [x] 案例1的2028-2031年打印输出正确
- [x] 案例2的2022-2024年打印输出正确
- [ ] 地支合在DEBUG区块正确显示
- [ ] 配偶星hints在HINTS区块正确显示

### 6.2 Index验证（✅ 2026-01-31 已实现）

- [x] Relationship Index能检测地支配偶星（`spouse_star_in_zhi`）
- [x] Relationship Index能检测天干配偶星（`spouse_star_in_gan`）
- [x] Relationship Index能检测地支六合/半合（`zhi_liuhe_combine`, `zhi_banhe_combine`）
- [x] `years_by_type` 正确分组年份
- [x] `last5_years_by_type` 正确分组过去5年年份

### 6.3 Q8/Q4功能验证

- [ ] Q8能从Index提取未来年份
- [ ] Q8能区分地支配偶星和天干配偶星
- [ ] Q8能提取地支合年份
- [ ] Q4能从Index提取过去5年
- [ ] Q4输出婚配倾向和婚恋结构

---

## 七、重要提醒（✅ 2026-01-31 用户更新）

1. **打印层是最终口径** - 所有功能都应该从打印层验证
2. **只看地支合** - 天干五合不算"合"
3. **地支配偶星是最高层次** - Q8强调"遇到对的人，可以结婚"
4. **天干配偶星和地支合是同一层次** - 都是"能谈恋爱"（用户 2026-01-31 澄清）
5. **宫位引动不单独输出** - 它是由合/冲引发的副作用

---

## 八、下一步行动

1. ✅ 完成案例数据提取（已完成）
2. ✅ 理解打印层格式（已完成）
3. 🔜 创建regression测试快照
4. ✅ 增强Relationship Index（2026-01-31 已实现）
5. 🔜 实现Q8和Q4
6. 🔜 验证regression测试通过
