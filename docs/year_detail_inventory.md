# Year Detail 识别 + 阈值总清单

> **生成日期**：2026-01-25
> **版本**：v1.0

---

## 1. Entry Points & Data Flow

### 1.1 主要入口文件

| 文件 | 函数 | 职责 |
|------|------|------|
| `bazi/cli.py` | `main()` → `_run_year_scope()` | CLI 入口，处理 `--year` 参数时调用年份报告生成 |
| `bazi/cli.py` | `_print_liunian_block()` | 打印单个流年块（含提示汇总区） |
| `bazi/year_detail.py` | `generate_year_detail()` | 生成 year_detail 结构化数据 |
| `bazi/luck.py` | `analyze_luck()` | 核心排盘 + 好运/坏运 + 冲信息 |
| `bazi/enrich.py` | `enrich_liunian()` | 为流年数据补充 hints、wuhe_events、love_signals |

### 1.2 Data Flow

```
用户输入 (生日 + 年份)
       │
       ▼
cli.py::main() → analyze_complete()
       │
       ▼
lunar_engine.py::analyze_complete() → luck.py::analyze_luck()
       │
       ├─────────────────────────────────────────┐
       ▼                                         ▼
detect_branch_clash()                    detect_liunian_patterns()
detect_branch_punishments()              detect_flow_harmonies()
detect_sanhe_complete()                  detect_sanhui_complete()
       │                                         │
       └─────────────┬───────────────────────────┘
                     ▼
            luck.py: 汇总 all_events + 计算风险
                     │
                     ▼
            enrich.py::enrich_liunian() → 生成 hints[]
                     │
                     ▼
            year_detail.py::generate_year_detail()
                     │
                     ▼
            cli.py::_print_liunian_block() → 提示汇总区打印
```

---

## 2. Signals Inventory（信号清单）

### 2.1 Patterns（模式）

| Signal ID | 中文名 | 检测函数 | 风险系数 | 输出位置 |
|-----------|--------|----------|----------|----------|
| `hurt_officer` | 伤官见官 | `patterns.py::detect_liunian_patterns()` | 默认15%；若伤官是用神则10% | 提示汇总 |
| `pianyin_eatgod` | 枭神夺食 | `patterns.py::detect_liunian_patterns()` | 默认15%；若枭神是用神则10% | 提示汇总 |
| `pattern_static_activation` | 静态模式激活 | `luck.py` | 命局5%/组；大运5%/组 | 事件区 |

**提示汇总文案**：

| 模式 | 单次格式 | 多次格式 |
|------|----------|----------|
| 伤官见官 | `（{位置串}）引动伤官见官：{文案}` | `引发多次伤官见官：{文案}` |
| 枭神夺食 | `（{位置串}）引动枭神夺食：{文案}` | `引发多次枭神夺食：{文案}` |

**Hint 文案常量**（定义于 `cli.py`）：

```python
_HURT_OFFICER_HINT = "主特征｜外部对抗：更容易出现来自外部的人/权威/规则的正面冲突与摩擦。表现形式（仅类别）：口舌是非/名声受损；合同/合规/官非；意外与身体伤害；（女性）伴侣关系不佳或伴侣受伤。"

_PIANYIN_EATGOD_HINT = "主特征｜突发意外：更容易出现突如其来的变故与波折，打乱节奏。表现形式（仅类别）：判断失误/信息偏差→麻烦与灾祸；钱财损失；犯小人/被拖累；意外的身体伤害风险上升。"
```

---

### 2.2 Collisions（冲）

| Signal ID | 中文名 | 检测函数 | 风险系数 | 输出位置 |
|-----------|--------|----------|----------|----------|
| `branch_clash` | 流年与命局冲 | `clash.py::detect_branch_clash()` | 基础10%；墓库+5%；天克地冲+10% | 事件区 |
| `dayun_liunian_branch_clash` | 运年相冲 | `luck.py` | 基础10%；墓库+5%；运年天克地冲+20% | 事件区 |
| `static_clash_activation` | 静态冲激活 | `luck.py` | 基础风险的一半 | 事件区 |
| `tian_ke_di_chong` | 天克地冲 | `clash.py::_check_tian_ke_di_chong()` | 额外+10%（叠加在冲之上） | 提示汇总 |

**天克地冲提示汇总文案**：

| 情况 | 格式 |
|------|------|
| 单次 | `（{位置串}）引动天克地冲：{文案}` |
| 多次 | `引发多次天克地冲：{文案}` |

**Hint 文案常量**：

```python
_TKDC_HINT = "可能出现意外、生活环境剧变，少数情况下牵动亲缘离别。"
```

---

### 2.3 Hour Clash & Hour TKDC（时柱冲/时柱天克地冲）

| Signal ID | 中文名 | 检测函数 | 输出位置 |
|-----------|--------|----------|----------|
| `hour_clash_by_liunian` | 时柱被冲（无天克地冲时） | `cli.py::_build_hint_summary_v2()` | 提示汇总 |
| `hour_tkdc` | 时柱天克地冲 | `cli.py::_build_hint_summary_v2()` | 提示汇总 |

**互斥规则**：时柱天克地冲 > 时柱被冲。若已有时柱天克地冲，则时柱被冲不单独输出。

**提示汇总格式**：

| 情况 | 格式 |
|------|------|
| 时柱天克地冲 | `- 天克地冲（时柱）：流年 {gan}{zhi} × 命局时柱 {target_gan}{target_zhi}（事业家庭宫） → 提示：可能搬家/换工作。` |
| 时柱被冲（无天克地冲） | `- 冲：{flow_zhi}{target_zhi}冲（事业家庭宫） → 提示：可能搬家/换工作。` |

**Hint 文案常量**：

```python
_HOUR_TKDC_HINT = "可能搬家/换工作。"
_HOUR_CLASH_HINT = "可能搬家/换工作。"
```

---

### 2.4 Amplifiers（增幅器）

| Signal ID | 中文名 | 检测函数 | 风险系数 | 触发条件 |
|-----------|--------|----------|----------|----------|
| `lineyun_bonus` | 线运加成 | `luck.py::_compute_lineyun_bonus()` | 天干侧6% + 地支侧6% | 单柱总风险 >= 10% |
| `sanhe_sanhui_clash_bonus` | 三合/三会逢冲加分 | `luck.py::_detect_sanhe_sanhui_clash_bonus()` | 35%（用神）或15%（非用神） | 当年有冲 + 三合/三会成立 |
| `clash_pattern_bonus` | 冲+模式重叠加成 | `luck.py` | +10%（叠加在冲之上） | 同一对地支既冲又模式 |

---

### 2.5 Relationship（感情信号）

| Signal ID | 中文名 | 来源 | 输出位置 |
|-----------|--------|------|----------|
| `liuyuan_gan` | 缘分（天干） | `enrich.py` | 提示汇总 |
| `liuyuan_zhi` | 缘分（地支） | `enrich.py` | 提示汇总 |
| `marriage_palace_clash` | 婚姻宫/夫妻宫被冲 | `enrich.py` | 提示汇总 |
| `marriage_palace_harmony` | 婚姻宫/夫妻宫被合 | `enrich.py` | 提示汇总 |
| `he_and_chong_coexist` | 合冲同现 | `enrich.py::_compute_love_signals()` | 提示汇总 |
| `marriage_wuhe_hints` | 天干五合婚恋提醒 | `marriage_wuhe.py::detect_marriage_wuhe_hints()` | 提示汇总 |

**提示汇总文案**：

| 信号 | 文案 |
|------|------|
| 缘分（天干） | `提示：缘分（天干）：暧昧推进` |
| 缘分（地支） | `提示：缘分（地支）：易遇合适伴侣（良缘）` |
| 婚姻宫/夫妻宫被冲 | `提示：感情（单身：更易暧昧/受阻；有伴侣：争执起伏）` |
| 婚姻宫/夫妻宫被合 | `提示：{宫位}引动（单身：更容易出现暧昧/推进；有伴侣：关系推进或波动）` |
| 合冲同现 | `提示：感情线合冲同现（进展易受阻/反复拉扯；仓促定论的稳定性更低）` |

---

### 2.6 Relocation（搬迁/工作变动）

| Signal ID | 中文名 | 触发条件 | 输出位置 |
|-----------|--------|----------|----------|
| `hour_clash_hint` | 时支被流年冲 | 流年地支冲时支 | 提示汇总 |
| `hour_tkdc_hint` | 事业家庭宫天克地冲 | 天克地冲命中时柱 | 提示汇总 |
| `family_change_hint` | 家庭变动 | 事业家庭宫被冲（且无时柱天克地冲） | 提示汇总 |
| `dayun_liunian_tkdc_hint` | 运年天克地冲 | 大运与流年天克地冲 | 提示汇总 |

**提示汇总文案**：

| 信号 | 文案 |
|------|------|
| 时支被流年冲 | `（时支{zhi}/流年{zhi}）时支被流年冲：可能搬家/换工作。` |
| 事业家庭宫天克地冲 | `提示：事业家庭宫天克地冲（工作变动概率上升/可能出现搬家窗口）` |
| 家庭变动 | `提示：家庭变动（搬家/换工作/家庭节奏变化）` |
| 运年天克地冲 | `提示：运年天克地冲（家人去世/生活环境变化剧烈，如出国上学打工）` |

---

### 2.7 Advice（建议信号）

| Signal ID | 中文名 | 触发条件 | 输出位置 |
|-----------|--------|----------|----------|
| `risk_management_advice` | 风险管理选项 | `total_risk_percent >= 40%` | 提示汇总 |

**提示汇总文案**：

```
风险管理选项（供参考）：保险/预案；投机回撤风险更高；合规优先；职业变动成本更高；情绪波动时更易误判；重大决定适合拉长周期
```

---

### 2.8 Meta（元信息）

| Signal ID | 中文名 | 来源 | 用途 |
|-----------|--------|------|------|
| `year` | 年份 | `liunian["year"]` | 标识 |
| `gan` / `zhi` | 流年干支 | `liunian` | 天干块 / 地支块 |
| `gan_shishen` / `zhi_shishen` | 流年十神 | `luck.py` | 天干块 / 地支块 |
| `is_gan_yongshen` / `is_zhi_yongshen` | 是否用神 | `luck.py` | 天干块 / 地支块 |
| `risk_from_gan` / `risk_from_zhi` | 天干/地支风险 | `luck.py` | 风险拆分 |
| `total_risk_percent` | 总风险 | `luck.py` | 整体风险评估 |

---

## 3. Thresholds Inventory（阈值清单）

### 3.1 开始/后来等级判定

**判定逻辑**（定义于 `year_detail.py::_compute_half_year_grade()`）：

#### 开始（天干侧）

| 条件 | 等级 |
|------|------|
| `start_good == None` | 变动 |
| `start_good == True` 且 `risk_from_gan <= 20` | 好运 |
| `start_good == True` 且 `risk_from_gan > 20` | 一般 |
| `start_good == False` 且 `risk_from_gan <= 30` | 一般 |
| `start_good == False` 且 `risk_from_gan > 30` | 凶 |

#### 后来（地支侧）

| 条件 | 等级 |
|------|------|
| `later_good == None` | 变动 |
| `later_good == True` 且 `risk_from_zhi <= 20` | 好运 |
| `later_good == True` 且 `risk_from_zhi > 20` | 一般 |
| `later_good == False` 且 `risk_from_zhi <= 30` | 一般 |
| `later_good == False` 且 `risk_from_zhi > 30` | 凶 |

---

### 3.2 大运好坏判定

**判定逻辑**（定义于 `luck.py`）：

| 条件 | 标签 |
|------|------|
| 地支是用神 且 `risk_dayun_total < 30` | 好运 |
| 地支是用神 且 `risk_dayun_total >= 30` | 坏运（用神过旺/变动过大） |
| 地支非用神 且 `risk_dayun_total <= 15` | 一般 |
| 地支非用神 且 `15 < risk_dayun_total <= 30` | 一般（有变动） |
| 地支非用神 且 `risk_dayun_total > 30` | 坏运 |

---

### 3.3 流年好运判定

**判定逻辑**（定义于 `luck.py`）：

| 条件 | is_good |
|------|---------|
| `(gan_good OR zhi_good)` 且 `total_risk_percent <= 15` | True |
| 其他 | False |

---

### 3.4 风险管理建议阈值

| 阈值 | 触发信号 |
|------|----------|
| `total_risk_percent >= 40` | `risk_management_advice` |

---

### 3.5 线运加成触发阈值

| 阈值 | 触发信号 |
|------|----------|
| 单柱总风险 >= 10% | 触发该侧（天干侧或地支侧）+6% |

---

### 3.6 风险系数常量

**定义于 `config.py`**：

| 常量名 | 值 | 说明 |
|--------|-----|------|
| `PATTERN_GAN_RISK_LIUNIAN` | 15.0 | 流年天干层模式每组 |
| `PATTERN_ZHI_RISK_LIUNIAN` | 15.0 | 流年地支层模式每组 |
| `PATTERN_GAN_RISK_STATIC` | 10.0 | 静态天干层模式每组 |
| `PATTERN_ZHI_RISK_STATIC` | 10.0 | 静态地支层模式每组 |
| `CLASH_NORMAL_RISK` | 10.0 | 普通冲 |
| `CLASH_GRAVE_RISK` | 15.0 | 墓库冲（辰戌丑未之间） |
| `STATIC_CLASH_NORMAL_RISK` | 5.0 | 静态普通冲（一半） |
| `STATIC_CLASH_GRAVE_RISK` | 7.5 | 静态墓库冲（一半） |
| `TIAN_KE_DI_CHONG_EXTRA_RISK` | 10.0 | 天克地冲额外风险 |

---

## 4. 提示汇总区打印顺序

**定义于 `cli.py::_build_hint_summary_v2()`**：

1. **模式** (pattern)：伤官见官、枭神夺食
2. **天克地冲**：月柱/日柱天克地冲（通用提示）→ 时柱天克地冲（搬家/换工作提示）
3. **冲/合**：
   - 有提示的冲（婚姻宫/夫妻宫 → 感情提示；事业家庭宫 → 搬家/换工作提示）
   - 有提示的合（婚姻宫/夫妻宫 → 宫引动提示）
4. **额外提示**：合冲同现
5. **风险管理选项**：总风险 >= 40% 时输出
6. **无提示的事实**：（无提示）冲/合（祖上宫、事业家庭宫合等）

---

## 5. Gap Report（缺口报告）

### 5.1 MISSING_HINT（有 Evidence 但无 Hint）

| Evidence | 当前状态 | 建议 |
|----------|----------|------|
| `branch_punishment` | 只计风险，无专属提示 | 考虑添加「刑」相关提示 |
| `sanhe_complete` / `sanhui_complete` | 只在事件区展示，无提示 | 考虑添加三合/三会成局提示 |
| `static_clash_activation` | 只计风险，无专属提示 | 考虑添加静态冲激活提示 |
| `static_punish_activation` | 只计风险，无专属提示 | 考虑添加静态刑激活提示 |

---

### 5.2 MISSING_EVIDENCE（有 Hint 但无明确 Evidence 溯源）

| Hint | 当前状态 | 建议 |
|------|----------|------|
| `婚恋变化提醒（如恋爱）` | 来自 `marriage_wuhe_hints`，但无 fact_id 链接 | 建议通过 FindingsCollector 建立 link |
| `缘分（天干）/缘分（地支）` | 直接基于十神判断，无 fact_id | 考虑创建 fact 记录十神信号 |

---

### 5.3 NOT_IN_HINT_SUMMARY（识别到但未进入提示汇总）

| Signal | 当前输出位置 | 是否应进入提示汇总 |
|--------|--------------|-------------------|
| `lineyun_bonus` | 事件区 | 否（增幅器，非主要提示） |
| `sanhe_sanhui_clash_bonus` | 事件区 | 否（增幅器） |
| `clash_pattern_bonus` | 事件区（叠加在冲上） | 否（已体现在模式提示中） |
| `dayun_patterns` | 大运块 | 否（大运层提示，非流年） |
| `branch_clash` 基础信息 | 事件区 | 部分（天克地冲单独提示） |

---

## 6. 附录：关键文件索引

| 文件 | 主要职责 |
|------|----------|
| `bazi/cli.py` | CLI 入口 + 打印逻辑 + pattern_hints 生成 |
| `bazi/luck.py` | 核心排盘 + 冲/刑/模式检测 + 风险计算 |
| `bazi/year_detail.py` | year_detail 结构化数据生成 |
| `bazi/enrich.py` | hints 生成 + love_signals + wuhe_events |
| `bazi/patterns.py` | 伤官见官 / 枭神夺食检测 |
| `bazi/clash.py` | 冲检测 + 天克地冲 |
| `bazi/punishment.py` | 刑检测 |
| `bazi/harmony.py` | 六合 / 三合 / 三会检测 |
| `bazi/marriage_wuhe.py` | 天干五合婚恋提醒 |
| `bazi/config.py` | 风险系数常量 + 映射表 |
| `bazi/findings_collector.py` | facts / hints / links 收集器 |

---

## 7. 更新记录

| 日期 | 版本 | 变更内容 |
|------|------|----------|
| 2026-01-26 | v1.2 | **打印层协议化**：year detail 已完成协议化格式（`- HINTS -` / `- DEBUG -` / `@` 结束符），LLM 信息与 Debug 信息分离；下一步：yun detail 和原局 detail 协议化；还需新增函数显示用神行业+大运变换期间的职业变化 |
| 2026-01-25 | v1.1 | 修复时柱天克地冲/时柱被冲提示；更新提示汇总打印顺序；finished year detail report showing, about to build a payload |
| 2026-01-25 | v1.0 | 初版创建 |

---

## 8. Regression Tests（回归测试）

### 8.1 测试配置

| 项目 | 值 |
|------|-----|
| 测试用例 | 2005-09-20 10:00 男 |
| 测试文件 | `tests/regression/test_liunian_v2_golden.py` |
| Snapshot 目录 | `tests/regression/snapshots/liunian_v2/` |

### 8.2 测试用例清单

共 **7 个** 流年 regression 测试：

| # | 年份 | 干支 | 测试场景 | 覆盖信号 |
|---|------|------|----------|----------|
| 1 | 2026 | 丙午 | H1 好运, H2 好运 | 午未合（夫妻宫） |
| 2 | 2031 | 辛亥 | 全年凶 - 时柱天克地冲 | `hour_tkdc`、搬家/换工作提示、三合/三会逢冲、`liuyuan_gan`（男命财星） |
| 3 | 2037 | 丁巳 | H1 好运, H2 好运 | 巳酉半合（婚姻宫+祖上宫） |
| 4 | 2038 | 戊午 | H1 有轻微变动, H2 好运 | `hurt_officer`（伤官见官）、午未合（夫妻宫） |
| 5 | 2043 | 癸亥 | 全年明显变动 - 时柱被冲（无天克地冲） | `hour_clash_hint`、运年相冲、搬家/换工作提示 |
| 6 | 2058 | 戊寅 | H1 一般, H2 好运 | 寅巳刑（事业家庭宫） |
| 7 | 2059 | 己卯 | 全年凶 - 枭神夺食 + 月柱天克地冲 | `pianyin_eatgod`、`tian_ke_di_chong`、卯酉冲、卯未半合、合冲同现、风险管理选项 |

### 8.3 Snapshot 详情

#### 8.3.1 year_2026.txt（好运年）

```
2026 年 丙午（虚龄 22 岁）：开始 好运，后来 好运
开始(H1)：天干 丙 | 劫财｜用神 是｜标签【重点】：自信独立/同辈助力/合伙资源/行动力
后来(H2)：地支 午 | 比肩｜用神 是｜标签【重点】：自信独立/同辈助力/合伙资源/行动力

提示汇总：
- 合：午未合（夫妻宫） → 提示：夫妻宫引动（单身：更容易出现暧昧/推进；有伴侣：关系推进或波动）

计算过程（Evidence / Debug，仅供开发者）：
        --- 总危险系数：0.0% ---
        天干 丙｜十神 劫财｜用神 是｜标签：自信独立/同辈助力/合伙资源/行动力
        - 开始危险系数（天干引起）：0.0%
        地支 午｜十神 比肩｜用神 是｜标签：自信独立/同辈助力/合伙资源/行动力
        - 后来危险系数（地支引起）：0.0%
        - 天克地冲危险系数：0.0%
```

**覆盖点**：
- 天干/地支均为用神 → 好运
- 夫妻宫合 → 感情提示
- 总危险系数 0% → 无风险管理建议

---

#### 8.3.2 year_2031.txt（时柱天克地冲）

```
2031 年 辛亥（虚龄 27 岁）：全年 凶（棘手/意外）
开始(H1)：天干 辛 | 偏财｜用神 否｜标签【重点】：开销大/现实压力/精神压力大
后来(H2)：地支 亥 | 正官｜用神 否｜标签【重点】：规章压力/束缚/被考核/开销大

提示汇总：
- 天克地冲（时柱）：流年 辛亥 × 命局时柱 乙巳（事业家庭宫） → 提示：可能搬家/换工作。

- 缘分（天干）：暧昧推进
- 风险管理选项（供参考）：保险/预案；投机回撤风险更高；合规优先；职业变动成本更高；情绪波动时更易误判；重大决定适合拉长周期

计算过程（Evidence / Debug，仅供开发者）：
        --- 总危险系数：40.0% ---
        天干 辛｜十神 偏财｜用神 否｜标签：开销大/现实压力/精神压力大
        - 开始危险系数（天干引起）：0.0%
        地支 亥｜十神 正官｜用神 否｜标签：规章压力/束缚/被考核/开销大
        - 后来危险系数（地支引起）：30.0%
        - 天克地冲危险系数：10.0%

        后来事件（地支引起）：
          冲：流年 亥 冲 命局时柱（事业家庭宫（工作 / 子女 / 后期家庭）） 巳，风险 15.0%
          巳午未三会火会被冲到：冲对中'巳'属于巳午未三会火会；'亥'是单独字
          单独字亥：不是用神
          三合/三会逢冲额外：+15%（本年只加一次）
          冲总影响：动态 15.0% + 三合/三会逢冲 15.0% = 30.0%

        天克地冲事件：
          天克地冲：流年 辛亥 与 命局时柱（事业家庭宫（工作 / 子女 / 后期家庭））乙巳 天克地冲，风险 10.0%
```

**覆盖点**：
- 时柱天克地冲 → 搬家/换工作提示
- 三合/三会逢冲加成 +15%
- 总风险 40% → 触发风险管理选项
- 男命天干偏财（辛）→ 缘分（天干）提示

---

#### 8.3.3 year_2037.txt（好运 + 婚姻宫合）

```
2037 年 丁巳（虚龄 33 岁）：开始 好运，后来 好运
开始(H1)：天干 丁 | 比肩｜用神 是｜标签【重点】：自信独立/同辈助力/合伙资源/行动力
后来(H2)：地支 巳 | 劫财｜用神 是｜标签【重点】：自信独立/同辈助力/合伙资源/行动力

提示汇总：
- 合：巳酉半合（婚姻宫） → 提示：婚姻宫引动（单身：更容易出现暧昧/推进；有伴侣：关系推进或波动）

- （无提示）合：巳酉半合（祖上宫）

计算过程（Evidence / Debug，仅供开发者）：
        --- 总危险系数：0.0% ---
        天干 丁｜十神 比肩｜用神 是｜标签：自信独立/同辈助力/合伙资源/行动力
        - 开始危险系数（天干引起）：0.0%
        地支 巳｜十神 劫财｜用神 是｜标签：自信独立/同辈助力/合伙资源/行动力
        - 后来危险系数（地支引起）：0.0%
        - 天克地冲危险系数：0.0%
```

**覆盖点**：
- 婚姻宫合 → 有提示
- 祖上宫合 → 无提示（标注「无提示」）
- 多宫同时被合的区分处理

---

#### 8.3.4 year_2038.txt（伤官见官）

```
2038 年 戊午（虚龄 34 岁）：开始 有轻微变动，后来 好运
开始(H1)：天干 戊 | 伤官｜用神 否｜标签【重点】：顶撞权威/口舌/冲突/贪玩
后来(H2)：地支 午 | 比肩｜用神 是｜标签【重点】：自信独立/同辈助力/合伙资源/行动力

提示汇总：
- 模式：伤官见官 → （天干戊/天干壬）引动伤官见官：主特征｜外部对抗：更容易出现来自外部的人/权威/规则的正面冲突与摩擦。表现形式（仅类别）：口舌是非/名声受损；合同/合规/官非；意外与身体伤害；（女性）伴侣关系不佳或伴侣受伤。

- 合：午未合（夫妻宫） → 提示：夫妻宫引动（单身：更容易出现暧昧/推进；有伴侣：关系推进或波动）

计算过程（Evidence / Debug，仅供开发者）：
        --- 总危险系数：15.0% ---
        天干 戊｜十神 伤官｜用神 否｜标签：顶撞权威/口舌/冲突/贪玩
        - 开始危险系数（天干引起）：15.0%
        地支 午｜十神 比肩｜用神 是｜标签：自信独立/同辈助力/合伙资源/行动力
        - 后来危险系数（地支引起）：0.0%
        - 天克地冲危险系数：0.0%

        开始事件（天干引起）：
          模式（天干层）：伤官见官，风险 15.0%
          伤官见官总影响：动态 15.0% + 静态 0.0% = 15.0%
```

**覆盖点**：
- 伤官见官模式（单次触发 → 显示具体位置串）
- 天干非用神 + 风险 15% → H1 有轻微变动
- 地支用神 + 风险 0% → H2 好运

---

#### 8.3.5 year_2043.txt（时柱被冲，无天克地冲）

```
2043 年 癸亥（虚龄 39 岁）：全年 明显变动（可克服）
开始(H1)：天干 癸 | 七杀｜用神 否｜标签【重点】：工作压力/对抗强/紧张感/开销大
后来(H2)：地支 亥 | 正官｜用神 否｜标签【重点】：规章压力/束缚/被考核/开销大

提示汇总：
- 冲：亥巳冲（事业家庭宫） → 提示：可能搬家/换工作。

计算过程（Evidence / Debug，仅供开发者）：
        --- 总危险系数：25.0% ---
        天干 癸｜十神 七杀｜用神 否｜标签：工作压力/对抗强/紧张感/开销大
        - 开始危险系数（天干引起）：0.0%
        地支 亥｜十神 正官｜用神 否｜标签：规章压力/束缚/被考核/开销大
        - 后来危险系数（地支引起）：25.0%
        - 天克地冲危险系数：0.0%

        后来事件（地支引起）：
          冲：流年 亥 冲 命局时柱（事业家庭宫（工作 / 子女 / 后期家庭）） 巳，风险 15.0%
          运年相冲：大运支 巳（劫财） 与 流年支 亥（正官） 相冲，风险 10.0%
          冲总影响：动态 25.0% = 25.0%
```

**覆盖点**：
- 时柱被冲（无天克地冲）→ 走「冲」分支，输出搬家/换工作提示
- 与 2031 形成互斥对照：时柱天克地冲 vs 时柱被冲
- 运年相冲额外风险

---

#### 8.3.6 year_2058.txt（刑）

```
2058 年 戊寅（虚龄 54 岁）：开始 一般，后来 好运
开始(H1)：天干 戊 | 伤官｜用神 否｜标签【重点】：顶撞权威/口舌/冲突/贪玩
后来(H2)：地支 寅 | 正印｜用神 是｜标签：贵人/支持/学习证书
计算过程（Evidence / Debug，仅供开发者）：
        --- 总危险系数：5.0% ---
        天干 戊｜十神 伤官｜用神 否｜标签：顶撞权威/口舌/冲突/贪玩
        - 开始危险系数（天干引起）：0.0%
        地支 寅｜十神 正印｜用神 是｜标签：贵人/支持/学习证书
        - 后来危险系数（地支引起）：5.0%
        - 天克地冲危险系数：0.0%

        后来事件（地支引起）：
          刑：寅 刑 时柱（事业家庭宫（工作 / 子女 / 后期家庭）） 巳，风险 5.0%
          刑总影响：动态 5.0% + 静态 0.0% = 5.0%
```

**覆盖点**：
- 寅巳刑（无提示输出，只计风险）
- 地支用神 + 低风险 → H2 好运
- 天干非用神 + 0 风险 → H1 一般

---

#### 8.3.7 year_2059.txt（枭神夺食 + 天克地冲 + 合冲同现）

```
2059 年 己卯（虚龄 55 岁）：全年 凶（棘手/意外）
开始(H1)：天干 己 | 食神｜用神 否｜标签【重点】：贪舒服/拖延/松散
后来(H2)：地支 卯 | 偏印｜用神 是｜标签【重点】：偏门技术/思想突破/学习研究/灵感

提示汇总：
- 模式：枭神夺食 → 引发多次枭神夺食：主特征｜突发意外：更容易出现突如其来的变故与波折，打乱节奏。表现形式（仅类别）：判断失误/信息偏差→麻烦与灾祸；钱财损失；犯小人/被拖累；意外的身体伤害风险上升。

- 天克地冲（月柱）：流年 己卯 × 命局月柱 乙酉（婚姻宫） → 提示：可能出现意外、生活环境剧变，少数情况下牵动亲缘离别。

- 冲：卯酉冲（婚姻宫） → 提示：感情（单身：更易暧昧/受阻；有伴侣：争执起伏）
- 合：卯未半合（夫妻宫） → 提示：夫妻宫引动（单身：更容易出现暧昧/推进；有伴侣：关系推进或波动）
- 额外提示：感情线合冲同现（进展易受阻/反复拉扯；仓促定论的稳定性更低）

- 风险管理选项（供参考）：保险/预案；投机回撤风险更高；合规优先；职业变动成本更高；情绪波动时更易误判；重大决定适合拉长周期

计算过程（Evidence / Debug，仅供开发者）：
        --- 总危险系数：148.5% ---
        天干 己｜十神 食神｜用神 否｜标签：贪舒服/拖延/松散
        - 开始危险系数（天干引起）：51.0%
        地支 卯｜十神 偏印｜用神 是｜标签：偏门技术/思想突破/学习研究/灵感
        - 后来危险系数（地支引起）：82.5%
        - 天克地冲危险系数：15.0%

        开始事件（天干引起）：
          模式（天干层）：枭神夺食，风险 10.0%
          模式（天干层）：枭神夺食，风险 10.0%
          模式（天干层）：枭神夺食，风险 10.0%
          静态模式激活（天干）：枭神夺食，风险 15.0%
          枭神夺食总影响：动态 30.0% + 静态 15.0% = 45.0%
          线运加成（天干）：6.0%

        后来事件（地支引起）：
          冲：流年 卯 冲 命局年柱（祖上宫（家庭出身、早年环境））、月柱（婚姻宫） 酉，风险 45.0%
          静态冲激活：风险 22.5%
          冲总影响：动态 45.0% + 静态 22.5% = 67.5%
          模式（地支层）：枭神夺食，风险 10.0%
          静态模式激活（地支）：枭神夺食，风险 5.0%
          枭神夺食总影响：动态 10.0% + 静态 5.0% = 15.0%

        天克地冲事件：
          天克地冲：流年 己卯 与 命局月柱（婚姻宫）乙酉 天克地冲，风险 10.0%
```

**覆盖点**：
- 枭神夺食模式（多次触发 → 显示「引发多次」）
- 月柱天克地冲（通用提示：意外/剧变/亲缘离别）
- 婚姻宫冲 → 感情提示
- 夫妻宫合 → 宫引动提示
- 合冲同现 → 额外提示
- 静态冲激活 / 静态模式激活
- 线运加成
- 总风险 148.5% → 触发风险管理选项

---

### 8.4 运行测试

```bash
# 运行全部 regression 测试
python -m pytest tests/regression/test_liunian_v2_golden.py -v

# 运行单个年份测试
python -m pytest tests/regression/test_liunian_v2_golden.py::TestLiunianV2Golden::test_year_2059 -v
```

### 8.5 更新 Snapshot

如果打印逻辑变更后需要更新 snapshot：

1. 手动运行 CLI 生成新输出
2. 提取对应年份块
3. 覆盖 `tests/regression/snapshots/liunian_v2/year_XXXX.txt`
4. 重新运行测试确认通过
