# 实施备忘录

本文档记录实施过程中需要注意的技术细节和待实现的功能。

---

## 一、凶年/变动年判断标准（已明确）

### 1.1 正确的判断标准

**代码位置**：
- `bazi/request_index.py` (424-427行)
- `bazi/cli.py` (1685-1688行)

**判断逻辑**：
```python
# Y = total_risk_percent

if Y >= 40.0:
    year_label = "全年 凶（棘手/意外）"
elif Y >= 25.0:
    year_label = "全年 明显变动（可克服）"
else:
    # Y < 25.0，输出"开始 X，后来 Y"
    year_label = f"开始 {start_label}，后来 {later_label}"
```

**总结**：
- **凶年**：`total_risk_percent >= 40`
- **变动年**：`total_risk_percent >= 25`（但 < 40）
- **一般/好运年**：`total_risk_percent < 25`（根据 start_good/later_good 细分）

**注意**：
- ⚠️ `year_detail.py` 里的 `_compute_half_year_grade` 函数是用来计算"开始/后来"的半年评级，不是用来判断整年是否是凶年/变动年
- ⚠️ 凶年/变动年的判断标准只看 `total_risk_percent`，不看 `start_good/later_good`

---

## 二、六亲助力财星"父亲/爸爸"输出规则（✅ 已实现 2026-01-31）

### 2.1 规则说明

**默认不输出父亲**。只有满足以下**全部条件**时才输出：

1. 财星是用神
2. 天干有财星透出（年/月/时柱天干有正财或偏财）
3. 年月天干都不是比劫（年OR月有比劫就不输出）

### 2.2 代码位置

- **判断函数**：`bazi/cli.py` → `_should_output_father_in_cai()`
- **打印函数**：`bazi/cli.py` → `_get_liuqin_source()` 增加 `should_output_father` 参数

### 2.3 Regression 测试

**测试文件**：`tests/regression/test_father_in_liuqin.py`

| 案例 | 预期 | 原因 |
|------|------|------|
| 2005-9-17 12:00女 | ❌不输出 | 年月柱天干有比劫 |
| 1965-10-4 6:00男 | ✅输出 | 财星是用神 + 天干透财星 + 年月无比劫 |
| 2005-2-5 12:00女 | ✅输出 | 天干透了财星，时柱劫财不算 |
| 2006-3-28 12:00女 | ❌不输出 | 年月有比劫 |
| 2003-11-28 2:00男 | ❌不输出 | 财星没有透 |

**运行测试**：`python -m unittest tests.regression.test_father_in_liuqin -v`

---

## 三、原局打印层设计重构需求

### 3.1 用户要求

**用户说明**：
- 同意 MVP 路线图的实施顺序
- 部分缺的东西先记下来
- 先去改一遍原局打印层的设计，让它变得更容易剪切

### 3.2 重构目标

**目的**：
- 让原局打印内容更容易剪切（方便 LLM 提取需要的部分）
- 按照 [natal_print_analysis.md](natal_print_analysis.md) 的建议，采用分层打印法

**建议方案**（参考 natal_print_analysis.md 第六章）：
1. **用户基础信息层**：四柱八字
2. **LLM 数据层**：主要性格、性格快速汇总、六亲助力、用神五行、婚配倾向、婚恋结构
3. **Debug 数据层**：日主信息、全局五行占比、用神详细信息、原局六合/半合、原局天干五合、原局问题
4. **大运数据层**：大运转折点、用神互换、大运快照（应该移到大运 section）

**实施步骤**：
1. 在 `cli.py` 中调整打印顺序
2. 在每个板块名称前加上层级标记（如 `========================================\n【LLM 输入数据】`）
3. 将非原局内容（大运转折点、用神互换、大运快照）移到大运 section
4. 确保打印内容可以方便地通过正则表达式或标记提取

---

## 四、待实现功能清单

### 4.1 已明确的功能（优先级 P0-P1）

参见 [pending_features.md](pending_features.md) 和 [MVP_ROADMAP.md](MVP_ROADMAP.md)

**P0 级别**：
1. Q1 细化：凶年/变动年钻取 hints（判断标准：`total_risk_percent >= 40` 为凶，`>= 25` 为变动）
2. Q1 细化：Turning Points 条件输出（窗口：过去5年+未来10年）
3. Q2: 我这个人是什么样的
4. Q3: 某年运势

**P1 级别**：
1. Q1 细化：天干五合感情提醒（关键词：婚恋变化提醒、第三者介入、争合、双合）
2. Index 增强：未来两步大运（从当前之后的两步）
3. Turning Points 窗口调整（过去5年+未来10年）
4. Q4: 过去/当前感情状况
5. Q6: 适合什么行业
6. Q12: 什么样的人会爱我

**P2 级别**：
1. 比劫影响财星助力（年月天干都是比劫时，不打印父亲，可打印妻子）

### 4.2 待明确的功能

1. **财星为用神时的六亲助力打印文案修改**
   - 具体修改内容待用户明确
   - 可能与比劫影响财星助力的需求相关

2. **原局打印层重构**
   - 分层打印：用户基础信息层、LLM 数据层、Debug 数据层、大运数据层
   - 移动非原局内容到大运 section
   - 增加层级标记，方便剪切

---

## 五、技术债务

### 5.1 代码结构问题

1. **原局/大运内容混杂**
   - 大运转折点、用神互换、大运快照目前在原局 section
   - 应该移到大运 section（参见 natal_print_analysis.md）

2. **打印内容冗杂**
   - 性格重复（主要性格、其他性格、性格快速汇总）
   - 用神信息过多（用神五行、用神→十神、用神落点）
   - 六亲助力过于详细（每个大类都打印来源、强度话术）
   - 参见 natal_print_analysis.md 第八章

### 5.2 数据依赖缺失

1. **五行→行业映射表**（Q6 需要）
   - 木：文教、培训、创意、设计
   - 火：营销、表达、传媒、演艺
   - 土：稳定、管理、地产、中介
   - 金：金融、法律、执行、技术
   - 水：智慧、策划、流动、贸易

2. **职业→五行映射表**（Q10 需要）
   - 教师：木、火
   - 医生：木、土
   - 律师：金
   - 程序员：水、金
   - 销售：火、水
   - ...（需要补充更多职业）

3. **未来两步大运**（Q7 需要）
   - `index.dayun.future_dayuns`（需要新增）

---

## 六、下一步行动

### 6.1 等待用户明确

1. **财星为用神时的六亲助力打印文案**
   - 具体修改内容？
   - 是否与比劫影响财星助力相关？

### 6.2 用户准备先做

1. **原局打印层设计重构**
   - 用户将先去改一遍原局打印层设计
   - 目标：让它变得更容易剪切

### 6.3 实施准备就绪

一旦原局打印层重构完成，可以按照 [MVP_ROADMAP.md](MVP_ROADMAP.md) 的顺序开始实施：
1. Q2（最简单，快速验证框架）
2. Q3（复用 year_detail，建立流程）
3. Q1 基础版（建立年度汇总框架）
4. Q1 细化版（完善功能）
5. Q4, Q6, Q12（按顺序完成 Phase 2）

---

## 七、关键发现记录

### 7.1 凶年/变动年判断标准的正确位置

- ❌ **错误位置**：`year_detail.py` 的 `_compute_half_year_grade` 函数
  - 这个函数是用来计算"开始/后来"的半年评级，不是用来判断整年是否是凶年/变动年

- ✅ **正确位置**：`request_index.py` 的 `_build_year_grade_item` 函数（424-427行）
  - 这里才是真正判断凶年/变动年的地方
  - 判断标准：`total_risk_percent >= 40` 为凶，`>= 25` 为变动

### 7.2 打印内容的层级划分

参见 [natal_print_analysis.md](natal_print_analysis.md) 快速总览：

- **LLM 需要的板块**（11 个）：
  1. 主要性格 → Q2
  2. 性格快速汇总 → Q2
  3. 六亲助力 → Q2
  4. 用神五行（候选）→ Q6, Q10
  5. 婚配倾向 → Q12
  6. 婚恋结构 → Q4, Q12
  7. 大运转折点 → Q1, Q7
  8. 用神互换 → Q6
  9. 大运快照 → Q1, Q6, Q7
  10. 流年详情 → Q1, Q3, Q4, Q5, Q8, Q9, Q11
  11. 其他性格 → Q2（可选）

- **Debug 板块**（8 个）：
  1. 四柱八字 → 用户验证
  2. 日主信息 → 强弱计算验证
  3. 全局五行占比 → 五行分布验证
  4. 用神（五行→十神）→ 用神映射验证
  5. 用神落点 → 用神位置验证
  6. 原局六合/半合 → 合检测验证
  7. 原局天干五合 → 五合检测验证
  8. 原局问题 → 冲刑检测验证

---

## 八、版本历史

- v1.0 (2026-01-30): 初始版本，记录凶年/变动年判断标准和六亲助力修改需求
- v1.1 (2026-01-31): 实现4个Index增强功能：
  1. **Relationship Index**：新增 `spouse_star_in_gan`（天干配偶星）、`spouse_star_in_zhi`（地支配偶星）、`zhi_liuhe_combine`（地支六合）、`zhi_banhe_combine`（地支半合）类型；新增 `years_by_type` 和 `last5_years_by_type` 字段
  2. **Dayun Index**：新增 `future_dayuns` 字段（未来两步大运，受 `future_allowed` 门控）
  3. **Turning Points Index**：窗口调整为过去5年+未来10年；新增 `past5_turning_points` 字段
  4. **Year Grade Index**：新增 `is_bad_year`（Y>=40）和 `is_change_year`（25<=Y<40）字段
