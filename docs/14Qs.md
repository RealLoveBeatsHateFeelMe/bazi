# 12个核心问题技术规格表

> **说明**：本文档详细标注每个问题的自然语言表述、八字概念、程序位置、数据来源

---

## Free Tier (Q1-Q4)

### Q1: 最近N年怎么样

**自然语言示例**：
- "最近5年怎么样"
- "这几年运势如何"
- "近几年过得好不好"

**八字概念**：
- **年度评级**（吉凶）：基于 total_risk_percent 计算
  - Y >= 40：凶（棘手/意外）
  - Y >= 25：明显变动（可克服）
  - Y < 25：根据 start_good/later_good 细分
- **流年天干地支事件**：天干五合、地支六合/半合、冲刑害
- **转折点**：大运转换、用神切换

**程序位置**：
- 待实现：`bazi/questions/q1_recent_years.py`
- 打印层：`bazi/cli.py`（流年详情打印）
- Index构建：`bazi/request_index.py` → `_build_year_grade_index()`
- 转折点：`bazi/request_index.py` → `_build_turning_points_index()`

**数据来源**：

| 层 | 字段路径 | 说明 |
|---|----------|------|
| **Index** | `index.year_grade.last5[]` | 近5年评级列表，每年包含 year, label, total_risk_percent |
| **Index** | `index.turning_points.nearby[]` | 附近转折点（窗口：过去5年+未来10年） |
| **Index** | `index.turning_points.should_mention` | 是否应该提及转折点 |
| **Facts** | `facts.luck.groups[].liunian[year].hints[]` | 每年的具体提示（风险管理、缘分、婚恋等） |
| **Facts** | `facts.luck.groups[].liunian[year].total_risk_percent` | 年度风险百分比 |
| **Facts** | `facts.luck.groups[].liunian[year].start_good / later_good` | 半年吉凶 |

**实现状态**：⚠️ 待实现（P0优先级）
- [OK] 基础数据已有
- [待] 凶年/变动年钻取hints（total_risk >= 25）
- [待] Turning Points条件输出（窗口需调整为 last5）
- [待] 天干五合感情提醒

---

### Q2: 我这个人是什么样的

**自然语言示例**：
- "我的性格特点"
- "我是什么样的人"
- "我有什么天赋"

**八字概念**：
- **十神**：财、印、食伤、比劫、官杀（五大类）
- **性格天赋卡**：每个十神类型对应5个维度（思维/社交/兴趣/生活/提高）
- **五档分级**：纯正、纯偏、正主导、各半、偏主导
  - pian_ratio = 偏% / (正% + 偏%)
  - 根据 pian_ratio 判断档位
- **六亲助力**：财、印、食伤、比劫、官杀的来源与强度

**程序位置**：
- 待实现：`bazi/questions/q2_personality.py`
- 打印层：`bazi/cli.py`
  - 主要性格（2414-2732行）：天赋卡打印
  - 性格快速汇总（2756-2833行）：`build_personality_quick_summary()`
  - 六亲助力（2904-3151行）：`_get_liuqin_source()`, `_get_strength_wording()`
- 性格分析：`bazi/pazi.py` → `personality` 字段

**数据来源**：

| 层 | 字段路径 | 说明 |
|---|----------|------|
| **Index** | `index.personality.dominant_traits[]` | 主要性格类型列表 |
| **Index** | `index.personality.axis_summaries[]` | 性格轴汇总 |
| **Facts** | `facts.natal.dominant_traits[]` | 主要性格类型（财、印等） |
| **Facts** | `facts.natal.liuqin_zhuli` | 六亲助力详情 |
| **打印层** | 主要性格、其他性格、性格快速汇总 | cli.py 已格式化的文本块 |

**实现状态**：[OK] 已完整实现（P0优先级）

---

### Q3: 某年运势

**自然语言示例**：
- "2025年运势如何"
- "今年怎么样"
- "明年会顺利吗"

**八字概念**：
- **流年天干地支**：年份的天干和地支
- **流年事件**：与原局四柱的合冲刑害关系
- **流年吉凶**：基于用神、半年评级、月份吉凶
- **四个部分**（打印层）：
  1. 为什么会这样（用神分析）
  2. 具体表现与提示（hints汇总）
  3. 月份吉凶（12个月评级）
  4. 如何应对（风险管理建议）

**程序位置**：
- 待实现：`bazi/questions/q3_year_detail.py`
- 核心逻辑：`bazi/year_detail.py` → `generate_year_detail()`
- 打印层：`bazi/cli.py`（1071-1180行）
- Hints生成：`bazi/enrich.py`

**数据来源**：

| 层 | 字段路径 | 说明 |
|---|----------|------|
| **Facts** | `facts.luck.groups[].liunian[year]` | 某年的完整流年数据 |
| **Facts** | `facts.luck.groups[].liunian[year].gan / zhi` | 流年天干地支 |
| **Facts** | `facts.luck.groups[].liunian[year].hints[]` | 流年提示列表 |
| **Facts** | `facts.luck.groups[].liunian[year].total_risk_percent` | 年度风险百分比 |
| **Facts** | `facts.luck.groups[].liunian[year].start_good / later_good` | 半年吉凶 |
| **打印层** | `- HINTS -` 区块 | 包含感情、财运、风险管理、事业等hints |
| **打印层** | `- DEBUG -` 区块 | 包含天干地支事件、合冲刑害详情 |

**实现状态**：[OK] 已完整实现（P0优先级）
- [OK] year_detail.py 已实现
- [OK] 打印层协议化完成（HINTS/DEBUG分离）

---

### Q4: 过去/当前感情状况

**自然语言示例**：
- "最近感情怎么样"
- "过去5年感情顺不顺"
- "以前恋爱情况如何"

**八字概念**：
- **配偶星**：
  - 男命：正财、偏财
  - 女命：正官、七杀
  - 天干配偶星 → "暧昧推进"
  - 地支配偶星 → "易遇合适伴侣（良缘）"
- **合**：地支六合、地支半合/三合
- **冲到婚姻宫/夫妻宫**：流年地支冲到月柱（婚姻宫）或日柱（夫妻宫）
- **婚配倾向**：适合什么样的伴侣
- **婚恋结构**：官杀混杂、财混杂、五合等特征

**程序位置**：
- 待实现：`bazi/questions/q4_past_relationship.py`
- Index构建：`bazi/relationship_index.py` → `generate_relationship_index()`
- Hints生成：`bazi/enrich.py`（378-398行）：配偶星hints
- 婚配倾向：`bazi/enrich.py`（1246-1329行）：`_build_marriage_hint()`

**数据来源**：

| 层 | 字段路径 | 说明 |
|---|----------|------|
| **Index** | `index.relationship.last5_hit` | 近5年是否有感情命中 |
| **Index** | `index.relationship.last5_years[]` | 近5年命中的年份列表 |
| **Index** | `index.relationship.last5_years_by_type` | **[待增强]** 近5年按类型分组的年份 |
| **Index** | `index.relationship.types[]` | 命中类型列表（palace_clash, competing_combine等） |
| **Facts** | `facts.luck.groups[].liunian[year].hints[]` | 每年的hints，需过滤感情相关 |
| **Facts** | `facts.natal.marriage_hint` | 婚配倾向文本 |
| **Facts** | `facts.natal.marriage_structure` | 婚恋结构描述 |

**感情hints关键词**：
- "缘分（天干）：暧昧推进"
- "缘分（地支）：易遇合适伴侣（良缘）"
- "婚恋变化提醒（如恋爱）"
- "婚姻宫"、"夫妻宫"
- "感情线合冲同现"

**实现状态**：⚠️ 待实现（P1优先级）
- [OK] Index已有last5_years命中年份
- [待] 增强relationship_index（增加配偶星检测、years_by_type）
- [待] hints过滤关键词

---

## Paid Tier (Q5-Q12)

### Q5: 未来某年运势

**自然语言示例**：
- "明年怎么样"
- "2027年运势如何"
- "后年会顺利吗"

**八字概念**：
- 与 Q3 相同（流年天干地支、流年事件、流年吉凶）
- **口径差异**：
  - 好运年 → "机会多，好好把握"
  - 差运年 → "三思而后行，小心谨慎"

**程序位置**：
- 待实现：`bazi/questions/q5_future_year.py`
- 复用：`bazi/year_detail.py` → `generate_year_detail()`
- 付费门控：检查 `future_allowed` 参数

**数据来源**：

| 层 | 字段路径 | 说明 |
|---|----------|------|
| **Facts** | `facts.luck.groups[].liunian[year]` | 未来年份的流年数据（与Q3相同） |

**实现状态**：⚠️ 待实现（P3优先级）
- [OK] 数据已有（复用Q3）
- [待] 增加付费门控
- [待] 调整输出口径

---

### Q6: 适合什么行业

**自然语言示例**：
- "我适合做什么行业"
- "什么工作适合我"
- "适合做什么职业方向"

**八字概念**：
- **用神五行**：木、火、土、金、水
- **五行→行业映射**：
  - 木：文教、培训、创意、设计、医疗、出版
  - 火：营销、表达、传媒、演艺、餐饮、娱乐、能源
  - 土：稳定、管理、地产、中介、房产、建筑、人力资源
  - 金：金融、法律、执行、技术、IT、机械制造
  - 水：智慧、策划、流动、贸易、物流、旅游、咨询
- **用神互换**：大运变化期间，用神可能切换，导致适合行业调整

**程序位置**：
- 待实现：`bazi/questions/q6_suitable_industry.py`
- 待新建：`bazi/industry_text.py` → `build_industry_text()` 函数
- 待新建：`bazi/mappings/element_to_industry.py` → `YONGSHEN_INDUSTRY` 映射表
- Index构建：`bazi/dayun_index.py` → 用神互换窗口

**数据来源**：

| 层 | 字段路径 | 说明 |
|---|----------|------|
| **Facts** | `facts.natal.yongshen_elements[]` | 用神五行列表（如 ["木", "火"]） |
| **Index** | `index.dayun.yongshen_swap.windows[]` | 用神互换窗口列表 |
| **Index** | `index.dayun.yongshen_swap.windows[].year_range` | 互换的年份范围（start_year, end_year） |
| **Index** | `index.dayun.yongshen_swap.windows[].to_elements[]` | 互换后的用神五行 |

**新函数设计**：
```python
# bazi/industry_text.py

def build_industry_text(yongshen_elements: list, yongshen_swap_windows: list) -> str:
    """
    输出行业建议文本，直接喂给LLM。

    返回格式：
    - 无互换：用神五行 + 推荐行业
    - 有互换：默认行业 + "在YYYY-YYYY年间更适合X行业"
    """
```

**实现状态**：⚠️ 待实现（P1优先级）
- [OK] 用神五行数据已有
- [OK] 用神互换窗口已有
- [待] 新建行业映射表
- [待] 新建build_industry_text()函数

---

### Q7: 我会不会有钱/出名

**自然语言示例**：
- "我会不会有钱"
- "什么时候能发财"
- "我能不能出名"
- "什么时候起色"

**八字概念**：
- **财富/名气 = 年度评级 + 大运评级**（不看具体十神）
- **好运年**：total_risk_percent 低、年度评级为"好运"
- **好大运**：大运fortune_label为"好运"、用神得力
- **未来展望**：查看未来3年年度评级 + 未来两步大运

**程序位置**：
- 待实现：`bazi/questions/q7_wealth_fame.py`
- Index构建：`bazi/request_index.py` → `_build_good_year_search_index()`
- Index增强：`bazi/request_index.py` → `_build_dayun_index()`（需增加future_dayuns）

**数据来源**：

| 层 | 字段路径 | 说明 |
|---|----------|------|
| **Index** | `index.year_grade.future3[]` | 未来3年评级 |
| **Index** | `index.good_year_search.next_good_year` | 下一个好运年份 |
| **Index** | `index.dayun.current_dayun_ref` | 当前大运引用 |
| **Index** | `index.dayun.future_dayuns[]` | **[待新增]** 未来两步大运 |
| **Index** | `index.dayun.fortune_label` | 当前大运fortune评级 |

**裁剪逻辑**：
1. 看 future3 评级
2. 都不好 → 找 next_good_year
3. 都不好且无好运年 → 查 future_dayuns，找好大运
4. 输出："X年会有起色" 或 "X-X年（大运期间）会有机会"

**实现状态**：⚠️ 待实现（P2优先级）
- [OK] next_good_year 已有
- [OK] future3 已有
- [待] 新增 future_dayuns 字段（需要修改Index构建逻辑）

---

### Q8: 什么时候遇到对的人

**自然语言示例**：
- "什么时候遇到对的人"
- "什么时候能脱单"
- "什么时候遇到正缘"
- "什么时候可以结婚"

**八字概念**：
- **地支配偶星**（重点）：遇到对的人，可以结婚
  - 男命：流年地支主气是正财/偏财
  - 女命：流年地支主气是正官/七杀
  - Hint: "缘分（地支）：易遇合适伴侣（良缘）"
- **合**：能谈恋爱
  - 地支六合：子丑、寅亥、卯戌、辰酉、巳申、午未
  - 地支半合/三合
  - **注意**：天干五合不算"合"（只是缘分信号）
- **天干配偶星**：暧昧推进
  - 男命：流年天干是正财/偏财
  - 女命：流年天干是正官/七杀
  - Hint: "缘分（天干）：暧昧推进"
- **不输出冲**：冲一般不能谈成

**程序位置**：
- 待实现：`bazi/questions/q8_meet_partner.py`
- Index增强：`bazi/relationship_index.py`（需增加配偶星检测、years_by_type）

**数据来源**：

| 层 | 字段路径 | 说明 |
|---|----------|------|
| **Index** | `index.relationship.years_by_type.spouse_star_in_zhi[]` | **[待新增]** 地支配偶星年份（未来） |
| **Index** | `index.relationship.years_by_type.spouse_star_in_gan[]` | **[待新增]** 天干配偶星年份（未来） |
| **Index** | `index.relationship.years_by_type.zhi_liuhe_combine[]` | **[待新增]** 地支六合年份 |
| **Index** | `index.relationship.years_by_type.zhi_banhe_combine[]` | **[待新增]** 地支半合/三合年份 |
| **Index** | `index.relationship.years[]` | 当前：所有感情命中年份（混在一起） |
| **Facts** | `facts.natal.marriage_hint` | 婚配倾向文本 |
| **Facts** | `facts.luck.groups[].liunian[year].hints[]` | 该年感情hints |

**Q8输出结构**：
```
【未来最有可能遇到对的人的年份】
- 2028年：地支配偶星（易遇合适伴侣，良缘）
- 2029年：地支配偶星 + 地支半合（能谈恋爱）

【婚配倾向】
适合找阳光、有正能量、有担当的伴侣

【其他感情信号】（可选）
- 2030年：天干配偶星（暧昧推进，但未必是对的人）
- 2027年：地支六合（能谈恋爱）
```

**实现状态**：⚠️ 待实现（P2优先级）
- [OK] 配偶星hints已在enrich.py生成
- [待] relationship_index增加配偶星检测
- [待] relationship_index增加years_by_type字段
- [待] relationship_index增加合检测（地支六合、半合）

---

### Q9: 今年要不要做X决定

**自然语言示例**：
- "今年适合跳槽吗"
- "今年能买房吗"
- "今年要不要投资"
- "今年适合结婚吗"

**八字概念**：
- 与 Q3 相同（今年的流年吉凶、天干地支事件、hints）
- **口径差异**：
  - 好运年 → "更可能成功，可以尝试"
  - 差运年 → "风险较高，建议保守"
  - 根据决定类型，看对应十神：
    - 财务决定 → 看财星、风险百分比
    - 工作决定 → 看官杀星、印星
    - 感情决定 → 看感情hints

**程序位置**：
- 待实现：`bazi/questions/q9_decision.py`
- 复用：`bazi/year_detail.py` → `generate_year_detail()`

**数据来源**：

| 层 | 字段路径 | 说明 |
|---|----------|------|
| **Facts** | `facts.luck.groups[].liunian[base_year]` | 今年的流年数据（与Q3相同） |

**实现状态**：⚠️ 待实现（P2优先级）
- [OK] 数据已有（复用Q3）
- [待] 根据决定类型调整输出口径

---

### Q10: 我适合当X职业吗

**自然语言示例**：
- "我适合当rapper吗"
- "我适合当商人吗"
- "我适合做程序员吗"

**八字概念**：
- **用神五行**：木、火、土、金、水
- **职业→五行映射**：
  - rapper：火（表达）、木（创意）
  - 商人：金（交易）、土（资源）
  - 程序员：金（逻辑）、水（技术）
  - 老师：木（教育）、火（传播）
  - 医生：木（医疗）、水（研究）
- **匹配度判断**：
  - 职业五行 ∩ 用神五行 >= 1 → 适合
  - 无重合 → 需要额外努力

**程序位置**：
- 待实现：`bazi/questions/q10_suitable_job.py`
- 待新建：`bazi/career_fit.py` → `check_career_fit()` 函数
- 待新建：`bazi/mappings/job_to_element.py` → `CAREER_ELEMENT` 映射表

**数据来源**：

| 层 | 字段路径 | 说明 |
|---|----------|------|
| **Facts** | `facts.natal.yongshen_elements[]` | 用神五行列表 |

**新函数设计**：
```python
# bazi/career_fit.py

def check_career_fit(career: str, yongshen_elements: list) -> str:
    """
    输出职业适配度文本。

    返回格式：
    - 有重合：你的用神五行（X、Y）与职业需要的五行（A、B）有重合，更容易发挥优势。
    - 无重合：职业需要的五行（A、B）不在你的用神范围内，可能需要额外努力。
    """
```

**实现状态**：⚠️ 待实现（P3优先级）
- [OK] 用神五行数据已有
- [待] 新建职业映射表（需补充更多职业）
- [待] 新建check_career_fit()函数

---

### Q11: TA爱不爱我

**自然语言示例**：
- "他爱我吗"
- "她对我有感觉吗"
- "TA喜欢我吗"

**八字概念**：
- 与 Q4 类似（今年的感情hints）
- **口径差异**：
  - 有合 + 配偶星 → "感情有推进机会"
  - 有冲 → "关系可能有波动"
  - 无明显信号 → "暂时不明显"

**程序位置**：
- 待实现：`bazi/questions/q11_love_me.py`
- 复用：今年的感情hints过滤逻辑

**数据来源**：

| 层 | 字段路径 | 说明 |
|---|----------|------|
| **Facts** | `facts.luck.groups[].liunian[base_year].hints[]` | 今年的hints，过滤感情相关 |

**实现状态**：⚠️ 待实现（P3优先级）
- [OK] 数据已有
- [待] 需要复杂的配偶星分析（是否用神、是否有冲克）

---

### Q12: 什么样的人会爱我

**自然语言示例**：
- "什么样的人适合我"
- "我的正缘是什么类型"
- "什么样的伴侣会爱我"

**八字概念**：
- **婚配倾向**：描述适合的伴侣类型
  - 基于配偶星在原局中的位置、强弱、是否用神
  - 示例："适合找阳光、有正能量、有担当的伴侣"
- **婚恋结构**：描述婚恋特征
  - 官杀混杂：桃花多，易再婚
  - 财混杂：感情复杂
  - 五合：感情纠葛

**程序位置**：
- 待实现：`bazi/questions/q12_partner_type.py`
- 婚配倾向生成：`bazi/enrich.py`（1246-1329行）→ `_build_marriage_hint()`
- 婚恋结构生成：`bazi/enrich.py` → `_build_marriage_structure()`

**数据来源**：

| 层 | 字段路径 | 说明 |
|---|----------|------|
| **Facts** | `facts.natal.marriage_hint` | 婚配倾向文本 |
| **Facts** | `facts.natal.marriage_structure` | 婚恋结构描述 |

**实现状态**：⚠️ 待实现（P1优先级）
- [OK] 数据已有（enrich.py已生成）
- [待] 直接输出marriage_hint即可

---

## 附录：关键代码位置索引

### 核心文件

| 文件 | 职责 | 关键函数 |
|------|------|---------|
| `bazi/request_index.py` | Index生成 | `_build_year_grade_index()`, `_build_dayun_index()`, `_build_turning_points_index()`, `_build_relationship_index()` |
| `bazi/enrich.py` | Hints生成 | 缘分hints（378-398行）、婚配倾向（1246-1329行） |
| `bazi/cli.py` | 打印层 | 性格（2414-2833行）、流年（1071-1180行）、六亲助力（2904-3151行） |
| `bazi/year_detail.py` | Year detail结构化 | `generate_year_detail()` |
| `bazi/relationship_index.py` | 感情窗口检测 | `generate_relationship_index()` |
| `bazi/dayun_index.py` | 用神互换检测 | 用神互换窗口计算 |
| `bazi/pazi.py` | 原局分析 | `personality`, `yongshen_elements` |

### 待新建文件

| 文件 | 职责 | 优先级 |
|------|------|-------|
| `bazi/questions/q1_recent_years.py` | Q1实现 | P0 |
| `bazi/questions/q2_personality.py` | Q2实现 | P0 |
| `bazi/questions/q3_year_detail.py` | Q3实现 | P0 |
| `bazi/questions/q4_past_relationship.py` | Q4实现 | P1 |
| `bazi/questions/q5_future_year.py` | Q5实现 | P3 |
| `bazi/questions/q6_suitable_industry.py` | Q6实现 | P1 |
| `bazi/questions/q7_wealth_fame.py` | Q7实现 | P2 |
| `bazi/questions/q8_meet_partner.py` | Q8实现 | P2 |
| `bazi/questions/q9_decision.py` | Q9实现 | P2 |
| `bazi/questions/q10_suitable_job.py` | Q10实现 | P3 |
| `bazi/questions/q11_love_me.py` | Q11实现 | P3 |
| `bazi/questions/q12_partner_type.py` | Q12实现 | P1 |
| `bazi/industry_text.py` | 行业建议文本生成 | P1 |
| `bazi/career_fit.py` | 职业适配度判断 | P3 |
| `bazi/mappings/element_to_industry.py` | 五行→行业映射表 | P1 |
| `bazi/mappings/job_to_element.py` | 职业→五行映射表 | P3 |

---

## 数据层概览

### Index层字段

| Index Block | 用途 | 问题 |
|-------------|------|------|
| `INDEX_YEAR_GRADE` | 年度评级（last5, future3） | Q1, Q3, Q5, Q7, Q9 |
| `INDEX_DAYUN` | 大运评级、用神互换、未来大运 | Q6, Q7 |
| `INDEX_TURNING_POINTS` | 转折点（nearby, should_mention） | Q1 |
| `INDEX_RELATIONSHIP` | 感情窗口（years_hit, last5_years_hit） | Q4, Q8, Q11 |
| `INDEX_PERSONALITY` | 性格汇总（dominant_traits） | Q2 |
| `INDEX_GOOD_YEAR_SEARCH` | 下一个好运年 | Q7 |

### Facts层字段

| Facts Block | 用途 | 问题 |
|-------------|------|------|
| `facts.natal.dominant_traits[]` | 主要性格 | Q2 |
| `facts.natal.liuqin_zhuli` | 六亲助力 | Q2 |
| `facts.natal.yongshen_elements[]` | 用神五行 | Q6, Q10 |
| `facts.natal.marriage_hint` | 婚配倾向 | Q4, Q8, Q12 |
| `facts.natal.marriage_structure` | 婚恋结构 | Q4, Q12 |
| `facts.luck.groups[].liunian[year]` | 流年详情 | Q1, Q3, Q4, Q5, Q8, Q9, Q11 |
| `facts.luck.groups[].liunian[year].hints[]` | 流年提示 | Q1, Q3, Q4, Q5, Q8, Q9, Q11 |
| `facts.luck.groups[].dayun` | 大运详情 | Q6, Q7 |

---

## 实施优先级总表

| 优先级 | 问题 | 预计工作量 | 依赖 |
|--------|------|-----------|------|
| **P0** | Q1: 最近N年怎么样 | 3-5天 | Index增强（turning_points窗口） |
| **P0** | Q2: 我这个人是什么样的 | 1-2天 | - |
| **P0** | Q3: 某年运势 | 1-2天 | - |
| **P1** | Q4: 过去/当前感情状况 | 2-3天 | relationship_index增强 |
| **P1** | Q6: 适合什么行业 | 3-4天 | 行业映射表、build_industry_text() |
| **P1** | Q12: 什么样的人会爱我 | 2-3天 | - |
| **P2** | Q7: 我会不会有钱/出名 | 3-4天 | Index增强（future_dayuns） |
| **P2** | Q8: 什么时候遇到对的人 | 2-3天 | relationship_index增强 |
| **P2** | Q9: 今年要不要做X决定 | 3-4天 | - |
| **P3** | Q5: 未来某年运势 | 1天 | 付费门控 |
| **P3** | Q10: 我适合当X职业吗 | 3-4天 | 职业映射表、check_career_fit() |
| **P3** | Q11: TA爱不爱我 | 3-4天 | 配偶星分析逻辑 |

---

*Last updated: 2026-01-31*
