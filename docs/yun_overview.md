# 大运快照（Dayun Snapshot）设计文档

> 版本：v4.0 | 更新日期：2026-01-28

---

## 1. 功能定义

**大运快照**：为用户提供大运整体走势的快速概览，不展开具体十神细节，只告诉用户：
- 哪些年份段运势好/一般
- 每个大运应该从事的职业五行
- 是否存在用神互换（职业方向变动窗口）

### 1.1 设计原则

**标记付费内容，后期统一裁剪**：
- 打印层用 `#PAID_START#` / `#PAID_END#` 标记付费内容
- 方便 debug 时看到完整输出
- 后期由 `router.py` 统一裁剪

---

## 2. 免费/付费范围

| 模式 | 包含内容 |
|------|----------|
| **免费** | 当前大运 + 之前2个大运（不足则显示到第一个） |
| **付费** | 当前大运之后的2个大运 |

### 边界情况

| 情况 | 处理方式 |
|------|----------|
| 当前大运之前不足2个 | 有多少显示多少 |
| 当前大运之后不足2个 | 有多少显示多少 |
| 第一个大运还没开始 | 从第一个大运开始显示 |

---

## 3. 输出格式设计

### 3.1 格式规范

每行格式：
```
大运N | {干支} | {起始年}-{结束年} | {好运/一般} | 职业五行：{五行}
```

附加标记：
- 当前大运：末尾加 ` ← 当前`
- 用神互换：职业五行后加 `（用神互换，可能出现转行、工作变动）`

### 3.2 职业五行逻辑

```python
if 触发用神互换:
    职业五行 = 互换后的五行（如 金、水）
else:
    职业五行 = 原局用神五行（如 木、火）
```

### 3.3 运势判定

```python
运势 = "好运" if dayun.zhi_good else "一般"
```

---

## 4. 用神互换逻辑

### 4.1 触发条件

核心函数：`bazi/yongshen_swap.py` 中的 `should_print_yongshen_swap_hint()`

**只对以下日主生效**：丙、丁、壬、癸

### 4.2 判定规则

| 日主 | 身强/弱 | 生扶力量 | 原局用神 | 运支类型 | → 互换后 |
|------|---------|---------|---------|----------|----------|
| 丙/丁 | 身弱(<50%) | ≥30% | 木、火 | 火运(巳/午) | → 金、水 |
| 丙/丁 | 身强(≥50%) | ≤75% | 金、水 | 水运(子/亥) | → 木、火 |
| 壬/癸 | 身弱(<50%) | ≥30% | 金、水 | 水运(子/亥) | → 木、火 |
| 壬/癸 | 身强(≥50%) | ≤75% | 木、火 | 火运(巳/午) | → 金、水 |

### 4.3 条件说明

| 条件 | 判断方式 |
|------|----------|
| 身强 | `strength_percent >= 50.0` |
| 身弱 | `strength_percent < 50.0` |
| 火运 | `dayun_zhi in ("巳", "午")` |
| 水运 | `dayun_zhi in ("子", "亥")` |

---

## 5. Regression 案例

### 5.1 案例A：2005-9-20 10:00 男（基准年2026）

**基础数据**：
- 日主：丁（火日主）
- 身强/弱：45%（身弱）
- 生扶力量：45%
- 用神五行：木、火

**当前大运判定**：2026年在大运2（2019-2028）

**大运数据**：

| 大运 | 干支 | 时间段 | zhi_good | 是否火运 | 触发互换 |
|------|------|--------|----------|----------|----------|
| 大运1 | 甲申 | 2009-2018 | False | 否(申) | 否 |
| 大运2 | 癸未 | 2019-2028 | False | 否(未) | 否 |
| 大运3 | 壬午 | 2029-2038 | True | 是(午) | 是 |
| 大运4 | 辛巳 | 2039-2048 | True | 是(巳) | 是 |

**期望输出（免费版）**：

```
—— 大运快照 ——

[过去与当前]
大运1 | 甲申 | 2009-2018 | 一般 | 职业五行：木、火
大运2 | 癸未 | 2019-2028 | 一般 | 职业五行：木、火 ← 当前
```

**期望输出（付费版）**：

```
—— 大运快照 ——

[过去与当前]
大运1 | 甲申 | 2009-2018 | 一般 | 职业五行：木、火
大运2 | 癸未 | 2019-2028 | 一般 | 职业五行：木、火 ← 当前

[未来大运]
大运3 | 壬午 | 2029-2038 | 好运 | 职业五行：金、水（用神互换，可能出现转行、工作变动）
大运4 | 辛巳 | 2039-2048 | 好运 | 职业五行：金、水（用神互换，可能出现转行、工作变动）
```

**特点**：用神互换发生在未来，免费版看不到

---

### 5.2 案例B：1998-4-29 14:00 男（基准年2026）

**基础数据**：
- 日主：丙（火日主）
- 身强/弱：40%（身弱）
- 生扶力量：40%
- 用神五行：木、火

**当前大运判定**：2026年在大运3（2020-2029）

**大运数据**：

| 大运 | 干支 | 时间段 | zhi_good | 是否火运 | 触发互换 |
|------|------|--------|----------|----------|----------|
| 大运1 | 丁巳 | 2000-2009 | True | 是(巳) | 是 |
| 大运2 | 戊午 | 2010-2019 | True | 是(午) | 是 |
| 大运3 | 己未 | 2020-2029 | False | 否(未) | 否 |
| 大运4 | 庚申 | 2030-2039 | False | 否(申) | 否 |
| 大运5 | 辛酉 | 2040-2049 | False | 否(酉) | 否 |

**期望输出（免费版）**：

```
—— 大运快照 ——

[过去与当前]
大运1 | 丁巳 | 2000-2009 | 好运 | 职业五行：金、水（用神互换，可能出现转行、工作变动）
大运2 | 戊午 | 2010-2019 | 好运 | 职业五行：金、水（用神互换，可能出现转行、工作变动）
大运3 | 己未 | 2020-2029 | 一般 | 职业五行：木、火 ← 当前
```

**期望输出（付费版）**：

```
—— 大运快照 ——

[过去与当前]
大运1 | 丁巳 | 2000-2009 | 好运 | 职业五行：金、水（用神互换，可能出现转行、工作变动）
大运2 | 戊午 | 2010-2019 | 好运 | 职业五行：金、水（用神互换，可能出现转行、工作变动）
大运3 | 己未 | 2020-2029 | 一般 | 职业五行：木、火 ← 当前

[未来大运]
大运4 | 庚申 | 2030-2039 | 一般 | 职业五行：木、火
大运5 | 辛酉 | 2040-2049 | 一般 | 职业五行：木、火
```

**特点**：用神互换发生在过去（免费区），免费用户也能看到

---

## 6. 数据来源

| 字段 | 来源 | 说明 |
|------|------|------|
| 大运列表 | `facts['luck']['groups']` | 遍历所有大运 |
| 好运/一般 | `dayun['zhi_good']` | `True`=好运, `False`=一般 |
| 当前大运 | `dayun['start_year'] <= base_year <= dayun['start_year'] + 9` | 判断当前所在大运 |
| 用神互换 | `dayun['yongshen_swap_hint']` | 有值则触发互换 |
| 互换后五行 | `dayun['yongshen_swap_hint']['target_industry']` | 如 "金、水" |
| 原局用神五行 | `facts['natal']['yongshen_elements']` | 如 ["木", "火"] |

---

## 7. 函数设计

### 7.1 函数签名

```python
# bazi/dayun_snapshot.py

def build_dayun_snapshot(facts: dict, base_year: int) -> str:
    """生成大运快照文本。

    参数:
        facts: compute_facts() 返回的完整 facts
        base_year: 基准年份（用于判断当前大运）

    返回:
        完整文本，付费内容用 #PAID_START# / #PAID_END# 标记
    """
```

### 7.2 核心逻辑

```python
def build_dayun_snapshot(facts: dict, base_year: int) -> str:
    lines = ["—— 大运快照 ——", ""]

    # 收集有效大运
    dayuns = [g['dayun'] for g in facts['luck']['groups'] if g.get('dayun')]

    # 找当前大运索引
    current_idx = _find_current_dayun_idx(dayuns, base_year)

    # 计算范围
    free_start, free_end, paid_start, paid_end = _calculate_ranges(dayuns, current_idx)

    # 生成免费区（所有用户都能看到）
    lines.append("[过去与当前]")
    for i in range(free_start, free_end):
        lines.append(_format_dayun_line(dayuns[i], facts, i == current_idx))

    # 付费区：用标记包裹
    if paid_start < paid_end:
        lines.append("#PAID_START#")
        lines.append("")
        lines.append("[未来大运]")
        for i in range(paid_start, paid_end):
            lines.append(_format_dayun_line(dayuns[i], facts, False))
        lines.append("#PAID_END#")

    return "\n".join(lines)
```

### 7.3 调用示例

```python
from bazi.dayun_snapshot import build_dayun_snapshot

# 生成完整快照（包含付费标记）
snapshot = build_dayun_snapshot(facts, 2026)

# 后期由 router.py 根据付费状态裁剪 #PAID_START# / #PAID_END# 之间的内容
```

---

## 8. 与现有模块关系

| 模块 | 关系 |
|------|------|
| `yongshen_swap.py` | 复用判断逻辑，获取 `yongshen_swap_hint` |
| `compute_facts.py` | 提供 facts 数据源 |
| `cli.py` | 可在打印层调用此函数输出快照 |
| `router.py` | 负责根据付费状态裁剪 `#PAID_*#` 标记 |

---

## 9. TODO

- [x] 设计文档完成
- [x] 实现 `bazi/dayun_snapshot.py`
- [x] 在 `cli.py` 中添加打印入口
- [ ] 添加 regression 测试（案例A + 案例B）

---

## 10. 更新记录

| 日期 | 版本 | 变更内容 |
|------|------|----------|
| 2026-01-27 | v1.0 | 初版创建 |
| 2026-01-27 | v2.0 | 重新设计输出格式，每行显示职业五行；添加两个 regression 案例 |
| 2026-01-28 | v3.0 | 从源头控制付费内容：废弃后期裁剪，改用 `is_paid` 参数直接控制生成 |
| 2026-01-28 | v4.0 | **改用标记方式**：打印层用 `#PAID_START#` / `#PAID_END#` 标记，后期统一裁剪 |
