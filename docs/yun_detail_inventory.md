# Yun Detail 识别 + 阈值总清单

> **生成日期**：2026-01-27
> **版本**：v2.0（协议化输出）

---

## 0. 新版打印格式规范（v2.0）

### 0.1 设计原则

**核心目标**：让LLM能清晰理解大运的关键信息，重点是**标签自然语言**。

**主区域保留**（给LLM看）：
1. 运势判词（好运/一般），**只看地支**决定
2. 地支十神 + 标签
3. 天干十神 + 标签
4. 婚姻宫被冲（月柱）
5. 夫妻宫被冲（日柱）
6. 天干五合婚恋提醒

**移到 DEBUG**（开发者看）：
- 六合、半合
- 三合局、三会局
- 非感情宫位的冲（祖上宫、事业家庭宫）
- 天克地冲详情
- 用神互换提示
- 转折点

### 0.2 关键规则：天干标签随地支基调

| 地支状态 | 天干标签规则 | 标记 |
|----------|--------------|------|
| 地支用神（好运） | 天干**也用好运版本标签** | `(随运好)` |
| 地支非用神（一般） | 天干用**实际用神状态**的标签 | `非用神` 或 `用神` |

**实现逻辑**：
```python
if zhi_good:  # 地支好运
    gan_label = get_shishen_label(gan_shishen, True)  # 强制用好运标签
    gan_marker = "(随运好)"
else:
    gan_label = get_shishen_label(gan_shishen, is_gan_yongshen)
    gan_marker = "用神" if is_gan_yongshen else "非用神"
```

### 0.3 协议化输出格式

```
============================================================
【大运 N】{干}{支} | {起始年}-{结束年}年 | 虚龄{起始岁}-{结束岁}岁
运势: {好运/一般}

地支 {支} | {十神} | {用神/非用神}
→ {标签自然语言}

天干 {干} | {十神} | {(随运好)/用神/非用神}
→ {标签自然语言}

- HINTS -
[感情] 婚姻宫被冲: {冲名} → {提示}
[感情] 夫妻宫被冲: {冲名} → {提示}
[感情] 天干五合: {描述} → 婚恋变化提醒

@
============================================================@@@@@@@@@@@@@@@@@@@@
```

**格式说明**：
- 开始：60个等号 + 标题行（无第二行等号）
- 结束：`@` + 60个等号 + 20个@

### 0.4 HINTS 类型清单（主区域）

| 类型 | 触发条件 | 格式 |
|------|----------|------|
| `[感情] 婚姻宫被冲` | 大运地支冲月柱（婚姻宫） | `{冲名} → 单身更易暧昧/受阻；有伴侣争执起伏` |
| `[感情] 夫妻宫被冲` | 大运地支冲日柱（夫妻宫） | `{冲名} → 单身更易暧昧/受阻；有伴侣争执起伏` |
| `[感情] 天干五合` | 大运天干与命局天干五合（涉及配偶星） | `{位置} 合 大运{干} → 婚恋变化提醒` |

**不在主区域输出**：
- 婚姻宫/夫妻宫被合（六合/半合）→ 移到 DEBUG
- 祖上宫、事业家庭宫的冲 → 移到 DEBUG

---

## 1. Entry Points & Data Flow

### 1.1 主要入口文件

| 文件 | 函数 | 职责 |
|------|------|------|
| `bazi/cli.py` | `main()` | CLI 入口，打印大运和流年 |
| `bazi/cli.py` | 3518-3785行 | 大运块打印逻辑（Header / Fact / Axis / Tip） |
| `bazi/luck.py` | `analyze_luck()` | 核心排盘 + 大运数据生成 |
| `bazi/luck.py` | 1806-1836行 | 大运字典（dayun_dict）数据结构定义 |
| `bazi/enrich.py` | `enrich_dayun()` | 为大运数据补充 hints、yongshen_swap_hint、wuhe_events |

### 1.2 Data Flow

```
用户输入 (生日)
       │
       ▼
cli.py::main() → analyze_complete()
       │
       ▼
lunar_engine.py::analyze_complete() → luck.py::analyze_luck()
       │
       ├─────────────────────────────────────────┐
       ▼                                         ▼
dayun_dict 构建                          detect_branch_clash()
(index, gan, zhi, start_year,            detect_flow_harmonies()
 start_age, gan_good, zhi_good,          detect_sanhe_complete()
 gan_element, zhi_element, ...)          detect_sanhui_complete()
       │                                         │
       └─────────────┬───────────────────────────┘
                     ▼
            enrich.py::enrich_dayun() → 生成 hints[]
                     │
                     ▼
            cli.py → 大运块打印（Header / Fact / Axis / Tip）
                     │
                     ▼
            _print_liunian_v3() → 该大运下的10个流年
```

---

## 2. 大运打印内容清单

### 2.1 Header 区

| 数据字段 | 来源 | 打印格式 |
|----------|------|----------|
| `index` | `dayun_dict["index"]` | `【大运 {index+1}】` |
| `gan` / `zhi` | `dayun_dict["gan"]` / `dayun_dict["zhi"]` | `{gan}{zhi}` |
| `start_year` | `dayun_dict["start_year"]` | `(起运年份 {start_year}` |
| `start_age` | `dayun_dict["start_age"]` | `虚龄 {start_age} 岁)` |
| `zhi_good` | `dayun_dict["zhi_good"]` | `→ {好运/一般}` |
| `gan_element` / `zhi_element` | `dayun_dict["gan_element"]` / `dayun_dict["zhi_element"]` | `[干 {element} ✓/× / 支 {element} ✓/×]` |

**Header 示例**：
```
【大运 3】 壬寅 (起运年份 2030, 虚龄 26 岁) → 好运  [干 水 × / 支 木 ✓]
```

---

### 2.2 Fact 区（事实区）

| Signal ID | 中文名 | 检测函数/来源 | 打印格式 |
|-----------|--------|---------------|----------|
| `liuhe` | 大运与命局六合 | `dayun["harmonies_natal"]` (subtype=liuhe) | `大运和{宫位}合（{甲}{乙}合）` |
| `banhe` | 大运与命局半合 | `dayun["harmonies_natal"]` (subtype=banhe) | `大运 与 {宫位} 半合（{甲}{乙}半合）` |
| `sanhe_complete` | 大运完整三合局 | `dayun["sanhe_complete"]` | `{来源1}，{来源2}，{来源3}，{干支}三合{局名}。` |
| `sanhui_complete` | 大运完整三会局 | `dayun["sanhui_complete"]` | `{来源1} {来源2} {来源3} {干支}三会{局名}局。` |
| `gan_wuhe` | 大运天干五合 | `detect_gan_wuhe()` | `{位置串} {干} 争合/双合 大运天干 {干} ...` |
| `clashes_natal` | 大运与命局冲 | `dayun["clashes_natal"]` | `命局冲（大运）：{冲信息}` |
| `tkdc_targets` | 大运天克地冲 | `clashes_natal[i]["tkdc_targets"]` | `天克地冲：大运 {干支} 与 命局{柱}（{宫位}）{干支} 天克地冲` |

**Fact 区示例**：
```
    大运和夫妻宫合（午未合）
    大运 与 婚姻宫 半合（巳酉半合）
    大运 酉，月柱（婚姻宫）酉，时柱（事业家庭宫）巳，巳酉丑三合金。
    命局冲（大运）：大运 卯 冲 月柱（婚姻宫）酉
    天克地冲：大运 己卯 与 命局月柱（婚姻宫）乙酉 天克地冲
```

---

### 2.3 Axis 区（主轴区）

| 数据字段 | 来源 | 打印格式 |
|----------|------|----------|
| 地支定调 | `dayun["zhi"]` + `get_shishen()` + `get_shishen_label()` | `地支 {支}｜十神 {十神}｜用神 {是/否}｜标签：{标签}` |
| 天干补充 | `dayun["gan"]` + `get_shishen()` + `get_shishen_label()` | `天干 {干}｜十神 {十神}｜用神 {是/否}｜标签：{标签}` |

**Axis 区示例**：
```
    大运主轴（地支定调）：
    地支 寅｜十神 正印｜用神 是｜标签：贵人/支持/学习证书
    天干补充（不翻盘）：
    天干 壬｜十神 正官｜用神 否｜标签：规章压力/束缚/被考核/开销大
```

---

### 2.4 Tip 区（提示汇总区）

| Signal ID | 中文名 | 来源 | 打印格式 |
|-----------|--------|------|----------|
| `turning_point` | 转折点 | 上一大运地支好运状态对比 | `这是大运转折点：{年份} 年：{旧状态} → {新状态}（{转弱/转好}）` |
| `yongshen_swap_hint` | 用神互换提示 | `dayun["hints"]` 中含 "【用神互换提示】" | `{完整提示}` |
| `marriage_wuhe_hint` | 婚恋变化提醒 | `dayun["hints"]` 中含 "婚恋变化提醒" | `{完整提示}` |

**Tip 区示例**：
```
    这是大运转折点：2040 年：好运 → 一般（转弱）
    【用神互换提示】原局用神：火；身弱；生扶力量=40%；运支=亥(水) → 更匹配的行业方向：木。职业路径上更可能出现调整/变动窗口。
    婚恋变化提醒（如恋爱）：大运天干引动，配偶星显现/活跃。
```

---

## 3. 流年打印但大运不打印的内容

### 3.1 Hints 类（提示信号）

| Signal ID | 中文名 | 流年打印格式 | 大运是否打印 |
|-----------|--------|--------------|--------------|
| `pattern_hurt_officer` | 伤官见官 | `[模式] 伤官见官: {文案}` | **否** |
| `pattern_pianyin_eatgod` | 枭神夺食 | `[模式] 枭神夺食: {文案}` | **否** |
| `tkdc_natal` | 流年与命局天克地冲 | `[天克地冲] {柱}/{宫}: 流年 {干支} × 命局 {干支} → {提示}` | **否**（大运有类似但格式不同） |
| `tkdc_dayun_liunian` | 运年天克地冲 | `[天克地冲] 运年: {提示}` | **否** |
| `marriage_palace_clash` | 婚姻宫/夫妻宫被冲 | `[感情] {宫}被冲: {冲名} → {提示}` | **否** |
| `career_palace_clash` | 事业家庭宫被冲 | `[变动] {宫}被冲: {冲名} → {提示}` | **否** |
| `marriage_palace_harmony` | 婚姻宫/夫妻宫被合 | `[感情] {宫}被合: {合名} → {提示}` | **否** |
| `liuyuan_gan` | 缘分（天干） | `[感情] 缘分(天干): 暧昧推进` | **否** |
| `liuyuan_zhi` | 缘分（地支） | `[感情] 缘分(地支): 易遇合适伴侣（良缘）` | **否** |
| `he_chong_coexist` | 合冲同现 | `[感情] 合冲同现: {提示}` | **否** |
| `risk_management` | 风险管理选项 | `[建议] 风险管理: {建议}` | **否** |

### 3.2 计算类（风险/判词）

| 数据 | 流年有 | 大运有 | 备注 |
|------|--------|--------|------|
| `total_risk_percent` | 是（总风险） | 否 | 大运不计算总风险 |
| `risk_from_gan` | 是（天干风险） | 否 | 大运不分天干/地支风险 |
| `risk_from_zhi` | 是（地支风险） | 否 | |
| `tkdc_risk_percent` | 是（天克地冲风险） | 否 | |
| 前期/后期判词 | 是（好运/一般/凶/变动） | 否 | 大运只有整体判词 |
| Y 值显示 | 是 | 否 | |

### 3.3 事件类

| 事件类型 | 流年有 | 大运有 | 备注 |
|----------|--------|--------|------|
| `clashes_dayun` | 是（流年与大运冲） | 否 | 大运不与自己冲 |
| `pattern` | 是（伤官见官/枭神夺食） | 否 | 大运层不检测模式 |
| `lineyun_bonus` | 是（线运加成） | 否 | |
| `sanhe_sanhui_clash_bonus` | 是（三合/三会逢冲加分） | 否 | |

---

## 4. 完整大运打印示例

以下是触发所有函数情况下，大运打印的完整样子：

### 4.1 示例1：复杂大运（触发多种事件）

```
【大运 5】 己卯 (起运年份 2050, 虚龄 46 岁) → 一般  [干 土 × / 支 木 ✓]
    大运和夫妻宫合（卯未合）
    大运 卯，月柱（婚姻宫）酉，时柱（事业家庭宫）巳，巳酉丑三合金。
    年干，月干 乙 争合 大运天干 庚（财星双合争合格局）。
    命局冲（大运）：大运 卯 冲 年柱（祖上宫）酉、月柱（婚姻宫）酉
    天克地冲：大运 己卯 与 命局月柱（婚姻宫）乙酉 天克地冲
    ——————————
    大运主轴（地支定调）：
    地支 卯｜十神 偏印｜用神 是｜标签：偏门技术/思想突破/学习研究/灵感
    天干补充（不翻盘）：
    天干 己｜十神 食神｜用神 否｜标签：贪舒服/拖延/松散
    这是大运转折点：2050 年：好运 → 一般（转弱）
    【用神互换提示】原局用神：火；身弱；生扶力量=35%；运支=卯(木) → 更匹配的行业方向：木。职业路径上更可能出现调整/变动窗口。
    婚恋变化提醒（如恋爱）：大运天干引动，配偶星显现/活跃。
    —— 该大运对应的流年 ——
    [流年块...]
```

### 4.2 示例2：简单好运大运

```
【大运 3】 壬寅 (起运年份 2030, 虚龄 26 岁) → 好运  [干 水 × / 支 木 ✓]
    大运 与 婚姻宫 半合（寅午半合）
    ——————————
    大运主轴（地支定调）：
    地支 寅｜十神 正印｜用神 是｜标签：贵人/支持/学习证书
    天干补充（不翻盘）：
    天干 壬｜十神 正官｜用神 否｜标签：规章压力/束缚/被考核/开销大
    —— 该大运对应的流年 ——
    [流年块...]
```

### 4.3 示例3：最小化打印（无事件）

```
【大运 1】 癸卯 (起运年份 2010, 虚龄 6 岁) → 好运  [干 水 × / 支 木 ✓]
    大运主轴（地支定调）：
    地支 卯｜十神 偏印｜用神 是｜标签：偏门技术/思想突破/学习研究/灵感
    天干补充（不翻盘）：
    天干 癸｜十神 七杀｜用神 否｜标签：工作压力/对抗强/紧张感/开销大
    —— 该大运对应的流年 ——
    [流年块...]
```

---

## 5. 大运 vs 流年打印结构对比

| 区块 | 大运 | 流年 |
|------|------|------|
| Header | 【大运 N】干支 (起运年份, 虚龄) → 判词 | 年份 干支 \| 虚龄 \| Y=风险 |
| 事实区 | 六合/半合/三合/三会/五合/冲/天克地冲 | 无（事实移到 DEBUG） |
| 主轴区 | 地支定调 + 天干补充（十神/用神/标签） | 前期/后期（天干块/地支块） |
| 提示区 | 转折点 + 用神互换 + 婚恋提醒 | `- HINTS -` 区（模式/天克地冲/感情/变动/建议） |
| DEBUG区 | 无 | `- DEBUG -` 区（风险计算过程） |
| 结束符 | 无 | `@` |

---

## 6. 大运 Hints 生成逻辑（enrich_dayun）

**位置**：`bazi/enrich.py:184-283`

### 6.1 用神互换提示

**触发条件**：
- 日主是丙、丁、壬、癸（火日主或水日主）
- 大运地支属于特定五行（与用神对冲）

**生成函数**：`yongshen_swap.py::should_print_yongshen_swap_hint()`

**输出格式**：
```
【用神互换提示】原局用神：{五行}；{身弱/身强}；生扶力量={xx%}；运支={地支}({五行}) → 更匹配的行业方向：{目标五行}。职业路径上更可能出现调整/变动窗口。
```

### 6.2 婚恋变化提醒

**触发条件**：
- 大运天干与原局天干形成五合
- 五合涉及配偶星（男命财星，女命官杀星）

**生成函数**：`marriage_wuhe.py::detect_marriage_wuhe_hints()`

**输出格式**：
```
婚恋变化提醒（如恋爱）：{hint_text}
```

---

## 7. 关键文件索引

| 文件 | 主要职责 |
|------|----------|
| `bazi/cli.py:3518-3785` | 大运打印逻辑（Header / Fact / Axis / Tip） |
| `bazi/cli.py:1434-1546` | 流年打印逻辑（_print_liunian_v3） |
| `bazi/luck.py:1806-1836` | 大运数据结构（dayun_dict）定义 |
| `bazi/enrich.py:184-283` | `enrich_dayun()` 大运丰富化 |
| `bazi/enrich.py:286-477` | `enrich_liunian()` 流年丰富化 |
| `bazi/yongshen_swap.py` | 用神互换提示逻辑 |
| `bazi/marriage_wuhe.py` | 天干五合婚恋提醒 |
| `bazi/gan_wuhe.py` | 天干五合检测 |
| `bazi/harmony.py` | 六合 / 三合 / 三会检测 |
| `bazi/clash.py` | 冲检测 + 天克地冲 |

---

## 9. Regression Tests（回归测试）

### 9.1 测试配置

| 项目 | 值 |
|------|-----|
| 测试文件 | `tests/regression/test_dayun_v1_golden.py` |
| Snapshot 目录 | `tests/regression/snapshots/dayun_v1/` |

### 9.2 测试用例清单

共 **6 个** 大运 regression 测试：

| # | 八字 | 大运 | 干支 | 测试场景 | 覆盖信号 |
|---|------|------|------|----------|----------|
| A4 | 2005-9-20 10:00 男 | 4 | 壬午 | 好运 + 天干随运好 | 地支用神、天干随运好标签 |
| A5 | 2005-9-20 10:00 男 | 5 | 辛巳 | 好运 + 天干随运好 | 地支用神、天干随运好标签 |
| A6 | 2005-9-20 10:00 男 | 6 | 庚辰 | 一般 + 双非用神 | 地支非用神、天干非用神标签 |
| B6 | 2006-3-22 14:00 女 | 6 | 丙戌 | 天干五合 | `[感情] 天干五合` |
| B7 | 2006-3-22 14:00 女 | 7 | 乙酉 | 婚姻宫被冲 | `[感情] 婚姻宫被冲` |
| C8 | 1969-2-7 00:00 男 | 8 | 己未 | 夫妻宫被冲 | `[感情] 夫妻宫被冲` |

### 9.3 测试用例详情

#### 用例A：2005-9-20 10:00 男

**基础信息**：
- 日主：丁火
- 用神：木、火
- 八字：乙酉 乙酉 丁未 甲午

##### dayun_A4.txt（壬午，好运）

```
============================================================
【大运 4】壬午 | 2029-2038年 | 虚龄25-34岁
运势: 好运

地支 午 | 比肩 | 用神
→ 自信独立/同辈助力/合伙资源/行动力

天干 壬 | 正官 | (随运好)
→ 认可/升迁/名誉

- HINTS -
（无）

@
============================================================@@@@@@@@@@@@@@@@@@@@
```

**覆盖点**：
- 地支午是火，用神 → 好运
- 天干壬是正官，本身非用神，但地支好运 → 输出好运版本标签 `认可/升迁/名誉`
- 标记 `(随运好)` 而非 `非用神`

##### dayun_A5.txt（辛巳，好运）

```
============================================================
【大运 5】辛巳 | 2039-2048年 | 虚龄35-44岁
运势: 好运

地支 巳 | 劫财 | 用神
→ 自信独立/同辈助力/合伙资源/行动力

天干 辛 | 偏财 | (随运好)
→ 机会钱/副业/人脉/意外之财

- HINTS -
（无）

@
============================================================@@@@@@@@@@@@@@@@@@@@
```

**覆盖点**：
- 地支巳是火，用神 → 好运
- 天干辛是偏财，本身非用神，但地支好运 → 输出好运版本标签 `机会钱/副业/人脉/意外之财`

##### dayun_A6.txt（庚辰，一般）

```
============================================================
【大运 6】庚辰 | 2049-2058年 | 虚龄45-54岁
运势: 一般

地支 辰 | 伤官 | 非用神
→ 顶撞权威/口舌/冲突/贪玩

天干 庚 | 正财 | 非用神
→ 现实压力/精神压力大/想不开

- HINTS -
（无）

@
============================================================@@@@@@@@@@@@@@@@@@@@
```

**覆盖点**：
- 地支辰是土，非用神 → 一般
- 天干庚是正财，非用神 → 输出非用神版本标签 `现实压力/精神压力大/想不开`
- 双非用神对照

---

#### 用例B：2006-3-22 14:00 女

**基础信息**：
- 日主：己土
- 用神：木、火
- 八字：丙戌 辛卯 己丑 辛未

##### dayun_B6.txt（丙戌，一般，有天干五合）

```
============================================================
【大运 6】丙戌 | 2051-2060年 | 虚龄46-55岁
运势: 一般

地支 戌 | 偏印 | 非用神
→ 多想/孤立/节奏乱/犯小人/突如其来的变故/思想压力大

天干 丙 | 七杀 | 用神
→ 领导赏识/扛事机会/突破

- HINTS -
[感情] 天干五合: 官杀星被合 → 婚恋变化提醒

@
============================================================@@@@@@@@@@@@@@@@@@@@
```

**覆盖点**：
- 天干五合触发婚恋提醒
- 女命官杀星被合
- 天干是用神但地支非用神 → 整体仍为"一般"

##### dayun_B7.txt（乙酉，一般，婚姻宫被冲）

```
============================================================
【大运 7】乙酉 | 2061-2070年 | 虚龄56-65岁
运势: 一般

地支 酉 | 劫财 | 非用神
→ 竞争争夺/冲动分心/投机或赌博破财/购置不动产化解

天干 乙 | 正财 | 用神
→ 努力得回报/方向更清晰/稳步积累(生活&工作)

- HINTS -
[感情] 婚姻宫被冲: 酉卯冲 → 单身更易暧昧/受阻；有伴侣争执起伏

@
============================================================@@@@@@@@@@@@@@@@@@@@
```

**覆盖点**：
- 大运酉冲命局月柱卯（婚姻宫）
- 输出 `[感情] 婚姻宫被冲` 提示

---

#### 用例C：1969-2-7 00:00 男

**基础信息**：
- 日主：癸水
- 用神：金、水
- 八字：戊申 乙丑 癸丑 壬子

##### dayun_C8.txt（己未，一般，夫妻宫被冲）

```
============================================================
【大运 8】己未 | 2029-2038年 | 虚龄61-70岁
运势: 一般

地支 未 | 七杀 | 非用神
→ 工作压力/对抗强/紧张感/开销大

天干 己 | 七杀 | 非用神
→ 工作压力/对抗强/紧张感/开销大

- HINTS -
[感情] 夫妻宫被冲: 未丑冲 → 单身更易暧昧/受阻；有伴侣争执起伏

@
============================================================@@@@@@@@@@@@@@@@@@@@
```

**覆盖点**：
- 大运未冲命局日柱丑（夫妻宫）
- 输出 `[感情] 夫妻宫被冲` 提示
- 天干地支都是七杀非用神

---

### 9.4 测试覆盖矩阵

| 场景 | A4 | A5 | A6 | B6 | B7 | C8 |
|------|----|----|----|----|----|----|
| 地支用神（好运） | ✓ | ✓ | | | | |
| 地支非用神（一般） | | | ✓ | ✓ | ✓ | ✓ |
| 天干随运好标签 | ✓ | ✓ | | | | |
| 天干用神标签 | | | | ✓ | ✓ | |
| 天干非用神标签 | | | ✓ | | | ✓ |
| 天干五合 | | | | ✓ | | |
| 婚姻宫被冲 | | | | | ✓ | |
| 夫妻宫被冲 | | | | | | ✓ |

### 9.5 运行测试

```bash
# 运行全部大运 regression 测试
python -m pytest tests/regression/test_dayun_v1_golden.py -v

# 运行单个用例测试
python -m pytest tests/regression/test_dayun_v1_golden.py::TestDayunV1Golden::test_dayun_A4 -v
```

---

## 10. 更新记录

| 日期 | 版本 | 变更内容 |
|------|------|----------|
| 2026-01-27 | v2.4 | **结尾符升级**：@后60等号+20个@ |
| 2026-01-27 | v2.3 | **分隔符升级**：60个等号，删除标题下第二行等号，@后加60等号结尾 |
| 2026-01-27 | v2.2 | **Regression 校准**：修正 B6(丙戌)、B7(乙酉)、C8(己未) 的干支和十神，与实际 CLI 输出对齐 |
| 2026-01-27 | v2.1 | **Header格式升级**：年份+虚龄改为范围格式（如 `2029-2038年 \| 虚龄25-34岁`） |
| 2026-01-27 | v2.0 | **协议化输出**：新增 v2.0 打印格式规范；天干随运好规则；HINTS 只保留感情冲+五合；新增 6 个 regression 测试用例 |
| 2026-01-26 | v1.0 | 初版创建：大运打印内容清单、与流年对比、完整示例 |

