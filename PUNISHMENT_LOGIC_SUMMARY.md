# 刑的逻辑总结

## 1. 刑的类型

### 普通刑（NORMAL_PUNISH_PAIRS）
- 子卯、卯子
- 寅巳、巳寅
- 巳申、申巳
- 申寅、寅申
- 风险：5%

### 墓库刑（GRAVE_PUNISH_PAIRS）
- 丑戌、戌丑
- 戌未、未戌
- 未丑、丑未
- 风险：6%
- 注意：辰未不刑（不在列表中）

### 自刑（SELF_PUNISH_PAIRS）
- 辰辰、午午、酉酉、亥亥
- 风险：5%

## 2. 流年/大运刑检测（detect_branch_punishments）

逻辑：
1. 根据流年地支，找到所有可能被刑的目标地支
2. 在命局中查找这些目标地支出现的所有柱
3. 为每个被刑的柱生成一个独立的刑事件
4. 每个事件的风险是固定的（不按柱数倍增）

## 3. 原局刑检测（detect_natal_clashes_and_punishments）

逻辑：
1. 遍历所有柱对 (pillar1, pillar2)，其中 pillar1 < pillar2
2. 检查 (zhi1, zhi2) 是否在 ALL_PUNISH_PAIRS 中
3. 如果既冲又刑，只算冲，跳过刑
4. 对于自刑，使用 self_punish_processed 集合去重，确保每个自刑地支只检测一次
5. 生成刑事件

## 4. 自刑去重逻辑

对于自刑（如酉酉），使用 self_punish_processed 集合：
- 如果 zhi1 已经在集合中，跳过
- 否则，将 zhi1 和 zhi2 都加入集合
- 这样确保同一个地支的自刑只检测一次

## 5. 当前问题

例A实际计算的八字：
- 年柱：酉
- 月柱：酉
- 日柱：申（Unicode U+7533）
- 时柱：巳（Unicode U+5DF3）

检测到的刑：
1. 年-月：酉酉自刑，5%
2. 日-时：申巳刑（普通刑），5%
总计：10%

但用户期望：
- 例A原局应该只有1个酉酉自刑，5%
- 这意味着期望的八字应该是：年柱酉、月柱酉、日柱未、时柱未（或时柱是未）
